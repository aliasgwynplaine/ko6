<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ko6: src/soft/hal/soc/almo1-mips/soc.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo55.png"/></td>
  <td id="projectalign">
   <div id="projectname">ko6
   </div>
   <div id="projectbrief">ko6 (prononce it &#39;kit-O-sys&#39; O is  the letter not the number) is a small operating system for educationnal purpose</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_8785740846211ac34fd04c61a1fdd888.html">soft</a></li><li class="navelem"><a class="el" href="dir_4bc59b718064dd09f06e1584b4cdcbcb.html">hal</a></li><li class="navelem"><a class="el" href="dir_9910862a29a586bc938751b75c13c970.html">soc</a></li><li class="navelem"><a class="el" href="dir_0ae07aac1acf003a94b0a60fc71320a0.html">almo1-mips</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">soc.c File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="soclib-tty_8h_source.html">hal/devices/chardev/soclib-tty.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="soclib-timer_8h_source.html">hal/devices/timer/soclib-timer.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="icu_2soclib-icu_8h_source.html">hal/devices/icu/soclib-icu.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="soclib-dma_8h_source.html">hal/devices/dma/soclib-dma.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="cpu_2irq_8h_source.html">hal/cpu/irq.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="kthread_8h_source.html">kernel/kthread.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="klibc_8h_source.html">kernel/klibc.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="kirq_8h_source.html">kernel/kirq.h</a>&gt;</code><br />
<code>#include &lt;<a class="el" href="libfdt_8h_source.html">external/libfdt/libfdt.h</a>&gt;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a8f32c2785fa3edd070abdaa34c96f6a7"><td class="memItemLeft" align="right" valign="top">static unsigned&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address</a> (void *fdt, int offset)</td></tr>
<tr class="memdesc:a8f32c2785fa3edd070abdaa34c96f6a7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the base address of a FDT device node (reg property) TODO: take in account the cells attribute of a node.  <br /></td></tr>
<tr class="separator:a8f32c2785fa3edd070abdaa34c96f6a7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7bd21ef4af7971db5dad06231290d8d1"><td class="memItemLeft" align="right" valign="top">static unsigned&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="almo1-mips_2soc_8c.html#a7bd21ef4af7971db5dad06231290d8d1">get_irq</a> (void *fdt, int offset)</td></tr>
<tr class="memdesc:a7bd21ef4af7971db5dad06231290d8d1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the IRQ of a FDT device node (interrupts property) TODO: handle multiple IRQs per node.  <br /></td></tr>
<tr class="separator:a7bd21ef4af7971db5dad06231290d8d1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4c268c213e6a62adfab96031629fa015"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="almo1-mips_2soc_8c.html#a4c268c213e6a62adfab96031629fa015">soc_icu_init</a> (void *fdt)</td></tr>
<tr class="memdesc:a4c268c213e6a62adfab96031629fa015"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize ICUs described by the device tree See the soc_tty_init function for a detailed explanation.  <br /></td></tr>
<tr class="separator:a4c268c213e6a62adfab96031629fa015"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a05f9476d07e118d280add6f5e3de365b"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="almo1-mips_2soc_8c.html#a05f9476d07e118d280add6f5e3de365b">soc_tty_init</a> (void *fdt)</td></tr>
<tr class="memdesc:a05f9476d07e118d280add6f5e3de365b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the TTYs present on the SOC based on the device-tree content Basically, every device initialization follow the same process: We loop on each device compatible with our drivers for this platform, by exemple soclib,tty For each device, we find it's base address in the reg property of the device tree node and its IRQ in the interrupts property. Once we've fetched this data, we allocate a new device (see hal/dev.h) and register it in the device list. We then setup the device with a device-specific function declared by the HAL (ex: tty_init) Last thing we do is unmask the interrupt in the ICU and register the ISR for the device.  <br /></td></tr>
<tr class="separator:a05f9476d07e118d280add6f5e3de365b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb589179b71725cd918f71b4f23b21d2"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="almo1-mips_2soc_8c.html#aeb589179b71725cd918f71b4f23b21d2">soc_timer_init</a> (void *fdt, unsigned tick)</td></tr>
<tr class="memdesc:aeb589179b71725cd918f71b4f23b21d2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize timers described by the device tree See the soc_tty_init function for a detailed explanation.  <br /></td></tr>
<tr class="separator:aeb589179b71725cd918f71b4f23b21d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5fb66f75ca9173a1a6dd99fc4be6706b"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="almo1-mips_2soc_8c.html#a5fb66f75ca9173a1a6dd99fc4be6706b">soc_dma_init</a> (void *fdt)</td></tr>
<tr class="memdesc:a5fb66f75ca9173a1a6dd99fc4be6706b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize dmas described by the device tree See the soc_tty_init function for a detailed explanation.  <br /></td></tr>
<tr class="separator:a5fb66f75ca9173a1a6dd99fc4be6706b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a436517497969d33b08925565d4cca572"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="almo1-mips_2soc_8c.html#a436517497969d33b08925565d4cca572">soc_init</a> (void *fdt, int tick)</td></tr>
<tr class="memdesc:a436517497969d33b08925565d4cca572"><td class="mdescLeft">&#160;</td><td class="mdescRight">For the SoC almo1, IRQ n'x (that is ICU.PIN[x]) is wired to the Interrup Signal of device n'y.  <br /></td></tr>
<tr class="separator:a436517497969d33b08925565d4cca572"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af2c90b7651cda327df23f561f6c6ebfd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="almo1-mips_2soc_8c.html#af2c90b7651cda327df23f561f6c6ebfd">isrcall</a> ()</td></tr>
<tr class="memdesc:af2c90b7651cda327df23f561f6c6ebfd"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function calls the ISR of the highest priority IRQ It is called by the irq_handler routine when a CPU is interrupted by an IRQ Its aims is to find out which IRQ is now active to know which device needs the CPU. and to launch the right ISR of the right device instance by using IRQVector tables. TODO: maybe this should also be a "standard" function, declared in a HAL file.  <br /></td></tr>
<tr class="separator:af2c90b7651cda327df23f561f6c6ebfd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a8f32c2785fa3edd070abdaa34c96f6a7" name="a8f32c2785fa3edd070abdaa34c96f6a7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8f32c2785fa3edd070abdaa34c96f6a7">&#9670;&#160;</a></span>get_base_address()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static unsigned get_base_address </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>fdt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>offset</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Get the base address of a FDT device node (reg property) TODO: take in account the cells attribute of a node. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fdt</td><td>address of the FDT in memory </td></tr>
    <tr><td class="paramname">offset</td><td>offset of the node in the FDT </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the address contained by the reg property </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   35</span>{</div>
<div class="line"><span class="lineno">   36</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="libfdt__env_8h.html#a6485ea7225a1927cc5ab1a34dabe298f">fdt32_to_cpu</a>(</div>
<div class="line"><span class="lineno">   37</span>        *(<span class="keywordtype">unsigned</span> *) <a class="code hl_function" href="fdt__ro_8c.html#a91753b1de7cad190da416780f4fbebc0">fdt_getprop</a>(fdt, offset, <span class="stringliteral">&quot;reg&quot;</span>, <a class="code hl_define" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div>
<div class="line"><span class="lineno">   38</span>}</div>
<div class="ttc" id="afdt__ro_8c_html_a91753b1de7cad190da416780f4fbebc0"><div class="ttname"><a href="fdt__ro_8c.html#a91753b1de7cad190da416780f4fbebc0">fdt_getprop</a></div><div class="ttdeci">const void * fdt_getprop(const void *fdt, int nodeoffset, const char *name, int *lenp)</div><div class="ttdef"><b>Definition:</b> fdt_ro.c:502</div></div>
<div class="ttc" id="akfs_8c_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> kfs.c:24</div></div>
<div class="ttc" id="alibfdt__env_8h_html_a6485ea7225a1927cc5ab1a34dabe298f"><div class="ttname"><a href="libfdt__env_8h.html#a6485ea7225a1927cc5ab1a34dabe298f">fdt32_to_cpu</a></div><div class="ttdeci">static uint32_t fdt32_to_cpu(fdt32_t x)</div><div class="ttdef"><b>Definition:</b> libfdt_env.h:63</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="libfdt__env_8h.html#a6485ea7225a1927cc5ab1a34dabe298f">fdt32_to_cpu()</a>, <a class="el" href="fdt__ro_8c.html#a91753b1de7cad190da416780f4fbebc0">fdt_getprop()</a>, and <a class="el" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>.</p>

<p class="reference">Referenced by <a class="el" href="almo1-mips_2soc_8c.html#a5fb66f75ca9173a1a6dd99fc4be6706b">soc_dma_init()</a>, <a class="el" href="almo1-mips_2soc_8c.html#a4c268c213e6a62adfab96031629fa015">soc_icu_init()</a>, <a class="el" href="almo1-mips_2soc_8c.html#aeb589179b71725cd918f71b4f23b21d2">soc_timer_init()</a>, and <a class="el" href="almo1-mips_2soc_8c.html#a05f9476d07e118d280add6f5e3de365b">soc_tty_init()</a>.</p>

</div>
</div>
<a id="a7bd21ef4af7971db5dad06231290d8d1" name="a7bd21ef4af7971db5dad06231290d8d1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7bd21ef4af7971db5dad06231290d8d1">&#9670;&#160;</a></span>get_irq()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static unsigned get_irq </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>fdt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>offset</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Get the IRQ of a FDT device node (interrupts property) TODO: handle multiple IRQs per node. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fdt</td><td>address of the FDT in memory </td></tr>
    <tr><td class="paramname">offset</td><td>offset of the node in the FDT </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the IRQ contained by the interrupts property </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   48</span>{</div>
<div class="line"><span class="lineno">   49</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="libfdt__env_8h.html#a6485ea7225a1927cc5ab1a34dabe298f">fdt32_to_cpu</a>(</div>
<div class="line"><span class="lineno">   50</span>        *(<span class="keywordtype">unsigned</span> *) <a class="code hl_function" href="fdt__ro_8c.html#a91753b1de7cad190da416780f4fbebc0">fdt_getprop</a>(fdt, offset, <span class="stringliteral">&quot;interrupts&quot;</span>, <a class="code hl_define" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));</div>
<div class="line"><span class="lineno">   51</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="libfdt__env_8h.html#a6485ea7225a1927cc5ab1a34dabe298f">fdt32_to_cpu()</a>, <a class="el" href="fdt__ro_8c.html#a91753b1de7cad190da416780f4fbebc0">fdt_getprop()</a>, and <a class="el" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>.</p>

<p class="reference">Referenced by <a class="el" href="almo1-mips_2soc_8c.html#aeb589179b71725cd918f71b4f23b21d2">soc_timer_init()</a>, and <a class="el" href="almo1-mips_2soc_8c.html#a05f9476d07e118d280add6f5e3de365b">soc_tty_init()</a>.</p>

</div>
</div>
<a id="af2c90b7651cda327df23f561f6c6ebfd" name="af2c90b7651cda327df23f561f6c6ebfd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af2c90b7651cda327df23f561f6c6ebfd">&#9670;&#160;</a></span>isrcall()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void isrcall </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function calls the ISR of the highest priority IRQ It is called by the irq_handler routine when a CPU is interrupted by an IRQ Its aims is to find out which IRQ is now active to know which device needs the CPU. and to launch the right ISR of the right device instance by using IRQVector tables. TODO: maybe this should also be a "standard" function, declared in a HAL file. </p>
<div class="fragment"><div class="line"><span class="lineno">  223</span>{</div>
<div class="line"><span class="lineno">  224</span>    <span class="keyword">struct </span><a class="code hl_struct" href="structicu__s.html">icu_s</a> *icu = <a class="code hl_define" href="icu_8h.html#a8ea2773b171799420c4542ff4e3bac3c">icu_get</a>(<a class="code hl_function" href="cpuregs_8h.html#a5c7c978ab352f02680b961d2b9f5a9c5">cpuid</a>());           <span class="comment">// get the ICU which has dev.no == cpuid()</span></div>
<div class="line"><span class="lineno">  225</span>    <span class="keywordtype">int</span> irq = icu-&gt;<a class="code hl_variable" href="structicu__s.html#a7f989a94a922fa1c782cfcf7547bd8c5">ops</a>-&gt;<a class="code hl_variable" href="structicu__ops__s.html#a8ba25afec99e838cc10924ece84be50e">icu_get_highest</a>(icu);       <span class="comment">// IRQ nb with the highest prio</span></div>
<div class="line"><span class="lineno">  226</span>    <a class="code hl_function" href="kirq_8c.html#aa9ad3c6e921343d32bd93189e56344ac">route_interrupt</a>(irq);                           <span class="comment">// launch the ISR for the bound device</span></div>
<div class="line"><span class="lineno">  227</span>}</div>
<div class="ttc" id="acpuregs_8h_html_a5c7c978ab352f02680b961d2b9f5a9c5"><div class="ttname"><a href="cpuregs_8h.html#a5c7c978ab352f02680b961d2b9f5a9c5">cpuid</a></div><div class="ttdeci">unsigned cpuid(void)</div><div class="ttdoc">cpu identifier</div></div>
<div class="ttc" id="aicu_8h_html_a8ea2773b171799420c4542ff4e3bac3c"><div class="ttname"><a href="icu_8h.html#a8ea2773b171799420c4542ff4e3bac3c">icu_get</a></div><div class="ttdeci">#define icu_get(no)</div><div class="ttdef"><b>Definition:</b> icu.h:73</div></div>
<div class="ttc" id="akirq_8c_html_aa9ad3c6e921343d32bd93189e56344ac"><div class="ttname"><a href="kirq_8c.html#aa9ad3c6e921343d32bd93189e56344ac">route_interrupt</a></div><div class="ttdeci">void route_interrupt(unsigned irq)</div><div class="ttdoc">Call the ISR of a given IRQ.</div><div class="ttdef"><b>Definition:</b> kirq.c:23</div></div>
<div class="ttc" id="astructicu__ops__s_html_a8ba25afec99e838cc10924ece84be50e"><div class="ttname"><a href="structicu__ops__s.html#a8ba25afec99e838cc10924ece84be50e">icu_ops_s::icu_get_highest</a></div><div class="ttdeci">unsigned(* icu_get_highest)(struct icu_s *icu)</div><div class="ttdoc">Generic function that fetch the highest priority IRQ from the ICU device.</div><div class="ttdef"><b>Definition:</b> icu.h:35</div></div>
<div class="ttc" id="astructicu__s_html"><div class="ttname"><a href="structicu__s.html">icu_s</a></div><div class="ttdoc">ICU driver informations.</div><div class="ttdef"><b>Definition:</b> icu.h:68</div></div>
<div class="ttc" id="astructicu__s_html_a7f989a94a922fa1c782cfcf7547bd8c5"><div class="ttname"><a href="structicu__s.html#a7f989a94a922fa1c782cfcf7547bd8c5">icu_s::ops</a></div><div class="ttdeci">struct icu_ops_s * ops</div><div class="ttdef"><b>Definition:</b> icu.h:70</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="cpuregs_8h.html#a5c7c978ab352f02680b961d2b9f5a9c5">cpuid()</a>, <a class="el" href="icu_8h.html#a8ea2773b171799420c4542ff4e3bac3c">icu_get</a>, <a class="el" href="structicu__ops__s.html#a8ba25afec99e838cc10924ece84be50e">icu_ops_s::icu_get_highest</a>, <a class="el" href="structicu__s.html#a7f989a94a922fa1c782cfcf7547bd8c5">icu_s::ops</a>, and <a class="el" href="kirq_8c.html#aa9ad3c6e921343d32bd93189e56344ac">route_interrupt()</a>.</p>

</div>
</div>
<a id="a5fb66f75ca9173a1a6dd99fc4be6706b" name="a5fb66f75ca9173a1a6dd99fc4be6706b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5fb66f75ca9173a1a6dd99fc4be6706b">&#9670;&#160;</a></span>soc_dma_init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void soc_dma_init </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>fdt</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize dmas described by the device tree See the soc_tty_init function for a detailed explanation. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fdt</td><td>fdt address </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>nothing </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  159</span>{</div>
<div class="line"><span class="lineno">  160</span>    <span class="comment">// TODO: handle DMA interrupts</span></div>
<div class="line"><span class="lineno">  161</span>    <span class="keywordtype">int</span> dma_off = <a class="code hl_function" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a>(fdt, -1, <span class="stringliteral">&quot;soclib,dma&quot;</span>);</div>
<div class="line"><span class="lineno">  162</span>    <span class="keywordflow">while</span> (dma_off != -<a class="code hl_define" href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a>) {</div>
<div class="line"><span class="lineno">  163</span>        <span class="keywordtype">unsigned</span> addr = <a class="code hl_function" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address</a>(fdt, dma_off);</div>
<div class="line"><span class="lineno">  164</span> </div>
<div class="line"><span class="lineno">  165</span>        <span class="keyword">struct </span><a class="code hl_struct" href="structdma__s.html">dma_s</a> *dma = <a class="code hl_define" href="dma_8h.html#af17023464eb4ace08274aa4adfdeb042">dma_alloc</a>();</div>
<div class="line"><span class="lineno">  166</span>        <a class="code hl_variable" href="soclib-dma_8c.html#a80351df0b0525153b84f567f1d5c77d1">SoclibDMAOps</a>.<a class="code hl_variable" href="structdma__ops__s.html#a1049676b76bf18cbe7f5dd4509ce1bc3">dma_init</a>(dma, addr);</div>
<div class="line"><span class="lineno">  167</span> </div>
<div class="line"><span class="lineno">  168</span>        dma_off = <a class="code hl_function" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a>(fdt, dma_off, <span class="stringliteral">&quot;soclib,dma&quot;</span>);</div>
<div class="line"><span class="lineno">  169</span>    }</div>
<div class="line"><span class="lineno">  170</span>}</div>
<div class="ttc" id="aalmo1-mips_2soc_8c_html_a8f32c2785fa3edd070abdaa34c96f6a7"><div class="ttname"><a href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address</a></div><div class="ttdeci">static unsigned get_base_address(void *fdt, int offset)</div><div class="ttdoc">Get the base address of a FDT device node (reg property) TODO: take in account the cells attribute of...</div><div class="ttdef"><b>Definition:</b> soc.c:34</div></div>
<div class="ttc" id="adma_8h_html_af17023464eb4ace08274aa4adfdeb042"><div class="ttname"><a href="dma_8h.html#af17023464eb4ace08274aa4adfdeb042">dma_alloc</a></div><div class="ttdeci">#define dma_alloc()</div><div class="ttdef"><b>Definition:</b> dma.h:48</div></div>
<div class="ttc" id="afdt__ro_8c_html_a7fee20e876e2af4dd32e987c6c8f104a"><div class="ttname"><a href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a></div><div class="ttdeci">int fdt_node_offset_by_compatible(const void *fdt, int startoffset, const char *compatible)</div><div class="ttdef"><b>Definition:</b> fdt_ro.c:853</div></div>
<div class="ttc" id="alibfdt_8h_html_a93cfa052f4b28df4bfc7d336b692fa07"><div class="ttname"><a href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a></div><div class="ttdeci">#define FDT_ERR_NOTFOUND</div><div class="ttdef"><b>Definition:</b> libfdt.h:21</div></div>
<div class="ttc" id="asoclib-dma_8c_html_a80351df0b0525153b84f567f1d5c77d1"><div class="ttname"><a href="soclib-dma_8c.html#a80351df0b0525153b84f567f1d5c77d1">SoclibDMAOps</a></div><div class="ttdeci">struct dma_ops_s SoclibDMAOps</div><div class="ttdef"><b>Definition:</b> soclib-dma.c:47</div></div>
<div class="ttc" id="astructdma__ops__s_html_a1049676b76bf18cbe7f5dd4509ce1bc3"><div class="ttname"><a href="structdma__ops__s.html#a1049676b76bf18cbe7f5dd4509ce1bc3">dma_ops_s::dma_init</a></div><div class="ttdeci">void(* dma_init)(struct dma_s *dma, unsigned address)</div><div class="ttdoc">Generic function that initialize a DMA device.</div><div class="ttdef"><b>Definition:</b> dma.h:29</div></div>
<div class="ttc" id="astructdma__s_html"><div class="ttname"><a href="structdma__s.html">dma_s</a></div><div class="ttdoc">DMA device specific information.</div><div class="ttdef"><b>Definition:</b> dma.h:44</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="dma_8h.html#af17023464eb4ace08274aa4adfdeb042">dma_alloc</a>, <a class="el" href="structdma__ops__s.html#a1049676b76bf18cbe7f5dd4509ce1bc3">dma_ops_s::dma_init</a>, <a class="el" href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a>, <a class="el" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible()</a>, <a class="el" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address()</a>, and <a class="el" href="soclib-dma_8c.html#a80351df0b0525153b84f567f1d5c77d1">SoclibDMAOps</a>.</p>

<p class="reference">Referenced by <a class="el" href="almo1-mips_2soc_8c.html#a436517497969d33b08925565d4cca572">soc_init()</a>.</p>

</div>
</div>
<a id="a4c268c213e6a62adfab96031629fa015" name="a4c268c213e6a62adfab96031629fa015"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4c268c213e6a62adfab96031629fa015">&#9670;&#160;</a></span>soc_icu_init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void soc_icu_init </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>fdt</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize ICUs described by the device tree See the soc_tty_init function for a detailed explanation. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fdt</td><td>fdt address </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>nothing </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   60</span>{</div>
<div class="line"><span class="lineno">   61</span>    <span class="keywordtype">int</span> icu_off = <a class="code hl_function" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a>(fdt, -1, <span class="stringliteral">&quot;soclib,icu&quot;</span>);</div>
<div class="line"><span class="lineno">   62</span>    <span class="keywordflow">while</span> (icu_off != -<a class="code hl_define" href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a>) {</div>
<div class="line"><span class="lineno">   63</span>        <span class="keywordtype">unsigned</span> addr = <a class="code hl_function" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address</a>(fdt, icu_off);</div>
<div class="line"><span class="lineno">   64</span> </div>
<div class="line"><span class="lineno">   65</span>        <span class="keyword">struct </span><a class="code hl_struct" href="structicu__s.html">icu_s</a> *icu = <a class="code hl_define" href="icu_8h.html#a288933830f60a333ea46fd2252b8120e">icu_alloc</a>();</div>
<div class="line"><span class="lineno">   66</span>        <a class="code hl_variable" href="icu_2soclib-icu_8c.html#a57148fb85883dc5ca0480a7b55398c58">SoclibICUOps</a>.<a class="code hl_variable" href="structicu__ops__s.html#ae4520a9c760003bfb3d637749a9728ad">icu_init</a>(icu, addr);</div>
<div class="line"><span class="lineno">   67</span> </div>
<div class="line"><span class="lineno">   68</span>        icu_off = <a class="code hl_function" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a>(fdt, icu_off, <span class="stringliteral">&quot;soclib,icu&quot;</span>);</div>
<div class="line"><span class="lineno">   69</span>    }</div>
<div class="line"><span class="lineno">   70</span>}</div>
<div class="ttc" id="aicu_2soclib-icu_8c_html_a57148fb85883dc5ca0480a7b55398c58"><div class="ttname"><a href="icu_2soclib-icu_8c.html#a57148fb85883dc5ca0480a7b55398c58">SoclibICUOps</a></div><div class="ttdeci">struct icu_ops_s SoclibICUOps</div><div class="ttdef"><b>Definition:</b> soclib-icu.c:70</div></div>
<div class="ttc" id="aicu_8h_html_a288933830f60a333ea46fd2252b8120e"><div class="ttname"><a href="icu_8h.html#a288933830f60a333ea46fd2252b8120e">icu_alloc</a></div><div class="ttdeci">#define icu_alloc()</div><div class="ttdef"><b>Definition:</b> icu.h:72</div></div>
<div class="ttc" id="astructicu__ops__s_html_ae4520a9c760003bfb3d637749a9728ad"><div class="ttname"><a href="structicu__ops__s.html#ae4520a9c760003bfb3d637749a9728ad">icu_ops_s::icu_init</a></div><div class="ttdeci">void(* icu_init)(struct icu_s *icu, unsigned address)</div><div class="ttdoc">Generic function to initialize the ICU device.</div><div class="ttdef"><b>Definition:</b> icu.h:28</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a>, <a class="el" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible()</a>, <a class="el" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address()</a>, <a class="el" href="icu_8h.html#a288933830f60a333ea46fd2252b8120e">icu_alloc</a>, <a class="el" href="structicu__ops__s.html#ae4520a9c760003bfb3d637749a9728ad">icu_ops_s::icu_init</a>, and <a class="el" href="icu_2soclib-icu_8c.html#a57148fb85883dc5ca0480a7b55398c58">SoclibICUOps</a>.</p>

<p class="reference">Referenced by <a class="el" href="almo1-mips_2soc_8c.html#a436517497969d33b08925565d4cca572">soc_init()</a>.</p>

</div>
</div>
<a id="a436517497969d33b08925565d4cca572" name="a436517497969d33b08925565d4cca572"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a436517497969d33b08925565d4cca572">&#9670;&#160;</a></span>soc_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int soc_init </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>fdt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>tick</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>For the SoC almo1, IRQ n'x (that is ICU.PIN[x]) is wired to the Interrup Signal of device n'y. </p>
<p>Request the initialization of all the architecture of the SOC This function configures each used devices and configures which IRQ are used and how they are connected to the CPU thanks to the ICU Mask.</p>
<p>There are at most 14 IRQs for almo1, but the real number depends of the prototype paramaters There are as many timers as CPU, thus NCPUS timers There are Nicus ttys There are also a DMA to perfom memcpy and optionnal Block Device (hard drive)</p>
<p>Device IRQs are wired as following:</p><ul>
<li>ICU.PIN [0] : timer 0 "     " "        depending on NCPUS (0 to 7)
* ICU.PIN [7]  : timer 7
* ICU.PIN [8]  : bd          Bloc Device (Hard Drive)
* ICU.PIN [9]  : dma         Direct Memory Access (Hard memcpy)
* ICU.PIN [10] : TTY0        TTY n'0
     " "      " depending on NTTYS (0 to 3)</li>
<li>ICU.PIN [13] : TTY3 <dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tick</td><td>number of ticks between two timer interrupts </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>-1 if the initialization failed, 0 if it succeeded </dd></dl>
</li>
</ul>
<div class="fragment"><div class="line"><span class="lineno">  193</span>{</div>
<div class="line"><span class="lineno">  194</span>    <span class="keywordflow">if</span> (<a class="code hl_define" href="libfdt_8h.html#a783c67f6971d10232c84ecd0aa76f461">fdt_magic</a>(fdt) != 0xd00dfeed)</div>
<div class="line"><span class="lineno">  195</span>        <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  196</span> </div>
<div class="line"><span class="lineno">  197</span>    <span class="comment">// We MUST initialize the ICU first since every other device</span></div>
<div class="line"><span class="lineno">  198</span>    <span class="comment">// initialization will rely on it for its interrupts</span></div>
<div class="line"><span class="lineno">  199</span>    <a class="code hl_function" href="almo1-mips_2soc_8c.html#a4c268c213e6a62adfab96031629fa015">soc_icu_init</a>(fdt);</div>
<div class="line"><span class="lineno">  200</span> </div>
<div class="line"><span class="lineno">  201</span>    <span class="comment">// Initialize TTY early so we can debug as soon as possible</span></div>
<div class="line"><span class="lineno">  202</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="almo1-mips_2soc_8c.html#a05f9476d07e118d280add6f5e3de365b">soc_tty_init</a>(fdt) &lt; 0)</div>
<div class="line"><span class="lineno">  203</span>        <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  204</span> </div>
<div class="line"><span class="lineno">  205</span>    <a class="code hl_function" href="almo1-mips_2soc_8c.html#a5fb66f75ca9173a1a6dd99fc4be6706b">soc_dma_init</a>(fdt);</div>
<div class="line"><span class="lineno">  206</span> </div>
<div class="line"><span class="lineno">  207</span>    <span class="comment">// Finish by the timer (we don&#39;t want to schedule anything until everything</span></div>
<div class="line"><span class="lineno">  208</span>    <span class="comment">// is initialized)</span></div>
<div class="line"><span class="lineno">  209</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="almo1-mips_2soc_8c.html#aeb589179b71725cd918f71b4f23b21d2">soc_timer_init</a>(fdt, tick) &lt; 0)</div>
<div class="line"><span class="lineno">  210</span>        <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  211</span> </div>
<div class="line"><span class="lineno">  212</span>    <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  213</span>}</div>
<div class="ttc" id="aalmo1-mips_2soc_8c_html_a05f9476d07e118d280add6f5e3de365b"><div class="ttname"><a href="almo1-mips_2soc_8c.html#a05f9476d07e118d280add6f5e3de365b">soc_tty_init</a></div><div class="ttdeci">static int soc_tty_init(void *fdt)</div><div class="ttdoc">Initialize the TTYs present on the SOC based on the device-tree content Basically,...</div><div class="ttdef"><b>Definition:</b> soc.c:85</div></div>
<div class="ttc" id="aalmo1-mips_2soc_8c_html_a4c268c213e6a62adfab96031629fa015"><div class="ttname"><a href="almo1-mips_2soc_8c.html#a4c268c213e6a62adfab96031629fa015">soc_icu_init</a></div><div class="ttdeci">static void soc_icu_init(void *fdt)</div><div class="ttdoc">Initialize ICUs described by the device tree See the soc_tty_init function for a detailed explanation...</div><div class="ttdef"><b>Definition:</b> soc.c:59</div></div>
<div class="ttc" id="aalmo1-mips_2soc_8c_html_a5fb66f75ca9173a1a6dd99fc4be6706b"><div class="ttname"><a href="almo1-mips_2soc_8c.html#a5fb66f75ca9173a1a6dd99fc4be6706b">soc_dma_init</a></div><div class="ttdeci">static void soc_dma_init(void *fdt)</div><div class="ttdoc">Initialize dmas described by the device tree See the soc_tty_init function for a detailed explanation...</div><div class="ttdef"><b>Definition:</b> soc.c:158</div></div>
<div class="ttc" id="aalmo1-mips_2soc_8c_html_aeb589179b71725cd918f71b4f23b21d2"><div class="ttname"><a href="almo1-mips_2soc_8c.html#aeb589179b71725cd918f71b4f23b21d2">soc_timer_init</a></div><div class="ttdeci">static int soc_timer_init(void *fdt, unsigned tick)</div><div class="ttdoc">Initialize timers described by the device tree See the soc_tty_init function for a detailed explanati...</div><div class="ttdef"><b>Definition:</b> soc.c:125</div></div>
<div class="ttc" id="alibfdt_8h_html_a783c67f6971d10232c84ecd0aa76f461"><div class="ttname"><a href="libfdt_8h.html#a783c67f6971d10232c84ecd0aa76f461">fdt_magic</a></div><div class="ttdeci">#define fdt_magic(fdt)</div><div class="ttdef"><b>Definition:</b> libfdt.h:249</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="libfdt_8h.html#a783c67f6971d10232c84ecd0aa76f461">fdt_magic</a>, <a class="el" href="almo1-mips_2soc_8c.html#a5fb66f75ca9173a1a6dd99fc4be6706b">soc_dma_init()</a>, <a class="el" href="almo1-mips_2soc_8c.html#a4c268c213e6a62adfab96031629fa015">soc_icu_init()</a>, <a class="el" href="almo1-mips_2soc_8c.html#aeb589179b71725cd918f71b4f23b21d2">soc_timer_init()</a>, and <a class="el" href="almo1-mips_2soc_8c.html#a05f9476d07e118d280add6f5e3de365b">soc_tty_init()</a>.</p>

<p class="reference">Referenced by <a class="el" href="kinit_8c.html#a7316311400d5b710f1b974a353b10d1c">kinit()</a>.</p>

</div>
</div>
<a id="aeb589179b71725cd918f71b4f23b21d2" name="aeb589179b71725cd918f71b4f23b21d2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeb589179b71725cd918f71b4f23b21d2">&#9670;&#160;</a></span>soc_timer_init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int soc_timer_init </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>fdt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>tick</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize timers described by the device tree See the soc_tty_init function for a detailed explanation. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fdt</td><td>fdt address </td></tr>
    <tr><td class="paramname">tick</td><td>number of ticks between two timer interrupts </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>-1 if the initialization failed, 0 if it succeeded </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  126</span>{</div>
<div class="line"><span class="lineno">  127</span>    <span class="comment">// Fetch the ICU device</span></div>
<div class="line"><span class="lineno">  128</span>    <span class="keyword">struct </span><a class="code hl_struct" href="structicu__s.html">icu_s</a> *icu = <a class="code hl_define" href="icu_8h.html#a8ea2773b171799420c4542ff4e3bac3c">icu_get</a>(0);</div>
<div class="line"><span class="lineno">  129</span>    <span class="keywordflow">if</span> (!icu)</div>
<div class="line"><span class="lineno">  130</span>        <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  131</span> </div>
<div class="line"><span class="lineno">  132</span>    <span class="keywordtype">int</span> timer_off = <a class="code hl_function" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a>(fdt, -1, <span class="stringliteral">&quot;soclib,timer&quot;</span>);</div>
<div class="line"><span class="lineno">  133</span> </div>
<div class="line"><span class="lineno">  134</span>    <span class="keywordflow">while</span> (timer_off != -<a class="code hl_define" href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a>) {</div>
<div class="line"><span class="lineno">  135</span>        <span class="keywordtype">unsigned</span> addr = <a class="code hl_function" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address</a>(fdt, timer_off);</div>
<div class="line"><span class="lineno">  136</span>        <span class="keywordtype">unsigned</span> irq = <a class="code hl_function" href="almo1-mips_2soc_8c.html#a7bd21ef4af7971db5dad06231290d8d1">get_irq</a>(fdt, timer_off);</div>
<div class="line"><span class="lineno">  137</span> </div>
<div class="line"><span class="lineno">  138</span>        <span class="keyword">struct </span><a class="code hl_struct" href="structtimer__s.html">timer_s</a> *timer = <a class="code hl_define" href="timer_8h.html#a9b16e7c947532969c0eb7525c66405f6">timer_alloc</a>();</div>
<div class="line"><span class="lineno">  139</span>        <a class="code hl_variable" href="soclib-timer_8c.html#aa3f96a0578c32ac8fd0d3b2526182084">SoclibTimerOps</a>.<a class="code hl_variable" href="structtimer__ops__s.html#aa76b59bd593efb90d8c19502cb131804">timer_init</a>(timer, addr, tick);</div>
<div class="line"><span class="lineno">  140</span>        timer-&gt;<a class="code hl_variable" href="structtimer__s.html#a859db5220e0605eabaa9100121940b5e">ops</a>-&gt;<a class="code hl_variable" href="structtimer__ops__s.html#a8f992643132e6e8631e0b6b675c7804d">timer_set_event</a>(timer,</div>
<div class="line"><span class="lineno">  141</span>            (<span class="keywordtype">void</span> (*)(<span class="keywordtype">void</span> *)) <a class="code hl_function" href="kthread_8c.html#affe2eebf6749bc36765d45ff48c926b1">thread_yield</a>, (<span class="keywordtype">void</span> *) 0);</div>
<div class="line"><span class="lineno">  142</span> </div>
<div class="line"><span class="lineno">  143</span>        icu-&gt;<a class="code hl_variable" href="structicu__s.html#a7f989a94a922fa1c782cfcf7547bd8c5">ops</a>-&gt;<a class="code hl_variable" href="structicu__ops__s.html#ab1794a0a36578c1ec9d43ed33d5ffc53">icu_unmask</a>(icu, irq);</div>
<div class="line"><span class="lineno">  144</span>        <a class="code hl_function" href="kirq_8c.html#a7bb6fb99500c6f10708c7653cef722e8">register_interrupt</a>(irq, (<a class="code hl_typedef" href="kirq_8h.html#a958bc0434ee14c3c524e64e50b0860c6">isr_t</a>) <a class="code hl_function" href="soclib-timer_8c.html#ad4d0316e8dbbe5427118ba5a8a03f12d">soclib_timer_isr</a>, timer);</div>
<div class="line"><span class="lineno">  145</span> </div>
<div class="line"><span class="lineno">  146</span>        timer_off = <a class="code hl_function" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a>(fdt, timer_off, <span class="stringliteral">&quot;soclib,timer&quot;</span>);</div>
<div class="line"><span class="lineno">  147</span>    }</div>
<div class="line"><span class="lineno">  148</span> </div>
<div class="line"><span class="lineno">  149</span>    <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  150</span>}</div>
<div class="ttc" id="aalmo1-mips_2soc_8c_html_a7bd21ef4af7971db5dad06231290d8d1"><div class="ttname"><a href="almo1-mips_2soc_8c.html#a7bd21ef4af7971db5dad06231290d8d1">get_irq</a></div><div class="ttdeci">static unsigned get_irq(void *fdt, int offset)</div><div class="ttdoc">Get the IRQ of a FDT device node (interrupts property) TODO: handle multiple IRQs per node.</div><div class="ttdef"><b>Definition:</b> soc.c:47</div></div>
<div class="ttc" id="akirq_8c_html_a7bb6fb99500c6f10708c7653cef722e8"><div class="ttname"><a href="kirq_8c.html#a7bb6fb99500c6f10708c7653cef722e8">register_interrupt</a></div><div class="ttdeci">void register_interrupt(unsigned irq, isr_t handler, void *arg)</div><div class="ttdoc">Assign an ISR (Interrupt-Service Routine) to an IRQ.</div><div class="ttdef"><b>Definition:</b> kirq.c:17</div></div>
<div class="ttc" id="akirq_8h_html_a958bc0434ee14c3c524e64e50b0860c6"><div class="ttname"><a href="kirq_8h.html#a958bc0434ee14c3c524e64e50b0860c6">isr_t</a></div><div class="ttdeci">void(* isr_t)(unsigned, void *)</div><div class="ttdef"><b>Definition:</b> kirq.h:55</div></div>
<div class="ttc" id="akthread_8c_html_affe2eebf6749bc36765d45ff48c926b1"><div class="ttname"><a href="kthread_8c.html#affe2eebf6749bc36765d45ff48c926b1">thread_yield</a></div><div class="ttdeci">int thread_yield(void)</div><div class="ttdoc">Causes the current thread to give up the CPU in order to give it to another.</div><div class="ttdef"><b>Definition:</b> kthread.c:317</div></div>
<div class="ttc" id="asoclib-timer_8c_html_aa3f96a0578c32ac8fd0d3b2526182084"><div class="ttname"><a href="soclib-timer_8c.html#aa3f96a0578c32ac8fd0d3b2526182084">SoclibTimerOps</a></div><div class="ttdeci">struct timer_ops_s SoclibTimerOps</div><div class="ttdef"><b>Definition:</b> soclib-timer.c:62</div></div>
<div class="ttc" id="asoclib-timer_8c_html_ad4d0316e8dbbe5427118ba5a8a03f12d"><div class="ttname"><a href="soclib-timer_8c.html#ad4d0316e8dbbe5427118ba5a8a03f12d">soclib_timer_isr</a></div><div class="ttdeci">void soclib_timer_isr(unsigned irq, struct timer_s *timer)</div><div class="ttdoc">ISR of the soclib timer device.</div><div class="ttdef"><b>Definition:</b> soclib-timer.c:68</div></div>
<div class="ttc" id="astructicu__ops__s_html_ab1794a0a36578c1ec9d43ed33d5ffc53"><div class="ttname"><a href="structicu__ops__s.html#ab1794a0a36578c1ec9d43ed33d5ffc53">icu_ops_s::icu_unmask</a></div><div class="ttdeci">void(* icu_unmask)(struct icu_s *icu, unsigned irq)</div><div class="ttdoc">Generic function that unmask (enable) an IRQ.</div><div class="ttdef"><b>Definition:</b> icu.h:64</div></div>
<div class="ttc" id="astructtimer__ops__s_html_a8f992643132e6e8631e0b6b675c7804d"><div class="ttname"><a href="structtimer__ops__s.html#a8f992643132e6e8631e0b6b675c7804d">timer_ops_s::timer_set_event</a></div><div class="ttdeci">void(* timer_set_event)(struct timer_s *timer, void(*f)(void *arg), void *arg)</div><div class="ttdoc">Generic function that sets the event that will be triggered after a timer interrupt.</div><div class="ttdef"><b>Definition:</b> timer.h:46</div></div>
<div class="ttc" id="astructtimer__ops__s_html_aa76b59bd593efb90d8c19502cb131804"><div class="ttname"><a href="structtimer__ops__s.html#aa76b59bd593efb90d8c19502cb131804">timer_ops_s::timer_init</a></div><div class="ttdeci">void(* timer_init)(struct timer_s *timer, unsigned address, unsigned tick)</div><div class="ttdoc">Generic function to initialize the timer device.</div><div class="ttdef"><b>Definition:</b> timer.h:29</div></div>
<div class="ttc" id="astructtimer__s_html"><div class="ttname"><a href="structtimer__s.html">timer_s</a></div><div class="ttdoc">Timer driver informations.</div><div class="ttdef"><b>Definition:</b> timer.h:56</div></div>
<div class="ttc" id="astructtimer__s_html_a859db5220e0605eabaa9100121940b5e"><div class="ttname"><a href="structtimer__s.html#a859db5220e0605eabaa9100121940b5e">timer_s::ops</a></div><div class="ttdeci">struct timer_ops_s * ops</div><div class="ttdef"><b>Definition:</b> timer.h:60</div></div>
<div class="ttc" id="atimer_8h_html_a9b16e7c947532969c0eb7525c66405f6"><div class="ttname"><a href="timer_8h.html#a9b16e7c947532969c0eb7525c66405f6">timer_alloc</a></div><div class="ttdeci">#define timer_alloc()</div><div class="ttdef"><b>Definition:</b> timer.h:62</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a>, <a class="el" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible()</a>, <a class="el" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address()</a>, <a class="el" href="almo1-mips_2soc_8c.html#a7bd21ef4af7971db5dad06231290d8d1">get_irq()</a>, <a class="el" href="icu_8h.html#a8ea2773b171799420c4542ff4e3bac3c">icu_get</a>, <a class="el" href="structicu__ops__s.html#ab1794a0a36578c1ec9d43ed33d5ffc53">icu_ops_s::icu_unmask</a>, <a class="el" href="structicu__s.html#a7f989a94a922fa1c782cfcf7547bd8c5">icu_s::ops</a>, <a class="el" href="structtimer__s.html#a859db5220e0605eabaa9100121940b5e">timer_s::ops</a>, <a class="el" href="kirq_8c.html#a7bb6fb99500c6f10708c7653cef722e8">register_interrupt()</a>, <a class="el" href="soclib-timer_8c.html#ad4d0316e8dbbe5427118ba5a8a03f12d">soclib_timer_isr()</a>, <a class="el" href="soclib-timer_8c.html#aa3f96a0578c32ac8fd0d3b2526182084">SoclibTimerOps</a>, <a class="el" href="kthread_8c.html#affe2eebf6749bc36765d45ff48c926b1">thread_yield()</a>, <a class="el" href="timer_8h.html#a9b16e7c947532969c0eb7525c66405f6">timer_alloc</a>, <a class="el" href="structtimer__ops__s.html#aa76b59bd593efb90d8c19502cb131804">timer_ops_s::timer_init</a>, and <a class="el" href="structtimer__ops__s.html#a8f992643132e6e8631e0b6b675c7804d">timer_ops_s::timer_set_event</a>.</p>

<p class="reference">Referenced by <a class="el" href="almo1-mips_2soc_8c.html#a436517497969d33b08925565d4cca572">soc_init()</a>.</p>

</div>
</div>
<a id="a05f9476d07e118d280add6f5e3de365b" name="a05f9476d07e118d280add6f5e3de365b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a05f9476d07e118d280add6f5e3de365b">&#9670;&#160;</a></span>soc_tty_init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int soc_tty_init </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>fdt</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize the TTYs present on the SOC based on the device-tree content Basically, every device initialization follow the same process: We loop on each device compatible with our drivers for this platform, by exemple soclib,tty For each device, we find it's base address in the reg property of the device tree node and its IRQ in the interrupts property. Once we've fetched this data, we allocate a new device (see hal/dev.h) and register it in the device list. We then setup the device with a device-specific function declared by the HAL (ex: tty_init) Last thing we do is unmask the interrupt in the ICU and register the ISR for the device. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fdt</td><td>fdt address </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>-1 if the initialization failed, 0 if it succeeded </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   86</span>{</div>
<div class="line"><span class="lineno">   87</span>    <span class="comment">// Fetch the ICU device</span></div>
<div class="line"><span class="lineno">   88</span>    <span class="keyword">struct </span><a class="code hl_struct" href="structicu__s.html">icu_s</a> *icu = <a class="code hl_define" href="icu_8h.html#a8ea2773b171799420c4542ff4e3bac3c">icu_get</a>(0);</div>
<div class="line"><span class="lineno">   89</span>    <span class="comment">// Check that the ICU has already been initialized</span></div>
<div class="line"><span class="lineno">   90</span>    <span class="keywordflow">if</span> (!icu)</div>
<div class="line"><span class="lineno">   91</span>        <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">   92</span> </div>
<div class="line"><span class="lineno">   93</span>    <span class="comment">// Find the first TTY device</span></div>
<div class="line"><span class="lineno">   94</span>    <span class="keywordtype">int</span> tty_off = <a class="code hl_function" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a>(fdt, -1, <span class="stringliteral">&quot;soclib,tty&quot;</span>);</div>
<div class="line"><span class="lineno">   95</span> </div>
<div class="line"><span class="lineno">   96</span>    <span class="comment">// Loop until we can&#39;t find any more compatible ttys in the device tree</span></div>
<div class="line"><span class="lineno">   97</span>    <span class="keywordflow">while</span> (tty_off != -<a class="code hl_define" href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a>) {</div>
<div class="line"><span class="lineno">   98</span>        <span class="comment">// Fetch the necessary properties from the device tree</span></div>
<div class="line"><span class="lineno">   99</span>        <span class="keywordtype">unsigned</span> addr = <a class="code hl_function" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address</a>(fdt, tty_off);</div>
<div class="line"><span class="lineno">  100</span>        <span class="keywordtype">unsigned</span> irq = <a class="code hl_function" href="almo1-mips_2soc_8c.html#a7bd21ef4af7971db5dad06231290d8d1">get_irq</a>(fdt, tty_off);</div>
<div class="line"><span class="lineno">  101</span> </div>
<div class="line"><span class="lineno">  102</span>        <span class="comment">// Allocate the structure and add it in the global device list</span></div>
<div class="line"><span class="lineno">  103</span>        <span class="keyword">struct </span><a class="code hl_struct" href="structchardev__s.html">chardev_s</a> *tty = <a class="code hl_define" href="chardev_8h.html#a0f9abac4f27deb18dd30410b33ba7e72">chardev_alloc</a>();</div>
<div class="line"><span class="lineno">  104</span>        <span class="comment">// Initialize the device</span></div>
<div class="line"><span class="lineno">  105</span>        <a class="code hl_variable" href="soclib-tty_8c.html#ac60ea3e14652d47e0814fac85c18b2ff">SoclibTTYOps</a>.<a class="code hl_variable" href="structchardev__ops__s.html#af50dd5197c195d368892fddcc0d2d0c6">chardev_init</a>(tty, addr, 0);</div>
<div class="line"><span class="lineno">  106</span>        <span class="comment">// Unmask the interrupt</span></div>
<div class="line"><span class="lineno">  107</span>        icu-&gt;<a class="code hl_variable" href="structicu__s.html#a7f989a94a922fa1c782cfcf7547bd8c5">ops</a>-&gt;<a class="code hl_variable" href="structicu__ops__s.html#ab1794a0a36578c1ec9d43ed33d5ffc53">icu_unmask</a>(icu, irq);</div>
<div class="line"><span class="lineno">  108</span>        <span class="comment">// Register the corresponding ISR</span></div>
<div class="line"><span class="lineno">  109</span>        <a class="code hl_function" href="kirq_8c.html#a7bb6fb99500c6f10708c7653cef722e8">register_interrupt</a>(irq, (<a class="code hl_typedef" href="kirq_8h.html#a958bc0434ee14c3c524e64e50b0860c6">isr_t</a>) <a class="code hl_function" href="soclib-tty_8c.html#abee08020bafa1f698839a8d477dcdafa">soclib_tty_isr</a>, tty);</div>
<div class="line"><span class="lineno">  110</span> </div>
<div class="line"><span class="lineno">  111</span>        <span class="comment">// Find the next compatible tty</span></div>
<div class="line"><span class="lineno">  112</span>        tty_off = <a class="code hl_function" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible</a>(fdt, tty_off, <span class="stringliteral">&quot;soclib,tty&quot;</span>);</div>
<div class="line"><span class="lineno">  113</span>    }</div>
<div class="line"><span class="lineno">  114</span> </div>
<div class="line"><span class="lineno">  115</span>    <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno">  116</span>}</div>
<div class="ttc" id="achardev_8h_html_a0f9abac4f27deb18dd30410b33ba7e72"><div class="ttname"><a href="chardev_8h.html#a0f9abac4f27deb18dd30410b33ba7e72">chardev_alloc</a></div><div class="ttdeci">#define chardev_alloc()</div><div class="ttdef"><b>Definition:</b> chardev.h:64</div></div>
<div class="ttc" id="asoclib-tty_8c_html_abee08020bafa1f698839a8d477dcdafa"><div class="ttname"><a href="soclib-tty_8c.html#abee08020bafa1f698839a8d477dcdafa">soclib_tty_isr</a></div><div class="ttdeci">void soclib_tty_isr(unsigned irq, struct chardev_s *cdev)</div><div class="ttdoc">ISR for the soclib tty device The only interrupt handled is the one raised when a character is receiv...</div><div class="ttdef"><b>Definition:</b> soclib-tty.c:85</div></div>
<div class="ttc" id="asoclib-tty_8c_html_ac60ea3e14652d47e0814fac85c18b2ff"><div class="ttname"><a href="soclib-tty_8c.html#ac60ea3e14652d47e0814fac85c18b2ff">SoclibTTYOps</a></div><div class="ttdeci">struct chardev_ops_s SoclibTTYOps</div><div class="ttdef"><b>Definition:</b> soclib-tty.c:79</div></div>
<div class="ttc" id="astructchardev__ops__s_html_af50dd5197c195d368892fddcc0d2d0c6"><div class="ttname"><a href="structchardev__ops__s.html#af50dd5197c195d368892fddcc0d2d0c6">chardev_ops_s::chardev_init</a></div><div class="ttdeci">void(* chardev_init)(struct chardev_s *chardev, unsigned address, unsigned baudrate)</div><div class="ttdoc">Generic function that initialize the chardev device.</div><div class="ttdef"><b>Definition:</b> chardev.h:35</div></div>
<div class="ttc" id="astructchardev__s_html"><div class="ttname"><a href="structchardev__s.html">chardev_s</a></div><div class="ttdoc">Character device informations.</div><div class="ttdef"><b>Definition:</b> chardev.h:57</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="chardev_8h.html#a0f9abac4f27deb18dd30410b33ba7e72">chardev_alloc</a>, <a class="el" href="structchardev__ops__s.html#af50dd5197c195d368892fddcc0d2d0c6">chardev_ops_s::chardev_init</a>, <a class="el" href="libfdt_8h.html#a93cfa052f4b28df4bfc7d336b692fa07">FDT_ERR_NOTFOUND</a>, <a class="el" href="fdt__ro_8c.html#a7fee20e876e2af4dd32e987c6c8f104a">fdt_node_offset_by_compatible()</a>, <a class="el" href="almo1-mips_2soc_8c.html#a8f32c2785fa3edd070abdaa34c96f6a7">get_base_address()</a>, <a class="el" href="almo1-mips_2soc_8c.html#a7bd21ef4af7971db5dad06231290d8d1">get_irq()</a>, <a class="el" href="icu_8h.html#a8ea2773b171799420c4542ff4e3bac3c">icu_get</a>, <a class="el" href="structicu__ops__s.html#ab1794a0a36578c1ec9d43ed33d5ffc53">icu_ops_s::icu_unmask</a>, <a class="el" href="structicu__s.html#a7f989a94a922fa1c782cfcf7547bd8c5">icu_s::ops</a>, <a class="el" href="kirq_8c.html#a7bb6fb99500c6f10708c7653cef722e8">register_interrupt()</a>, <a class="el" href="soclib-tty_8c.html#abee08020bafa1f698839a8d477dcdafa">soclib_tty_isr()</a>, and <a class="el" href="soclib-tty_8c.html#ac60ea3e14652d47e0814fac85c18b2ff">SoclibTTYOps</a>.</p>

<p class="reference">Referenced by <a class="el" href="almo1-mips_2soc_8c.html#a436517497969d33b08925565d4cca572">soc_init()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
