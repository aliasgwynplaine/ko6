\hypertarget{qemu-virt-riscv_2soc_8c}{\section{/users/enseig/franck/ko6/src/soft/hal/soc/qemu-\/virt-\/riscv/soc.c File Reference}
\label{qemu-virt-riscv_2soc_8c}\index{/users/enseig/franck/ko6/src/soft/hal/soc/qemu-\/virt-\/riscv/soc.\-c@{/users/enseig/franck/ko6/src/soft/hal/soc/qemu-\/virt-\/riscv/soc.\-c}}
}
{\ttfamily \#include $<$hal/devices/timer/clint-\/timer.\-h$>$}\\*
{\ttfamily \#include $<$hal/devices/chardev/ns16550.\-h$>$}\\*
{\ttfamily \#include $<$hal/devices/icu/plic.\-h$>$}\\*
{\ttfamily \#include $<$kernel/kthread.\-h$>$}\\*
{\ttfamily \#include $<$kernel/klibc.\-h$>$}\\*
{\ttfamily \#include $<$kernel/kirq.\-h$>$}\\*
{\ttfamily \#include $<$hal/cpu/irq.\-h$>$}\\*
{\ttfamily \#include $<$external/libfdt/libfdt.\-h$>$}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static unsigned \hyperlink{qemu-virt-riscv_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\-\_\-base\-\_\-address} (void $\ast$fdt, int offset)
\begin{DoxyCompactList}\small\item\em Get the base address of a F\-D\-T device node (reg property) T\-O\-D\-O\-: take in account the cells attribute of a node. \end{DoxyCompactList}\item 
static unsigned \hyperlink{qemu-virt-riscv_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}{get\-\_\-irq} (void $\ast$fdt, int offset)
\begin{DoxyCompactList}\small\item\em Get the I\-R\-Q of a F\-D\-T device node (interrupts property) T\-O\-D\-O\-: handle multiple I\-R\-Qs per node. \end{DoxyCompactList}\item 
static void \hyperlink{qemu-virt-riscv_2soc_8c_a4c268c213e6a62adfab96031629fa015}{soc\-\_\-icu\-\_\-init} (void $\ast$fdt)
\begin{DoxyCompactList}\small\item\em Initialize I\-C\-Us described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. \end{DoxyCompactList}\item 
static int \hyperlink{qemu-virt-riscv_2soc_8c_a05f9476d07e118d280add6f5e3de365b}{soc\-\_\-tty\-\_\-init} (void $\ast$fdt)
\begin{DoxyCompactList}\small\item\em Initialize the T\-T\-Ys present on the S\-O\-C based on the device-\/tree content Basically, every device initialization follow the same process\-: We loop on each device compatible with our drivers for this platform, by exemple soclib,tty For each device, we find it's base address in the reg property of the device tree node and its I\-R\-Q in the interrupts property. Once we've fetched this data, we allocate a new device (see hal/dev.\-h) and register it in the device list. We then setup the device with a device-\/specific function declared by the H\-A\-L (ex\-: tty\-\_\-init) Last thing we do is unmask the interrupt in the I\-C\-U and register the I\-S\-R for the device. \end{DoxyCompactList}\item 
static int \hyperlink{qemu-virt-riscv_2soc_8c_aeb589179b71725cd918f71b4f23b21d2}{soc\-\_\-timer\-\_\-init} (void $\ast$fdt, unsigned tick)
\begin{DoxyCompactList}\small\item\em Initialize timers described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. \end{DoxyCompactList}\item 
int \hyperlink{qemu-virt-riscv_2soc_8c_a436517497969d33b08925565d4cca572}{soc\-\_\-init} (void $\ast$fdt, int tick)
\begin{DoxyCompactList}\small\item\em Q\-E\-M\-U virt platform initialization. \end{DoxyCompactList}\item 
void \hyperlink{qemu-virt-riscv_2soc_8c_a382aa89b664822b3d90560b5e211c0fd}{isrcall} (\hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} mcause)
\begin{DoxyCompactList}\small\item\em This function calls the I\-S\-R of the highest priority I\-R\-Q It is called by the irq\-\_\-handler routine when a C\-P\-U is interrupted by an I\-R\-Q Its aims is to find out which I\-R\-Q is now active to know which device needs the C\-P\-U. and to launch the right I\-S\-R of the right device instance by using I\-R\-Q\-Vector tables. T\-O\-D\-O\-: maybe this should also be a \char`\"{}standard\char`\"{} function, declared in a H\-A\-L file. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{qemu-virt-riscv_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{\index{qemu-\/virt-\/riscv/soc.\-c@{qemu-\/virt-\/riscv/soc.\-c}!get\-\_\-base\-\_\-address@{get\-\_\-base\-\_\-address}}
\index{get\-\_\-base\-\_\-address@{get\-\_\-base\-\_\-address}!qemu-virt-riscv/soc.c@{qemu-\/virt-\/riscv/soc.\-c}}
\subsubsection[{get\-\_\-base\-\_\-address}]{\setlength{\rightskip}{0pt plus 5cm}static unsigned get\-\_\-base\-\_\-address (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{int}]{offset}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{qemu-virt-riscv_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}


Get the base address of a F\-D\-T device node (reg property) T\-O\-D\-O\-: take in account the cells attribute of a node. 


\begin{DoxyParams}{Parameters}
{\em fdt} & address of the F\-D\-T in memory \\
\hline
{\em offset} & offset of the node in the F\-D\-T \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
the address contained by the reg property 
\end{DoxyReturn}


References fdt32\-\_\-to\-\_\-cpu(), fdt\-\_\-getprop(), and N\-U\-L\-L.



Referenced by soc\-\_\-icu\-\_\-init(), soc\-\_\-timer\-\_\-init(), and soc\-\_\-tty\-\_\-init().


\begin{DoxyCode}
33 \{
34     \textcolor{comment}{/* We fetch the second element since address-cells = 2 */}
35     \textcolor{keywordflow}{return} \hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(
36         ((\textcolor{keywordtype}{unsigned} *) \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdt, offset, \textcolor{stringliteral}{"reg"}, \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}))[1]);
37 \}
\end{DoxyCode}
\hypertarget{qemu-virt-riscv_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}{\index{qemu-\/virt-\/riscv/soc.\-c@{qemu-\/virt-\/riscv/soc.\-c}!get\-\_\-irq@{get\-\_\-irq}}
\index{get\-\_\-irq@{get\-\_\-irq}!qemu-virt-riscv/soc.c@{qemu-\/virt-\/riscv/soc.\-c}}
\subsubsection[{get\-\_\-irq}]{\setlength{\rightskip}{0pt plus 5cm}static unsigned get\-\_\-irq (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{int}]{offset}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{qemu-virt-riscv_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}


Get the I\-R\-Q of a F\-D\-T device node (interrupts property) T\-O\-D\-O\-: handle multiple I\-R\-Qs per node. 


\begin{DoxyParams}{Parameters}
{\em fdt} & address of the F\-D\-T in memory \\
\hline
{\em offset} & offset of the node in the F\-D\-T \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
the I\-R\-Q contained by the interrupts property 
\end{DoxyReturn}


References fdt32\-\_\-to\-\_\-cpu(), fdt\-\_\-getprop(), and N\-U\-L\-L.



Referenced by soc\-\_\-tty\-\_\-init().


\begin{DoxyCode}
47 \{
48     \textcolor{keywordflow}{return} \hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(
49         *(\textcolor{keywordtype}{unsigned} *) \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdt, offset, \textcolor{stringliteral}{"interrupts"}, \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
50 \}
\end{DoxyCode}
\hypertarget{qemu-virt-riscv_2soc_8c_a382aa89b664822b3d90560b5e211c0fd}{\index{qemu-\/virt-\/riscv/soc.\-c@{qemu-\/virt-\/riscv/soc.\-c}!isrcall@{isrcall}}
\index{isrcall@{isrcall}!qemu-virt-riscv/soc.c@{qemu-\/virt-\/riscv/soc.\-c}}
\subsubsection[{isrcall}]{\setlength{\rightskip}{0pt plus 5cm}void isrcall (
\begin{DoxyParamCaption}
\item[{{\bf uint32\-\_\-t}}]{mcause}
\end{DoxyParamCaption}
)}}\label{qemu-virt-riscv_2soc_8c_a382aa89b664822b3d90560b5e211c0fd}


This function calls the I\-S\-R of the highest priority I\-R\-Q It is called by the irq\-\_\-handler routine when a C\-P\-U is interrupted by an I\-R\-Q Its aims is to find out which I\-R\-Q is now active to know which device needs the C\-P\-U. and to launch the right I\-S\-R of the right device instance by using I\-R\-Q\-Vector tables. T\-O\-D\-O\-: maybe this should also be a \char`\"{}standard\char`\"{} function, declared in a H\-A\-L file. 



References clint\-\_\-timer\-\_\-isr(), cpuid, icu\-\_\-ops\-\_\-s\-::icu\-\_\-acknowledge, icu\-\_\-get, icu\-\_\-ops\-\_\-s\-::icu\-\_\-get\-\_\-highest, icu\-\_\-s\-::ops, route\-\_\-interrupt(), and timer\-\_\-get.


\begin{DoxyCode}
185 \{
186     \textcolor{comment}{// Check if this a timer or an external interrupt}
187     mcause &= ~(1 << 31);
188     \textcolor{keywordflow}{if} (mcause == 7) \{
189         \textcolor{comment}{// Machine Timer interrupt}
190         \textcolor{keyword}{struct }\hyperlink{structtimer__s}{timer\_s} *timer = \hyperlink{timer_8h_a37d45c7613c7ecf90613462e6c117940}{timer\_get}(0); \textcolor{comment}{// TODO: see if we should use cpuid() here
       instead of 0}
191         \hyperlink{clint-timer_8c_ac4e214b8457c4aa41856f050aa3144e5}{clint\_timer\_isr}(0, timer);
192     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (mcause == 11) \{
193         \textcolor{comment}{// Machine external interrupt}
194         \textcolor{keyword}{struct }\hyperlink{structicu__s}{icu\_s} *icu = \hyperlink{icu_8h_a8ea2773b171799420c4542ff4e3bac3c}{icu\_get}(\hyperlink{mips_2cpuregs_8S_a78a056c2e0d1097b3c4d7e569b8cdc0a}{cpuid}());           \textcolor{comment}{// get the ICU which has dev.no ==
       cpuid()}
195         \textcolor{keywordtype}{int} irq = icu->\hyperlink{structicu__s_a7f989a94a922fa1c782cfcf7547bd8c5}{ops}->\hyperlink{structicu__ops__s_a7aa5d37f9a8ef9f3e59211ff5ab213c0}{icu\_get\_highest}(icu);       \textcolor{comment}{// IRQ nb with the highest prio}
196         \hyperlink{kirq_8c_aa9ad3c6e921343d32bd93189e56344ac}{route\_interrupt}(irq);                           \textcolor{comment}{// launch the ISR for the bound
       device}
197         icu->\hyperlink{structicu__s_a7f989a94a922fa1c782cfcf7547bd8c5}{ops}->\hyperlink{structicu__ops__s_aec94869f891ee17f4743f46da01dcced}{icu\_acknowledge}(icu, irq);
198     \}
199 \}
\end{DoxyCode}
\hypertarget{qemu-virt-riscv_2soc_8c_a4c268c213e6a62adfab96031629fa015}{\index{qemu-\/virt-\/riscv/soc.\-c@{qemu-\/virt-\/riscv/soc.\-c}!soc\-\_\-icu\-\_\-init@{soc\-\_\-icu\-\_\-init}}
\index{soc\-\_\-icu\-\_\-init@{soc\-\_\-icu\-\_\-init}!qemu-virt-riscv/soc.c@{qemu-\/virt-\/riscv/soc.\-c}}
\subsubsection[{soc\-\_\-icu\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static void soc\-\_\-icu\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{qemu-virt-riscv_2soc_8c_a4c268c213e6a62adfab96031629fa015}


Initialize I\-C\-Us described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. 


\begin{DoxyParams}{Parameters}
{\em fdt} & fdt address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
nothing 
\end{DoxyReturn}


References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-node\-\_\-offset\-\_\-by\-\_\-compatible(), get\-\_\-base\-\_\-address(), icu\-\_\-alloc, icu\-\_\-ops\-\_\-s\-::icu\-\_\-init, and Plic\-Ops.



Referenced by soc\-\_\-init().


\begin{DoxyCode}
59 \{
60     \textcolor{keywordtype}{int} icu\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, -1, \textcolor{stringliteral}{"riscv,plic0"});
61     \textcolor{keywordflow}{while} (icu\_off != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND}) \{
62         \textcolor{keywordtype}{unsigned} addr = \hyperlink{qemu-virt-riscv_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\_base\_address}(fdt, icu\_off);
63 
64         \textcolor{keyword}{struct }\hyperlink{structicu__s}{icu\_s} *icu = \hyperlink{icu_8h_a288933830f60a333ea46fd2252b8120e}{icu\_alloc}();
65         \hyperlink{icu_2plic_8c_a0daeb7589a4979ebe7c0ff070de2fafe}{PlicOps}.\hyperlink{structicu__ops__s_acfb85f348f0664db040ecc73ebbd5cc7}{icu\_init}(icu, addr);
66 
67         icu\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, icu\_off, \textcolor{stringliteral}{"riscv,plic0"});
68     \}
69 \}
\end{DoxyCode}
\hypertarget{qemu-virt-riscv_2soc_8c_a436517497969d33b08925565d4cca572}{\index{qemu-\/virt-\/riscv/soc.\-c@{qemu-\/virt-\/riscv/soc.\-c}!soc\-\_\-init@{soc\-\_\-init}}
\index{soc\-\_\-init@{soc\-\_\-init}!qemu-virt-riscv/soc.c@{qemu-\/virt-\/riscv/soc.\-c}}
\subsubsection[{soc\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}int soc\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{int}]{tick}
\end{DoxyParamCaption}
)}}\label{qemu-virt-riscv_2soc_8c_a436517497969d33b08925565d4cca572}


Q\-E\-M\-U virt platform initialization. 

Request the initialization of all the architecture of the S\-O\-C This function configures each used devices and configures which I\-R\-Q are used and how they are connected to the C\-P\-U thanks to the I\-C\-U Mask.


\begin{DoxyParams}{Parameters}
{\em tick} & number of ticks between two timer interrupts \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
-\/1 if the initialization failed, 0 if it succeeded 
\end{DoxyReturn}


References fdt\-\_\-magic, soc\-\_\-dma\-\_\-init(), soc\-\_\-icu\-\_\-init(), soc\-\_\-timer\-\_\-init(), and soc\-\_\-tty\-\_\-init().


\begin{DoxyCode}
155 \{
156     \textcolor{keywordflow}{if} (\hyperlink{libfdt_8h_a783c67f6971d10232c84ecd0aa76f461}{fdt\_magic}(fdt) != 0xd00dfeed)
157         \textcolor{keywordflow}{return} -1;
158 
159     \textcolor{comment}{// We MUST initialize the ICU first since every other device}
160     \textcolor{comment}{// initialization will rely on it for its interrupts}
161     \hyperlink{qemu-virt-riscv_2soc_8c_a4c268c213e6a62adfab96031629fa015}{soc\_icu\_init}(fdt);
162 
163     \textcolor{comment}{// Initialize TTY early so we can debug as soon as possible}
164     \textcolor{keywordflow}{if} (\hyperlink{qemu-virt-riscv_2soc_8c_a05f9476d07e118d280add6f5e3de365b}{soc\_tty\_init}(fdt) < 0)
165         \textcolor{keywordflow}{return} -1;
166 
167     \textcolor{comment}{// Finish by the timer (we don't want to schedule anything until everything}
168     \textcolor{comment}{// is initialized)}
169     \textcolor{comment}{// TODO: find a way to make tick portable}
170     (void) tick;
171     \textcolor{keywordflow}{if} (\hyperlink{qemu-virt-riscv_2soc_8c_aeb589179b71725cd918f71b4f23b21d2}{soc\_timer\_init}(fdt, 10000000) < 0)
172         \textcolor{keywordflow}{return} -1;
173 
174     \textcolor{keywordflow}{return} 0;
175 \}
\end{DoxyCode}
\hypertarget{qemu-virt-riscv_2soc_8c_aeb589179b71725cd918f71b4f23b21d2}{\index{qemu-\/virt-\/riscv/soc.\-c@{qemu-\/virt-\/riscv/soc.\-c}!soc\-\_\-timer\-\_\-init@{soc\-\_\-timer\-\_\-init}}
\index{soc\-\_\-timer\-\_\-init@{soc\-\_\-timer\-\_\-init}!qemu-virt-riscv/soc.c@{qemu-\/virt-\/riscv/soc.\-c}}
\subsubsection[{soc\-\_\-timer\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static int soc\-\_\-timer\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{unsigned}]{tick}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{qemu-virt-riscv_2soc_8c_aeb589179b71725cd918f71b4f23b21d2}


Initialize timers described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. 


\begin{DoxyParams}{Parameters}
{\em fdt} & fdt address \\
\hline
{\em tick} & number of ticks between two timer interrupts \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
-\/1 if the initialization failed, 0 if it succeeded 
\end{DoxyReturn}


References Clint\-Timer\-Ops, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-node\-\_\-offset\-\_\-by\-\_\-compatible(), get\-\_\-base\-\_\-address(), icu\-\_\-get, timer\-\_\-s\-::ops, thread\-\_\-yield(), timer\-\_\-alloc, timer\-\_\-ops\-\_\-s\-::timer\-\_\-init, and timer\-\_\-ops\-\_\-s\-::timer\-\_\-set\-\_\-event.



Referenced by soc\-\_\-init().


\begin{DoxyCode}
127 \{
128     \textcolor{comment}{// Fetch the ICU device}
129     \textcolor{keyword}{struct }\hyperlink{structicu__s}{icu\_s} *icu = \hyperlink{icu_8h_a8ea2773b171799420c4542ff4e3bac3c}{icu\_get}(0);
130     \textcolor{keywordflow}{if} (!icu)
131         \textcolor{keywordflow}{return} -1;
132 
133     \textcolor{keywordtype}{int} timer\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, -1, \textcolor{stringliteral}{"sifive,clint0"});
134 
135     \textcolor{keywordflow}{while} (timer\_off != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND}) \{
136         \textcolor{keywordtype}{unsigned} addr = \hyperlink{qemu-virt-riscv_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\_base\_address}(fdt, timer\_off);
137 
138         \textcolor{keyword}{struct }\hyperlink{structtimer__s}{timer\_s} *timer = \hyperlink{timer_8h_a9b16e7c947532969c0eb7525c66405f6}{timer\_alloc}();
139         \hyperlink{clint-timer_8c_ac6de9c7f0557ed4f63e96d7b02123a00}{ClintTimerOps}.\hyperlink{structtimer__ops__s_a0eb1142effbe0998fda5c43a6650dc93}{timer\_init}(timer, addr, tick);
140         timer->\hyperlink{structtimer__s_a859db5220e0605eabaa9100121940b5e}{ops}->\hyperlink{structtimer__ops__s_a68a024355e7c40dc7cf97b0e9975cf73}{timer\_set\_event}(timer,
141             (\textcolor{keywordtype}{void} (*)(\textcolor{keywordtype}{void} *)) \hyperlink{kthread_8c_affe2eebf6749bc36765d45ff48c926b1}{thread\_yield}, (\textcolor{keywordtype}{void} *) 0);
142 
143         timer\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, timer\_off, \textcolor{stringliteral}{"
      sifive,clint0"});
144     \}
145 
146     \textcolor{keywordflow}{return} 0;
147 \}
\end{DoxyCode}
\hypertarget{qemu-virt-riscv_2soc_8c_a05f9476d07e118d280add6f5e3de365b}{\index{qemu-\/virt-\/riscv/soc.\-c@{qemu-\/virt-\/riscv/soc.\-c}!soc\-\_\-tty\-\_\-init@{soc\-\_\-tty\-\_\-init}}
\index{soc\-\_\-tty\-\_\-init@{soc\-\_\-tty\-\_\-init}!qemu-virt-riscv/soc.c@{qemu-\/virt-\/riscv/soc.\-c}}
\subsubsection[{soc\-\_\-tty\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static int soc\-\_\-tty\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{qemu-virt-riscv_2soc_8c_a05f9476d07e118d280add6f5e3de365b}


Initialize the T\-T\-Ys present on the S\-O\-C based on the device-\/tree content Basically, every device initialization follow the same process\-: We loop on each device compatible with our drivers for this platform, by exemple soclib,tty For each device, we find it's base address in the reg property of the device tree node and its I\-R\-Q in the interrupts property. Once we've fetched this data, we allocate a new device (see hal/dev.\-h) and register it in the device list. We then setup the device with a device-\/specific function declared by the H\-A\-L (ex\-: tty\-\_\-init) Last thing we do is unmask the interrupt in the I\-C\-U and register the I\-S\-R for the device. 


\begin{DoxyParams}{Parameters}
{\em fdt} & fdt address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
-\/1 if the initialization failed, 0 if it succeeded 
\end{DoxyReturn}


References chardev\-\_\-alloc, chardev\-\_\-ops\-\_\-s\-::chardev\-\_\-init, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-node\-\_\-offset\-\_\-by\-\_\-compatible(), get\-\_\-base\-\_\-address(), get\-\_\-irq(), icu\-\_\-get, icu\-\_\-ops\-\_\-s\-::icu\-\_\-set\-\_\-priority, icu\-\_\-ops\-\_\-s\-::icu\-\_\-unmask, ns16550\-\_\-isr(), N\-S16550\-Ops, icu\-\_\-s\-::ops, and register\-\_\-interrupt().



Referenced by soc\-\_\-init().


\begin{DoxyCode}
85 \{
86     \textcolor{comment}{// Fetch the ICU device}
87     \textcolor{keyword}{struct }\hyperlink{structicu__s}{icu\_s} *icu = \hyperlink{icu_8h_a8ea2773b171799420c4542ff4e3bac3c}{icu\_get}(0);
88     \textcolor{comment}{// Check that the ICU has already been initialized}
89     \textcolor{keywordflow}{if} (!icu)
90         \textcolor{keywordflow}{return} -1;
91 
92     \textcolor{comment}{// Find the first TTY device}
93     \textcolor{keywordtype}{int} tty\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, -1, \textcolor{stringliteral}{"ns16550a"});
94 
95     \textcolor{comment}{// Loop until we can't find any more compatible ttys in the device tree}
96     \textcolor{keywordflow}{while} (tty\_off != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND}) \{
97         \textcolor{comment}{// Fetch the necessary properties from the device tree}
98         \textcolor{keywordtype}{unsigned} addr = \hyperlink{qemu-virt-riscv_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\_base\_address}(fdt, tty\_off);
99         \textcolor{keywordtype}{unsigned} irq = \hyperlink{qemu-virt-riscv_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}{get\_irq}(fdt, tty\_off);
100 
101         \textcolor{comment}{// Allocate the structure and add it in the global device list}
102         \textcolor{keyword}{struct }\hyperlink{structchardev__s}{chardev\_s} *tty = \hyperlink{chardev_8h_a0f9abac4f27deb18dd30410b33ba7e72}{chardev\_alloc}();
103         \textcolor{comment}{// Initialize the device}
104         \hyperlink{ns16550_8c_a0ee065bfc31437abc862a858a0c0e641}{NS16550Ops}.\hyperlink{structchardev__ops__s_acde8ff309c1553a2209756737f2b2d31}{chardev\_init}(tty, addr, 9600);
105         \textcolor{comment}{// Unmask the interrupt}
106         icu->\hyperlink{structicu__s_a7f989a94a922fa1c782cfcf7547bd8c5}{ops}->\hyperlink{structicu__ops__s_a4aee28cc809733a67481e782c1efd1fa}{icu\_unmask}(icu, irq);
107         icu->\hyperlink{structicu__s_a7f989a94a922fa1c782cfcf7547bd8c5}{ops}->\hyperlink{structicu__ops__s_a1f08d353530f63d1877f160fd70fcdfd}{icu\_set\_priority}(icu, irq, 1);
108 
109         \textcolor{comment}{// Register the corresponding ISR}
110         \hyperlink{kirq_8c_a7bb6fb99500c6f10708c7653cef722e8}{register\_interrupt}(irq, (\hyperlink{kirq_8h_a6c476c213249d7236d7888257e71628d}{isr\_t}) \hyperlink{ns16550_8c_ae454489b1aed9bb4342ee26403d4ee93}{ns16550\_isr}, tty);
111 
112         \textcolor{comment}{// Find the next compatible tty}
113         tty\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, tty\_off, \textcolor{stringliteral}{"ns16550a"});
114     \}
115 
116     \textcolor{keywordflow}{return} 0;
117 \}
\end{DoxyCode}
