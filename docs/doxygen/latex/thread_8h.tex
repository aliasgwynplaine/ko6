\hypertarget{thread_8h}{\section{/users/enseig/franck/ko6/src/soft/hal/cpu/thread.h File Reference}
\label{thread_8h}\index{/users/enseig/franck/ko6/src/soft/hal/cpu/thread.\-h@{/users/enseig/franck/ko6/src/soft/hal/cpu/thread.\-h}}
}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{thread_8h_af63f55ab4a65c97f8effe4ff21de0b1e}{thread\-\_\-context\-\_\-init} (int context\mbox{[}$\,$\mbox{]}, void $\ast$bootstrap, void $\ast$stack\-\_\-pointer)
\begin{DoxyCompactList}\small\item\em Initialize the thread context at the very beginning. \end{DoxyCompactList}\item 
int \hyperlink{thread_8h_a4ec481f4858f7894f48f951d1a59e868}{thread\-\_\-context\-\_\-save} (int context\mbox{[}$\,$\mbox{]})
\begin{DoxyCompactList}\small\item\em kernel saves the given thread registers in the context table \end{DoxyCompactList}\item 
int \hyperlink{thread_8h_a2d77cc7bcdfa6b6295a8bcd74803cc4a}{thread\-\_\-context\-\_\-load} (int context\mbox{[}$\,$\mbox{]})
\begin{DoxyCompactList}\small\item\em kernel load the given thread registers from the context table \end{DoxyCompactList}\item 
int \hyperlink{thread_8h_a19412f68ca2922fbb153cf8107c16fce}{thread\-\_\-launch} (int fun, int arg, int start)
\begin{DoxyCompactList}\small\item\em The kernel starts any thread for the very first time with this function. This function is called by the static function \hyperlink{kthread_8c_ab6382c52388aa3e432787e2b9b4671bb}{thread\-\_\-bootstrap()} (in \hyperlink{kthread_8c}{kthread.\-c}) which is the real beginning of a thread, and \hyperlink{kthread_8c_ab6382c52388aa3e432787e2b9b4671bb}{thread\-\_\-bootstrap()} is called by the first call of thread\-\_\-load() for each thread (see comment of thread\-\_\-bootstrat in \hyperlink{kthread_8c}{kthread.\-c} for more details) \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{thread_8h_af63f55ab4a65c97f8effe4ff21de0b1e}{\index{thread.\-h@{thread.\-h}!thread\-\_\-context\-\_\-init@{thread\-\_\-context\-\_\-init}}
\index{thread\-\_\-context\-\_\-init@{thread\-\_\-context\-\_\-init}!thread.h@{thread.\-h}}
\subsubsection[{thread\-\_\-context\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}void thread\-\_\-context\-\_\-init (
\begin{DoxyParamCaption}
\item[{int}]{context\mbox{[}$\,$\mbox{]}, }
\item[{void $\ast$}]{bootstrap, }
\item[{void $\ast$}]{stack\-\_\-pointer}
\end{DoxyParamCaption}
)}}\label{thread_8h_af63f55ab4a65c97f8effe4ff21de0b1e}


Initialize the thread context at the very beginning. 


\begin{DoxyParams}{Parameters}
{\em context} & thread\-\_\-context table \\
\hline
{\em bootstrap} & function without any argument, used just after the 1st thread\-\_\-context\-\_\-load \\
\hline
{\em stack\-\_\-pointer} & top stack pointer at the very beginning \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
side effect on the given thread context table 
\end{DoxyReturn}
mstatus of a user-\/thread should have\-: mstatus.\-M\-P\-I\-E = 0 (we don't want interrupts when we go back in M-\/mode) mstatus.\-M\-P\-P = M-\/mode (we want to go back in m-\/mode) mstatus.\-M\-I\-E = 1 (interrupts are enabled)

References T\-H\-\_\-\-C\-O\-N\-T\-E\-X\-T\-\_\-\-M\-S\-T\-A\-T\-U\-S, T\-H\-\_\-\-C\-O\-N\-T\-E\-X\-T\-\_\-\-R\-A, T\-H\-\_\-\-C\-O\-N\-T\-E\-X\-T\-\_\-\-S\-P, and T\-H\-\_\-\-C\-O\-N\-T\-E\-X\-T\-\_\-\-S\-R.



Referenced by thread\-\_\-create().


\begin{DoxyCode}
20 \{
21     context[\hyperlink{mips_2context_8h_a82628b11b4b2d2529fb40f9b239ffffb}{TH\_CONTEXT\_SR}] = 0x413;                 \textcolor{comment}{// UM=1 EXL=1 IE=1}
22     context[\hyperlink{mips_2context_8h_a68ca4f685574d5124a207ed155304e72}{TH\_CONTEXT\_RA}] = (int)bootstrap;        \textcolor{comment}{// goto thread\_bootstrap}
23     context[\hyperlink{mips_2context_8h_a144a505c445f1e70afbf4ff0196bf330}{TH\_CONTEXT\_SP}] = (int)stack\_pointer;    \textcolor{comment}{// stack beginning }
24 \}
\end{DoxyCode}
\hypertarget{thread_8h_a2d77cc7bcdfa6b6295a8bcd74803cc4a}{\index{thread.\-h@{thread.\-h}!thread\-\_\-context\-\_\-load@{thread\-\_\-context\-\_\-load}}
\index{thread\-\_\-context\-\_\-load@{thread\-\_\-context\-\_\-load}!thread.h@{thread.\-h}}
\subsubsection[{thread\-\_\-context\-\_\-load}]{\setlength{\rightskip}{0pt plus 5cm}int thread\-\_\-context\-\_\-load (
\begin{DoxyParamCaption}
\item[{int}]{context\mbox{[}$\,$\mbox{]}}
\end{DoxyParamCaption}
)}}\label{thread_8h_a2d77cc7bcdfa6b6295a8bcd74803cc4a}


kernel load the given thread registers from the context table 


\begin{DoxyParams}{Parameters}
{\em context} & thread\-\_\-context table of the thread to load (or to restore) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
returns alway 0 (false) 
\end{DoxyReturn}
\hypertarget{thread_8h_a4ec481f4858f7894f48f951d1a59e868}{\index{thread.\-h@{thread.\-h}!thread\-\_\-context\-\_\-save@{thread\-\_\-context\-\_\-save}}
\index{thread\-\_\-context\-\_\-save@{thread\-\_\-context\-\_\-save}!thread.h@{thread.\-h}}
\subsubsection[{thread\-\_\-context\-\_\-save}]{\setlength{\rightskip}{0pt plus 5cm}int thread\-\_\-context\-\_\-save (
\begin{DoxyParamCaption}
\item[{int}]{context\mbox{[}$\,$\mbox{]}}
\end{DoxyParamCaption}
)}}\label{thread_8h_a4ec481f4858f7894f48f951d1a59e868}


kernel saves the given thread registers in the context table 


\begin{DoxyParams}{Parameters}
{\em context} & thread\-\_\-context table of the thread to save \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
it returns two values depending on how this function has been called. First case, the simplest, we call thread\-\_\-save () then it returns 1 (true). Secondly, we call thread\-\_\-restore() (see bellow) that causes the restoration of all registers recorded by thread\-\_\-save(), including \$31, thus when we return from thread\-\_\-load(), in reality, we return from thread\-\_\-save, but with 0 (false) as return value. 
\end{DoxyReturn}
\hypertarget{thread_8h_a19412f68ca2922fbb153cf8107c16fce}{\index{thread.\-h@{thread.\-h}!thread\-\_\-launch@{thread\-\_\-launch}}
\index{thread\-\_\-launch@{thread\-\_\-launch}!thread.h@{thread.\-h}}
\subsubsection[{thread\-\_\-launch}]{\setlength{\rightskip}{0pt plus 5cm}int thread\-\_\-launch (
\begin{DoxyParamCaption}
\item[{int}]{fun, }
\item[{int}]{arg, }
\item[{int}]{start}
\end{DoxyParamCaption}
)}}\label{thread_8h_a19412f68ca2922fbb153cf8107c16fce}


The kernel starts any thread for the very first time with this function. This function is called by the static function \hyperlink{kthread_8c_ab6382c52388aa3e432787e2b9b4671bb}{thread\-\_\-bootstrap()} (in \hyperlink{kthread_8c}{kthread.\-c}) which is the real beginning of a thread, and \hyperlink{kthread_8c_ab6382c52388aa3e432787e2b9b4671bb}{thread\-\_\-bootstrap()} is called by the first call of thread\-\_\-load() for each thread (see comment of thread\-\_\-bootstrat in \hyperlink{kthread_8c}{kthread.\-c} for more details) 


\begin{DoxyParams}{Parameters}
{\em fun} & ptr to the function of the thread, type\-: void$\ast$({\itshape fun)(void}) but cast to int \\
\hline
{\em arg} & the argument given to fun(), type\-: void$\ast$ but cast to int \\
\hline
{\em start} & ptr to the user function which calls fun(arg) for real, type is cast to int In fact, start has two possible types. If it is the main thread then it is \-: void ($\ast$start) (void) but if it is a standard thread then it is \-: void ($\ast$start) (void $\ast$($\ast$fun) (void $\ast$), void $\ast$arg) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
never returns 
\end{DoxyReturn}
