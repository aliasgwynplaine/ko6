\hypertarget{fdt__overlay_8c}{\section{/users/enseig/franck/ko6/src/soft/external/libfdt/fdt\-\_\-overlay.c File Reference}
\label{fdt__overlay_8c}\index{/users/enseig/franck/ko6/src/soft/external/libfdt/fdt\-\_\-overlay.\-c@{/users/enseig/franck/ko6/src/soft/external/libfdt/fdt\-\_\-overlay.\-c}}
}
{\ttfamily \#include \char`\"{}libfdt\-\_\-env.\-h\char`\"{}}\\*
{\ttfamily \#include $<$external/libfdt/fdt.\-h$>$}\\*
{\ttfamily \#include $<$external/libfdt/libfdt.\-h$>$}\\*
{\ttfamily \#include \char`\"{}libfdt\-\_\-internal.\-h\char`\"{}}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} \hyperlink{fdt__overlay_8c_a1b77c6faf056e97fb21ed6c3b7d3ac6a}{overlay\-\_\-get\-\_\-target\-\_\-phandle} (const void $\ast$fdto, int fragment)
\item 
int \hyperlink{fdt__overlay_8c_aa155e9207e65bc6c432c40e301485af5}{fdt\-\_\-overlay\-\_\-target\-\_\-offset} (const void $\ast$fdt, const void $\ast$fdto, int fragment\-\_\-offset, char const $\ast$$\ast$pathp)
\end{DoxyCompactItemize}
\begin{Indent}{\bf \-: Name of the property to modify (phandle or linux,phandle)}\par
{\em overlay\-\_\-phandle\-\_\-add\-\_\-offset -\/ Increases a phandle by an offset \-: Base device tree blob \-: Device tree overlay blob

\-: offset to apply

\hyperlink{fdt__overlay_8c_a6b1ddbc5c439ce0876f35907174284d8}{overlay\-\_\-phandle\-\_\-add\-\_\-offset()} increments a node phandle by a given offset.

returns\-: 0 on success. Negative error code on error }\begin{DoxyCompactItemize}
\item 
static int \hyperlink{fdt__overlay_8c_a6b1ddbc5c439ce0876f35907174284d8}{overlay\-\_\-phandle\-\_\-add\-\_\-offset} (void $\ast$fdt, int node, const char $\ast$name, \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} delta)
\item 
static int \hyperlink{fdt__overlay_8c_a5256ba69a35ddc0c66148e329285a12b}{overlay\-\_\-adjust\-\_\-node\-\_\-phandles} (void $\ast$fdto, int node, \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} delta)
\item 
static int \hyperlink{fdt__overlay_8c_a8cde92cc15e941275df561c47f912ba4}{overlay\-\_\-adjust\-\_\-local\-\_\-phandles} (void $\ast$fdto, \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} delta)
\item 
static int \hyperlink{fdt__overlay_8c_a385dd43636a52dc96596827f51511419}{overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references} (void $\ast$fdto, int tree\-\_\-node, int fixup\-\_\-node, \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} delta)
\item 
static int \hyperlink{fdt__overlay_8c_a1c4ea38de65ffacb7708dd7641914a34}{overlay\-\_\-update\-\_\-local\-\_\-references} (void $\ast$fdto, \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} delta)
\end{DoxyCompactItemize}
\end{Indent}
\begin{Indent}{\bf \-: Name of the property holding the phandle reference in the overlay}\par
{\em overlay\-\_\-fixup\-\_\-one\-\_\-phandle -\/ Set an overlay phandle to the base one \-: Base Device Tree blob \-: Device tree overlay blob \-: Node offset of the symbols node in the base device tree \-: Path to a node holding a phandle in the overlay \-: number of path characters to consider

\-: number of name characters to consider \-: Offset within the overlay property where the phandle is stored \-: Label of the node referenced by the phandle

\hyperlink{fdt__overlay_8c_ac2699eeb863f2070d20b509d0b2948f4}{overlay\-\_\-fixup\-\_\-one\-\_\-phandle()} resolves an overlay phandle pointing to a node in the base device tree.

This is part of the device tree overlay application process, when you want all the phandles in the overlay to point to the actual base dt nodes.

returns\-: 0 on success Negative error code on failure }\begin{DoxyCompactItemize}
\item 
static int \hyperlink{fdt__overlay_8c_ac2699eeb863f2070d20b509d0b2948f4}{overlay\-\_\-fixup\-\_\-one\-\_\-phandle} (void $\ast$fdt, void $\ast$fdto, int symbols\-\_\-off, const char $\ast$path, \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} path\-\_\-len, const char $\ast$name, \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\-\_\-t} name\-\_\-len, int poffset, const char $\ast$label)
\item 
static int \hyperlink{fdt__overlay_8c_a27d6c0e207237b7020d4c7bfa0eb0402}{overlay\-\_\-fixup\-\_\-phandle} (void $\ast$fdt, void $\ast$fdto, int symbols\-\_\-off, int property)
\item 
static int \hyperlink{fdt__overlay_8c_a5cf73a63ad60707f4c93c7de7de81357}{overlay\-\_\-fixup\-\_\-phandles} (void $\ast$fdt, void $\ast$fdto)
\item 
static int \hyperlink{fdt__overlay_8c_a8cb95c9322e1e68282eda3e7fc90a314}{overlay\-\_\-apply\-\_\-node} (void $\ast$fdt, int target, void $\ast$fdto, int node)
\item 
static int \hyperlink{fdt__overlay_8c_a36a905f6566751e42d0a0111b2d78a67}{overlay\-\_\-merge} (void $\ast$fdt, void $\ast$fdto)
\item 
static int \hyperlink{fdt__overlay_8c_ac3e9264fbe6e8ef97f2378ead11a2fd0}{get\-\_\-path\-\_\-len} (const void $\ast$fdt, int nodeoffset)
\item 
static int \hyperlink{fdt__overlay_8c_add76bc4fa1b36b1c11bfd9a2cf779ac1}{overlay\-\_\-symbol\-\_\-update} (void $\ast$fdt, void $\ast$fdto)
\item 
int \hyperlink{fdt__overlay_8c_ad0fcb152428382bde7f034cdadfe923e}{fdt\-\_\-overlay\-\_\-apply} (void $\ast$fdt, void $\ast$fdto)
\end{DoxyCompactItemize}
\end{Indent}


\subsection{Function Documentation}
\hypertarget{fdt__overlay_8c_ad0fcb152428382bde7f034cdadfe923e}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!fdt\-\_\-overlay\-\_\-apply@{fdt\-\_\-overlay\-\_\-apply}}
\index{fdt\-\_\-overlay\-\_\-apply@{fdt\-\_\-overlay\-\_\-apply}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{fdt\-\_\-overlay\-\_\-apply}]{\setlength{\rightskip}{0pt plus 5cm}int fdt\-\_\-overlay\-\_\-apply (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{void $\ast$}]{fdto}
\end{DoxyParamCaption}
)}}\label{fdt__overlay_8c_ad0fcb152428382bde7f034cdadfe923e}
fdt\-\_\-overlay\-\_\-apply -\/ Applies a D\-T overlay on a base D\-T \-: pointer to the base device tree blob \-: pointer to the device tree overlay blob

\hyperlink{fdt__overlay_8c_ad0fcb152428382bde7f034cdadfe923e}{fdt\-\_\-overlay\-\_\-apply()} will apply the given device tree overlay on the given base device tree.

Expect the base device tree to be modified, even if the function returns an error.

returns\-: 0, on success -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-S\-P\-A\-C\-E, there's not enough space in the base device tree -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, the overlay points to some inexistant nodes or properties in the base D\-T -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-P\-H\-A\-N\-D\-L\-E, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-O\-V\-E\-R\-L\-A\-Y, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-P\-H\-A\-N\-D\-L\-E\-S, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-I\-N\-T\-E\-R\-N\-A\-L, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-L\-A\-Y\-O\-U\-T, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-M\-A\-G\-I\-C, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-O\-F\-F\-S\-E\-T, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-P\-A\-T\-H, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-V\-E\-R\-S\-I\-O\-N, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-S\-T\-R\-U\-C\-T\-U\-R\-E, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-S\-T\-A\-T\-E, -\/\-F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-T\-R\-U\-N\-C\-A\-T\-E\-D, standard meanings 

References fdt\-\_\-find\-\_\-max\-\_\-phandle(), F\-D\-T\-\_\-\-R\-O\-\_\-\-P\-R\-O\-B\-E, overlay\-\_\-adjust\-\_\-local\-\_\-phandles(), overlay\-\_\-fixup\-\_\-phandles(), overlay\-\_\-merge(), overlay\-\_\-symbol\-\_\-update(), and overlay\-\_\-update\-\_\-local\-\_\-references().


\begin{DoxyCode}
816 \{
817     \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} delta;
818     \textcolor{keywordtype}{int} ret;
819 
820     \hyperlink{libfdt__internal_8h_ad6927f926180469d5c044ec5d3b2f84b}{FDT\_RO\_PROBE}(fdt);
821     \hyperlink{libfdt__internal_8h_ad6927f926180469d5c044ec5d3b2f84b}{FDT\_RO\_PROBE}(fdto);
822 
823     ret = \hyperlink{fdt__ro_8c_a57fbf6be8c4911e8448942b9fed97301}{fdt\_find\_max\_phandle}(fdt, &delta);
824     \textcolor{keywordflow}{if} (ret)
825         \textcolor{keywordflow}{goto} err;
826 
827     ret = \hyperlink{fdt__overlay_8c_a8cde92cc15e941275df561c47f912ba4}{overlay\_adjust\_local\_phandles}(fdto, delta);
828     \textcolor{keywordflow}{if} (ret)
829         \textcolor{keywordflow}{goto} err;
830 
831     ret = \hyperlink{fdt__overlay_8c_a1c4ea38de65ffacb7708dd7641914a34}{overlay\_update\_local\_references}(fdto, delta);
832     \textcolor{keywordflow}{if} (ret)
833         \textcolor{keywordflow}{goto} err;
834 
835     ret = \hyperlink{fdt__overlay_8c_a5cf73a63ad60707f4c93c7de7de81357}{overlay\_fixup\_phandles}(fdt, fdto);
836     \textcolor{keywordflow}{if} (ret)
837         \textcolor{keywordflow}{goto} err;
838 
839     ret = \hyperlink{fdt__overlay_8c_a36a905f6566751e42d0a0111b2d78a67}{overlay\_merge}(fdt, fdto);
840     \textcolor{keywordflow}{if} (ret)
841         \textcolor{keywordflow}{goto} err;
842 
843     ret = \hyperlink{fdt__overlay_8c_add76bc4fa1b36b1c11bfd9a2cf779ac1}{overlay\_symbol\_update}(fdt, fdto);
844     \textcolor{keywordflow}{if} (ret)
845         \textcolor{keywordflow}{goto} err;
846 
847     \textcolor{comment}{/*}
848 \textcolor{comment}{     * The overlay has been damaged, erase its magic.}
849 \textcolor{comment}{     */}
850     fdt\_set\_magic(fdto, ~0);
851 
852     \textcolor{keywordflow}{return} 0;
853 
854 err:
855     \textcolor{comment}{/*}
856 \textcolor{comment}{     * The overlay might have been damaged, erase its magic.}
857 \textcolor{comment}{     */}
858     fdt\_set\_magic(fdto, ~0);
859 
860     \textcolor{comment}{/*}
861 \textcolor{comment}{     * The base device tree might have been damaged, erase its}
862 \textcolor{comment}{     * magic.}
863 \textcolor{comment}{     */}
864     fdt\_set\_magic(fdt, ~0);
865 
866     \textcolor{keywordflow}{return} ret;
867 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_aa155e9207e65bc6c432c40e301485af5}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!fdt\-\_\-overlay\-\_\-target\-\_\-offset@{fdt\-\_\-overlay\-\_\-target\-\_\-offset}}
\index{fdt\-\_\-overlay\-\_\-target\-\_\-offset@{fdt\-\_\-overlay\-\_\-target\-\_\-offset}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{fdt\-\_\-overlay\-\_\-target\-\_\-offset}]{\setlength{\rightskip}{0pt plus 5cm}int fdt\-\_\-overlay\-\_\-target\-\_\-offset (
\begin{DoxyParamCaption}
\item[{const void $\ast$}]{fdt, }
\item[{const void $\ast$}]{fdto, }
\item[{int}]{fragment\-\_\-offset, }
\item[{char const $\ast$$\ast$}]{pathp}
\end{DoxyParamCaption}
)}}\label{fdt__overlay_8c_aa155e9207e65bc6c432c40e301485af5}
fdt\-\_\-overlay\-\_\-target\-\_\-offset -\/ retrieves the offset of a fragment's target \-: Base device tree blob \-: Device tree overlay blob \-: node offset of the fragment in the overlay \-: pointer which receives the path of the target (or N\-U\-L\-L)

\hyperlink{fdt__overlay_8c_aa155e9207e65bc6c432c40e301485af5}{fdt\-\_\-overlay\-\_\-target\-\_\-offset()} retrieves the target offset in the base device tree of a fragment, no matter how the actual targeting is done (through a phandle or a path)

returns\-: the targeted node offset in the base device tree Negative error code on error 

References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-O\-V\-E\-R\-L\-A\-Y, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-P\-H\-A\-N\-D\-L\-E, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-getprop(), fdt\-\_\-node\-\_\-offset\-\_\-by\-\_\-phandle(), fdt\-\_\-path\-\_\-offset(), N\-U\-L\-L, and overlay\-\_\-get\-\_\-target\-\_\-phandle().



Referenced by overlay\-\_\-merge(), and overlay\-\_\-symbol\-\_\-update().


\begin{DoxyCode}
45 \{
46     \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} phandle;
47     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *path = \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
48     \textcolor{keywordtype}{int} path\_len = 0, ret;
49 
50     \textcolor{comment}{/* Try first to do a phandle based lookup */}
51     phandle = \hyperlink{fdt__overlay_8c_a1b77c6faf056e97fb21ed6c3b7d3ac6a}{overlay\_get\_target\_phandle}(fdto, fragment\_offset);
52     \textcolor{keywordflow}{if} (phandle == (\hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t})-1)
53         \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a0f264f8ba8cc4e98852c8246bc6312bc}{FDT\_ERR\_BADPHANDLE};
54 
55     \textcolor{comment}{/* no phandle, try path */}
56     \textcolor{keywordflow}{if} (!phandle) \{
57         \textcolor{comment}{/* And then a path based lookup */}
58         path = \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdto, fragment\_offset, \textcolor{stringliteral}{"target-path"}, &path\_len);
59         \textcolor{keywordflow}{if} (path)
60             ret = \hyperlink{fdt__ro_8c_a222c01ef0a514a4cf7586f6de8b17072}{fdt\_path\_offset}(fdt, path);
61         \textcolor{keywordflow}{else}
62             ret = path\_len;
63     \} \textcolor{keywordflow}{else}
64         ret = \hyperlink{fdt__ro_8c_a4ff6571f3fe2fa89cfd6dc15f52eaf1e}{fdt\_node\_offset\_by\_phandle}(fdt, phandle);
65 
66     \textcolor{comment}{/*}
67 \textcolor{comment}{    * If we haven't found either a target or a}
68 \textcolor{comment}{    * target-path property in a node that contains a}
69 \textcolor{comment}{    * \_\_overlay\_\_ subnode (we wouldn't be called}
70 \textcolor{comment}{    * otherwise), consider it a improperly written}
71 \textcolor{comment}{    * overlay}
72 \textcolor{comment}{    */}
73     \textcolor{keywordflow}{if} (ret < 0 && path\_len == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
74         ret = -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
75 
76     \textcolor{comment}{/* return on error */}
77     \textcolor{keywordflow}{if} (ret < 0)
78         \textcolor{keywordflow}{return} ret;
79 
80     \textcolor{comment}{/* return pointer to path (if available) */}
81     \textcolor{keywordflow}{if} (pathp)
82         *pathp = path ? path : \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
83 
84     \textcolor{keywordflow}{return} ret;
85 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_ac3e9264fbe6e8ef97f2378ead11a2fd0}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!get\-\_\-path\-\_\-len@{get\-\_\-path\-\_\-len}}
\index{get\-\_\-path\-\_\-len@{get\-\_\-path\-\_\-len}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{get\-\_\-path\-\_\-len}]{\setlength{\rightskip}{0pt plus 5cm}static int get\-\_\-path\-\_\-len (
\begin{DoxyParamCaption}
\item[{const void $\ast$}]{fdt, }
\item[{int}]{nodeoffset}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_ac3e9264fbe6e8ef97f2378ead11a2fd0}


References fdt\-\_\-get\-\_\-name(), fdt\-\_\-parent\-\_\-offset(), and F\-D\-T\-\_\-\-R\-O\-\_\-\-P\-R\-O\-B\-E.



Referenced by overlay\-\_\-symbol\-\_\-update().


\begin{DoxyCode}
637 \{
638     \textcolor{keywordtype}{int} \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len} = 0, namelen;
639     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name;
640 
641     \hyperlink{libfdt__internal_8h_ad6927f926180469d5c044ec5d3b2f84b}{FDT\_RO\_PROBE}(fdt);
642 
643     \textcolor{keywordflow}{for} (;;) \{
644         name = \hyperlink{fdt__ro_8c_a22a72941a288c00c88c36164fdc793c0}{fdt\_get\_name}(fdt, nodeoffset, &namelen);
645         \textcolor{keywordflow}{if} (!name)
646             \textcolor{keywordflow}{return} namelen;
647 
648         \textcolor{comment}{/* root? we're done */}
649         \textcolor{keywordflow}{if} (namelen == 0)
650             \textcolor{keywordflow}{break};
651 
652         nodeoffset = \hyperlink{fdt__ro_8c_a2b518dbd88cb783a9bffa1680ab297f9}{fdt\_parent\_offset}(fdt, nodeoffset);
653         \textcolor{keywordflow}{if} (nodeoffset < 0)
654             \textcolor{keywordflow}{return} nodeoffset;
655         len += namelen + 1;
656     \}
657 
658     \textcolor{comment}{/* in case of root pretend it's "/" */}
659     \textcolor{keywordflow}{if} (len == 0)
660         len++;
661     \textcolor{keywordflow}{return} \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len};
662 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a8cde92cc15e941275df561c47f912ba4}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-adjust\-\_\-local\-\_\-phandles@{overlay\-\_\-adjust\-\_\-local\-\_\-phandles}}
\index{overlay\-\_\-adjust\-\_\-local\-\_\-phandles@{overlay\-\_\-adjust\-\_\-local\-\_\-phandles}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-adjust\-\_\-local\-\_\-phandles}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-adjust\-\_\-local\-\_\-phandles (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdto, }
\item[{{\bf uint32\-\_\-t}}]{delta}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a8cde92cc15e941275df561c47f912ba4}
overlay\-\_\-adjust\-\_\-local\-\_\-phandles -\/ Adjust the phandles of a whole overlay \-: Device tree overlay blob \-: Offset to shift the phandles of

\hyperlink{fdt__overlay_8c_a8cde92cc15e941275df561c47f912ba4}{overlay\-\_\-adjust\-\_\-local\-\_\-phandles()} adds a constant to all the phandles of an overlay. This is mainly use as part of the overlay application process, when we want to update all the overlay phandles to not conflict with the overlays of the base device tree.

returns\-: 0 on success Negative error code on failure 

References overlay\-\_\-adjust\-\_\-node\-\_\-phandles().



Referenced by fdt\-\_\-overlay\-\_\-apply().


\begin{DoxyCode}
179 \{
180     \textcolor{comment}{/*}
181 \textcolor{comment}{     * Start adjusting the phandles from the overlay root}
182 \textcolor{comment}{     */}
183     \textcolor{keywordflow}{return} \hyperlink{fdt__overlay_8c_a5256ba69a35ddc0c66148e329285a12b}{overlay\_adjust\_node\_phandles}(fdto, 0, delta);
184 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a5256ba69a35ddc0c66148e329285a12b}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-adjust\-\_\-node\-\_\-phandles@{overlay\-\_\-adjust\-\_\-node\-\_\-phandles}}
\index{overlay\-\_\-adjust\-\_\-node\-\_\-phandles@{overlay\-\_\-adjust\-\_\-node\-\_\-phandles}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-adjust\-\_\-node\-\_\-phandles}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-adjust\-\_\-node\-\_\-phandles (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdto, }
\item[{int}]{node, }
\item[{{\bf uint32\-\_\-t}}]{delta}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a5256ba69a35ddc0c66148e329285a12b}
overlay\-\_\-adjust\-\_\-node\-\_\-phandles -\/ Offsets the phandles of a node \-: Device tree overlay blob \-: Offset of the node we want to adjust \-: Offset to shift the phandles of

\hyperlink{fdt__overlay_8c_a5256ba69a35ddc0c66148e329285a12b}{overlay\-\_\-adjust\-\_\-node\-\_\-phandles()} adds a constant to all the phandles of a given node. This is mainly use as part of the overlay application process, when we want to update all the overlay phandles to not conflict with the overlays of the base device tree.

returns\-: 0 on success Negative error code on failure 

References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-for\-\_\-each\-\_\-subnode, and overlay\-\_\-phandle\-\_\-add\-\_\-offset().



Referenced by overlay\-\_\-adjust\-\_\-local\-\_\-phandles().


\begin{DoxyCode}
143 \{
144     \textcolor{keywordtype}{int} child;
145     \textcolor{keywordtype}{int} ret;
146 
147     ret = \hyperlink{fdt__overlay_8c_a6b1ddbc5c439ce0876f35907174284d8}{overlay\_phandle\_add\_offset}(fdto, node, \textcolor{stringliteral}{"phandle"}, delta);
148     \textcolor{keywordflow}{if} (ret && ret != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
149         \textcolor{keywordflow}{return} ret;
150 
151     ret = \hyperlink{fdt__overlay_8c_a6b1ddbc5c439ce0876f35907174284d8}{overlay\_phandle\_add\_offset}(fdto, node, \textcolor{stringliteral}{"linux,phandle"}, delta);
152     \textcolor{keywordflow}{if} (ret && ret != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
153         \textcolor{keywordflow}{return} ret;
154 
155     \hyperlink{libfdt_8h_a7815aea6a1994b5fb035623a86e890a4}{fdt\_for\_each\_subnode}(child, fdto, node) \{
156         ret = \hyperlink{fdt__overlay_8c_a5256ba69a35ddc0c66148e329285a12b}{overlay\_adjust\_node\_phandles}(fdto, child, delta);
157         \textcolor{keywordflow}{if} (ret)
158             \textcolor{keywordflow}{return} ret;
159     \}
160 
161     \textcolor{keywordflow}{return} 0;
162 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a8cb95c9322e1e68282eda3e7fc90a314}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-apply\-\_\-node@{overlay\-\_\-apply\-\_\-node}}
\index{overlay\-\_\-apply\-\_\-node@{overlay\-\_\-apply\-\_\-node}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-apply\-\_\-node}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-apply\-\_\-node (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{int}]{target, }
\item[{void $\ast$}]{fdto, }
\item[{int}]{node}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a8cb95c9322e1e68282eda3e7fc90a314}
overlay\-\_\-apply\-\_\-node -\/ Merges a node into the base device tree \-: Base Device Tree blob \-: Node offset in the base device tree to apply the fragment to \-: Device tree overlay blob \-: Node offset in the overlay holding the changes to merge

\hyperlink{fdt__overlay_8c_a8cb95c9322e1e68282eda3e7fc90a314}{overlay\-\_\-apply\-\_\-node()} merges a node into a target base device tree node pointed.

This is part of the final step in the device tree overlay application process, when all the phandles have been adjusted and resolved and you just have to merge overlay into the base device tree.

returns\-: 0 on success Negative error code on failure 

References fdt\-\_\-add\-\_\-subnode(), F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-E\-X\-I\-S\-T\-S, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-I\-N\-T\-E\-R\-N\-A\-L, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-for\-\_\-each\-\_\-property\-\_\-offset, fdt\-\_\-for\-\_\-each\-\_\-subnode, fdt\-\_\-get\-\_\-name(), fdt\-\_\-getprop\-\_\-by\-\_\-offset(), fdt\-\_\-setprop(), fdt\-\_\-subnode\-\_\-offset(), and N\-U\-L\-L.



Referenced by overlay\-\_\-merge().


\begin{DoxyCode}
544 \{
545     \textcolor{keywordtype}{int} property;
546     \textcolor{keywordtype}{int} subnode;
547 
548     \hyperlink{libfdt_8h_ad994c33538d83be1383d449ed336803a}{fdt\_for\_each\_property\_offset}(property, fdto, node) \{
549         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name;
550         \textcolor{keyword}{const} \textcolor{keywordtype}{void} *prop;
551         \textcolor{keywordtype}{int} prop\_len;
552         \textcolor{keywordtype}{int} ret;
553 
554         prop = \hyperlink{fdt__ro_8c_a631207472dcddda9470f5791260da0fd}{fdt\_getprop\_by\_offset}(fdto, property, &name,
555                          &prop\_len);
556         \textcolor{keywordflow}{if} (prop\_len == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
557             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a02625761a47e8012c53fb389dd25fadd}{FDT\_ERR\_INTERNAL};
558         \textcolor{keywordflow}{if} (prop\_len < 0)
559             \textcolor{keywordflow}{return} prop\_len;
560 
561         ret = \hyperlink{fdt__rw_8c_ae9e3e4d33edd50404838414b8f36d158}{fdt\_setprop}(fdt, target, name, prop, prop\_len);
562         \textcolor{keywordflow}{if} (ret)
563             \textcolor{keywordflow}{return} ret;
564     \}
565 
566     \hyperlink{libfdt_8h_a7815aea6a1994b5fb035623a86e890a4}{fdt\_for\_each\_subnode}(subnode, fdto, node) \{
567         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name = \hyperlink{fdt__ro_8c_a22a72941a288c00c88c36164fdc793c0}{fdt\_get\_name}(fdto, subnode, \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
568         \textcolor{keywordtype}{int} nnode;
569         \textcolor{keywordtype}{int} ret;
570 
571         nnode = \hyperlink{fdt__rw_8c_a006872c92462f1a3c962192df483600c}{fdt\_add\_subnode}(fdt, target, name);
572         \textcolor{keywordflow}{if} (nnode == -\hyperlink{libfdt_8h_a26af70ef43c09fafd5eb29f10a09278a}{FDT\_ERR\_EXISTS}) \{
573             nnode = \hyperlink{fdt__ro_8c_a22dd90f8bea25063fe0debae7683eb02}{fdt\_subnode\_offset}(fdt, target, name);
574             \textcolor{keywordflow}{if} (nnode == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
575                 \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a02625761a47e8012c53fb389dd25fadd}{FDT\_ERR\_INTERNAL};
576         \}
577 
578         \textcolor{keywordflow}{if} (nnode < 0)
579             \textcolor{keywordflow}{return} nnode;
580 
581         ret = \hyperlink{fdt__overlay_8c_a8cb95c9322e1e68282eda3e7fc90a314}{overlay\_apply\_node}(fdt, nnode, fdto, subnode);
582         \textcolor{keywordflow}{if} (ret)
583             \textcolor{keywordflow}{return} ret;
584     \}
585 
586     \textcolor{keywordflow}{return} 0;
587 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_ac2699eeb863f2070d20b509d0b2948f4}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-fixup\-\_\-one\-\_\-phandle@{overlay\-\_\-fixup\-\_\-one\-\_\-phandle}}
\index{overlay\-\_\-fixup\-\_\-one\-\_\-phandle@{overlay\-\_\-fixup\-\_\-one\-\_\-phandle}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-fixup\-\_\-one\-\_\-phandle}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-fixup\-\_\-one\-\_\-phandle (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{void $\ast$}]{fdto, }
\item[{int}]{symbols\-\_\-off, }
\item[{const char $\ast$}]{path, }
\item[{{\bf uint32\-\_\-t}}]{path\-\_\-len, }
\item[{const char $\ast$}]{name, }
\item[{{\bf uint32\-\_\-t}}]{name\-\_\-len, }
\item[{int}]{poffset, }
\item[{const char $\ast$}]{label}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_ac2699eeb863f2070d20b509d0b2948f4}


References cpu\-\_\-to\-\_\-fdt32(), F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-O\-V\-E\-R\-L\-A\-Y, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-get\-\_\-phandle(), fdt\-\_\-getprop(), fdt\-\_\-path\-\_\-offset(), fdt\-\_\-path\-\_\-offset\-\_\-namelen(), and fdt\-\_\-setprop\-\_\-inplace\-\_\-namelen\-\_\-partial().



Referenced by overlay\-\_\-fixup\-\_\-phandle().


\begin{DoxyCode}
358 \{
359     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *symbol\_path;
360     \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} phandle;
361     \hyperlink{libfdt__env_8h_a76887ac8786252752fb3f9a39b21f3af}{fdt32\_t} phandle\_prop;
362     \textcolor{keywordtype}{int} symbol\_off, fixup\_off;
363     \textcolor{keywordtype}{int} prop\_len;
364 
365     \textcolor{keywordflow}{if} (symbols\_off < 0)
366         \textcolor{keywordflow}{return} symbols\_off;
367 
368     symbol\_path = \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdt, symbols\_off, label,
369                   &prop\_len);
370     \textcolor{keywordflow}{if} (!symbol\_path)
371         \textcolor{keywordflow}{return} prop\_len;
372 
373     symbol\_off = \hyperlink{fdt__ro_8c_a222c01ef0a514a4cf7586f6de8b17072}{fdt\_path\_offset}(fdt, symbol\_path);
374     \textcolor{keywordflow}{if} (symbol\_off < 0)
375         \textcolor{keywordflow}{return} symbol\_off;
376 
377     phandle = \hyperlink{fdt__ro_8c_a0689bb9f27bdaaa355855425b4eb7149}{fdt\_get\_phandle}(fdt, symbol\_off);
378     \textcolor{keywordflow}{if} (!phandle)
379         \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND};
380 
381     fixup\_off = \hyperlink{fdt__ro_8c_aa8b4d143366fc7d443f47c1c92a8f8cc}{fdt\_path\_offset\_namelen}(fdto, path, path\_len);
382     \textcolor{keywordflow}{if} (fixup\_off == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
383         \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
384     \textcolor{keywordflow}{if} (fixup\_off < 0)
385         \textcolor{keywordflow}{return} fixup\_off;
386 
387     phandle\_prop = \hyperlink{libfdt__env_8h_a06ce41f441b8a56710000af3c3e516e5}{cpu\_to\_fdt32}(phandle);
388     \textcolor{keywordflow}{return} \hyperlink{fdt__wip_8c_ad2d3b0ed8c78b7ca920550656dca6cf9}{fdt\_setprop\_inplace\_namelen\_partial}(fdto, fixup\_off,
389                            name, name\_len, poffset,
390                            &phandle\_prop,
391                            \textcolor{keyword}{sizeof}(phandle\_prop));
392 \};
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a27d6c0e207237b7020d4c7bfa0eb0402}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-fixup\-\_\-phandle@{overlay\-\_\-fixup\-\_\-phandle}}
\index{overlay\-\_\-fixup\-\_\-phandle@{overlay\-\_\-fixup\-\_\-phandle}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-fixup\-\_\-phandle}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-fixup\-\_\-phandle (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{void $\ast$}]{fdto, }
\item[{int}]{symbols\-\_\-off, }
\item[{int}]{property}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a27d6c0e207237b7020d4c7bfa0eb0402}


References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-O\-V\-E\-R\-L\-A\-Y, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-I\-N\-T\-E\-R\-N\-A\-L, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-getprop\-\_\-by\-\_\-offset(), memchr(), overlay\-\_\-fixup\-\_\-one\-\_\-phandle(), and strtoul().



Referenced by overlay\-\_\-fixup\-\_\-phandles().


\begin{DoxyCode}
415 \{
416     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *value;
417     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *label;
418     \textcolor{keywordtype}{int} \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len};
419 
420     value = \hyperlink{fdt__ro_8c_a631207472dcddda9470f5791260da0fd}{fdt\_getprop\_by\_offset}(fdto, property,
421                       &label, &len);
422     \textcolor{keywordflow}{if} (!value) \{
423         \textcolor{keywordflow}{if} (len == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
424             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a02625761a47e8012c53fb389dd25fadd}{FDT\_ERR\_INTERNAL};
425 
426         \textcolor{keywordflow}{return} \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len};
427     \}
428 
429     \textcolor{keywordflow}{do} \{
430         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *path, *name, *fixup\_end;
431         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *fixup\_str = value;
432         \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} path\_len, name\_len;
433         \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} fixup\_len;
434         \textcolor{keywordtype}{char} *sep, *endptr;
435         \textcolor{keywordtype}{int} poffset, ret;
436 
437         fixup\_end = \hyperlink{cstd_8c_a7a1a96cef371f847b925fb1478e04080}{memchr}(value, \textcolor{charliteral}{'\(\backslash\)0'}, len);
438         \textcolor{keywordflow}{if} (!fixup\_end)
439             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
440         fixup\_len = fixup\_end - fixup\_str;
441 
442         len -= fixup\_len + 1;
443         value += fixup\_len + 1;
444 
445         path = fixup\_str;
446         sep = \hyperlink{cstd_8c_a7a1a96cef371f847b925fb1478e04080}{memchr}(fixup\_str, \textcolor{charliteral}{':'}, fixup\_len);
447         \textcolor{keywordflow}{if} (!sep || *sep != \textcolor{charliteral}{':'})
448             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
449 
450         path\_len = sep - path;
451         \textcolor{keywordflow}{if} (path\_len == (fixup\_len - 1))
452             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
453 
454         fixup\_len -= path\_len + 1;
455         name = sep + 1;
456         sep = \hyperlink{cstd_8c_a7a1a96cef371f847b925fb1478e04080}{memchr}(name, \textcolor{charliteral}{':'}, fixup\_len);
457         \textcolor{keywordflow}{if} (!sep || *sep != \textcolor{charliteral}{':'})
458             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
459 
460         name\_len = sep - name;
461         \textcolor{keywordflow}{if} (!name\_len)
462             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
463 
464         poffset = \hyperlink{cstd_8c_a507a276d9b76c167c63b862c7d52b1a9}{strtoul}(sep + 1, &endptr, 10);
465         \textcolor{keywordflow}{if} ((*endptr != \textcolor{charliteral}{'\(\backslash\)0'}) || (endptr <= (sep + 1)))
466             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
467 
468         ret = \hyperlink{fdt__overlay_8c_ac2699eeb863f2070d20b509d0b2948f4}{overlay\_fixup\_one\_phandle}(fdt, fdto, symbols\_off,
469                         path, path\_len, name, name\_len,
470                         poffset, label);
471         \textcolor{keywordflow}{if} (ret)
472             \textcolor{keywordflow}{return} ret;
473     \} \textcolor{keywordflow}{while} (len > 0);
474 
475     \textcolor{keywordflow}{return} 0;
476 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a5cf73a63ad60707f4c93c7de7de81357}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-fixup\-\_\-phandles@{overlay\-\_\-fixup\-\_\-phandles}}
\index{overlay\-\_\-fixup\-\_\-phandles@{overlay\-\_\-fixup\-\_\-phandles}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-fixup\-\_\-phandles}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-fixup\-\_\-phandles (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{void $\ast$}]{fdto}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a5cf73a63ad60707f4c93c7de7de81357}
overlay\-\_\-fixup\-\_\-phandles -\/ Resolve the overlay phandles to the base device tree \-: Base Device Tree blob \-: Device tree overlay blob

\hyperlink{fdt__overlay_8c_a5cf73a63ad60707f4c93c7de7de81357}{overlay\-\_\-fixup\-\_\-phandles()} resolves all the overlay phandles pointing to nodes in the base device tree.

This is one of the steps of the device tree overlay application process, when you want all the phandles in the overlay to point to the actual base dt nodes.

returns\-: 0 on success Negative error code on failure 

References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-for\-\_\-each\-\_\-property\-\_\-offset, fdt\-\_\-path\-\_\-offset(), and overlay\-\_\-fixup\-\_\-phandle().



Referenced by fdt\-\_\-overlay\-\_\-apply().


\begin{DoxyCode}
496 \{
497     \textcolor{keywordtype}{int} fixups\_off, symbols\_off;
498     \textcolor{keywordtype}{int} property;
499 
500     \textcolor{comment}{/* We can have overlays without any fixups */}
501     fixups\_off = \hyperlink{fdt__ro_8c_a222c01ef0a514a4cf7586f6de8b17072}{fdt\_path\_offset}(fdto, \textcolor{stringliteral}{"/\_\_fixups\_\_"});
502     \textcolor{keywordflow}{if} (fixups\_off == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
503         \textcolor{keywordflow}{return} 0; \textcolor{comment}{/* nothing to do */}
504     \textcolor{keywordflow}{if} (fixups\_off < 0)
505         \textcolor{keywordflow}{return} fixups\_off;
506 
507     \textcolor{comment}{/* And base DTs without symbols */}
508     symbols\_off = \hyperlink{fdt__ro_8c_a222c01ef0a514a4cf7586f6de8b17072}{fdt\_path\_offset}(fdt, \textcolor{stringliteral}{"/\_\_symbols\_\_"});
509     \textcolor{keywordflow}{if} ((symbols\_off < 0 && (symbols\_off != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})))
510         \textcolor{keywordflow}{return} symbols\_off;
511 
512     \hyperlink{libfdt_8h_ad994c33538d83be1383d449ed336803a}{fdt\_for\_each\_property\_offset}(property, fdto, fixups\_off) \{
513         \textcolor{keywordtype}{int} ret;
514 
515         ret = \hyperlink{fdt__overlay_8c_a27d6c0e207237b7020d4c7bfa0eb0402}{overlay\_fixup\_phandle}(fdt, fdto, symbols\_off, property);
516         \textcolor{keywordflow}{if} (ret)
517             \textcolor{keywordflow}{return} ret;
518     \}
519 
520     \textcolor{keywordflow}{return} 0;
521 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a1b77c6faf056e97fb21ed6c3b7d3ac6a}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-get\-\_\-target\-\_\-phandle@{overlay\-\_\-get\-\_\-target\-\_\-phandle}}
\index{overlay\-\_\-get\-\_\-target\-\_\-phandle@{overlay\-\_\-get\-\_\-target\-\_\-phandle}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-get\-\_\-target\-\_\-phandle}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf uint32\-\_\-t} overlay\-\_\-get\-\_\-target\-\_\-phandle (
\begin{DoxyParamCaption}
\item[{const void $\ast$}]{fdto, }
\item[{int}]{fragment}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a1b77c6faf056e97fb21ed6c3b7d3ac6a}
overlay\-\_\-get\-\_\-target\-\_\-phandle -\/ retrieves the target phandle of a fragment \-: pointer to the device tree overlay blob \-: node offset of the fragment in the overlay

\hyperlink{fdt__overlay_8c_a1b77c6faf056e97fb21ed6c3b7d3ac6a}{overlay\-\_\-get\-\_\-target\-\_\-phandle()} retrieves the target phandle of an overlay fragment when that fragment uses a phandle (target property) instead of a path (target-\/path property).

returns\-: the phandle pointed by the target property 0, if the phandle was not found -\/1, if the phandle was malformed 

References fdt32\-\_\-to\-\_\-cpu(), and fdt\-\_\-getprop().



Referenced by fdt\-\_\-overlay\-\_\-target\-\_\-offset().


\begin{DoxyCode}
29 \{
30     \textcolor{keyword}{const} \hyperlink{libfdt__env_8h_a76887ac8786252752fb3f9a39b21f3af}{fdt32\_t} *val;
31     \textcolor{keywordtype}{int} \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len};
32 
33     val = \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdto, fragment, \textcolor{stringliteral}{"target"}, &len);
34     \textcolor{keywordflow}{if} (!val)
35         \textcolor{keywordflow}{return} 0;
36 
37     \textcolor{keywordflow}{if} ((len != \textcolor{keyword}{sizeof}(*val)) || (\hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(*val) == (\hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t})-1))
38         \textcolor{keywordflow}{return} (\hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t})-1;
39 
40     \textcolor{keywordflow}{return} \hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(*val);
41 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a36a905f6566751e42d0a0111b2d78a67}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-merge@{overlay\-\_\-merge}}
\index{overlay\-\_\-merge@{overlay\-\_\-merge}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-merge}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-merge (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{void $\ast$}]{fdto}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a36a905f6566751e42d0a0111b2d78a67}
overlay\-\_\-merge -\/ Merge an overlay into its base device tree \-: Base Device Tree blob \-: Device tree overlay blob

\hyperlink{fdt__overlay_8c_a36a905f6566751e42d0a0111b2d78a67}{overlay\-\_\-merge()} merges an overlay into its base device tree.

This is the next to last step in the device tree overlay application process, when all the phandles have been adjusted and resolved and you just have to merge overlay into the base device tree.

returns\-: 0 on success Negative error code on failure 

References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-for\-\_\-each\-\_\-subnode, fdt\-\_\-overlay\-\_\-target\-\_\-offset(), fdt\-\_\-subnode\-\_\-offset(), N\-U\-L\-L, and overlay\-\_\-apply\-\_\-node().



Referenced by fdt\-\_\-overlay\-\_\-apply().


\begin{DoxyCode}
605 \{
606     \textcolor{keywordtype}{int} fragment;
607 
608     \hyperlink{libfdt_8h_a7815aea6a1994b5fb035623a86e890a4}{fdt\_for\_each\_subnode}(fragment, fdto, 0) \{
609         \textcolor{keywordtype}{int} overlay;
610         \textcolor{keywordtype}{int} target;
611         \textcolor{keywordtype}{int} ret;
612 
613         \textcolor{comment}{/*}
614 \textcolor{comment}{         * Each fragments will have an \_\_overlay\_\_ node. If}
615 \textcolor{comment}{         * they don't, it's not supposed to be merged}
616 \textcolor{comment}{         */}
617         overlay = \hyperlink{fdt__ro_8c_a22dd90f8bea25063fe0debae7683eb02}{fdt\_subnode\_offset}(fdto, fragment, \textcolor{stringliteral}{"\_\_overlay\_\_"});
618         \textcolor{keywordflow}{if} (overlay == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
619             \textcolor{keywordflow}{continue};
620 
621         \textcolor{keywordflow}{if} (overlay < 0)
622             \textcolor{keywordflow}{return} overlay;
623 
624         target = \hyperlink{fdt__overlay_8c_aa155e9207e65bc6c432c40e301485af5}{fdt\_overlay\_target\_offset}(fdt, fdto, fragment, 
      \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
625         \textcolor{keywordflow}{if} (target < 0)
626             \textcolor{keywordflow}{return} target;
627 
628         ret = \hyperlink{fdt__overlay_8c_a8cb95c9322e1e68282eda3e7fc90a314}{overlay\_apply\_node}(fdt, target, fdto, overlay);
629         \textcolor{keywordflow}{if} (ret)
630             \textcolor{keywordflow}{return} ret;
631     \}
632 
633     \textcolor{keywordflow}{return} 0;
634 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a6b1ddbc5c439ce0876f35907174284d8}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-phandle\-\_\-add\-\_\-offset@{overlay\-\_\-phandle\-\_\-add\-\_\-offset}}
\index{overlay\-\_\-phandle\-\_\-add\-\_\-offset@{overlay\-\_\-phandle\-\_\-add\-\_\-offset}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-phandle\-\_\-add\-\_\-offset}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-phandle\-\_\-add\-\_\-offset (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{int}]{node, }
\item[{const char $\ast$}]{name, }
\item[{{\bf uint32\-\_\-t}}]{delta}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a6b1ddbc5c439ce0876f35907174284d8}


References fdt32\-\_\-to\-\_\-cpu(), F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-P\-H\-A\-N\-D\-L\-E, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-P\-H\-A\-N\-D\-L\-E\-S, fdt\-\_\-getprop(), and fdt\-\_\-setprop\-\_\-inplace\-\_\-u32().



Referenced by overlay\-\_\-adjust\-\_\-node\-\_\-phandles().


\begin{DoxyCode}
103 \{
104     \textcolor{keyword}{const} \hyperlink{libfdt__env_8h_a76887ac8786252752fb3f9a39b21f3af}{fdt32\_t} *val;
105     \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} adj\_val;
106     \textcolor{keywordtype}{int} \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len};
107 
108     val = \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdt, node, name, &len);
109     \textcolor{keywordflow}{if} (!val)
110         \textcolor{keywordflow}{return} \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len};
111 
112     \textcolor{keywordflow}{if} (len != \textcolor{keyword}{sizeof}(*val))
113         \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a0f264f8ba8cc4e98852c8246bc6312bc}{FDT\_ERR\_BADPHANDLE};
114 
115     adj\_val = \hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(*val);
116     \textcolor{keywordflow}{if} ((adj\_val + delta) < adj\_val)
117         \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a7dbda231b96112ab9cd6d2eca9b42bfb}{FDT\_ERR\_NOPHANDLES};
118 
119     adj\_val += delta;
120     \textcolor{keywordflow}{if} (adj\_val == (\hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t})-1)
121         \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a7dbda231b96112ab9cd6d2eca9b42bfb}{FDT\_ERR\_NOPHANDLES};
122 
123     \textcolor{keywordflow}{return} \hyperlink{libfdt_8h_aa0ff5bdd0d38a77ffe25261c971d29a3}{fdt\_setprop\_inplace\_u32}(fdt, node, name, adj\_val);
124 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_add76bc4fa1b36b1c11bfd9a2cf779ac1}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-symbol\-\_\-update@{overlay\-\_\-symbol\-\_\-update}}
\index{overlay\-\_\-symbol\-\_\-update@{overlay\-\_\-symbol\-\_\-update}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-symbol\-\_\-update}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-symbol\-\_\-update (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{void $\ast$}]{fdto}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_add76bc4fa1b36b1c11bfd9a2cf779ac1}
overlay\-\_\-symbol\-\_\-update -\/ Update the symbols of base tree after a merge \-: Base Device Tree blob \-: Device tree overlay blob

\hyperlink{fdt__overlay_8c_add76bc4fa1b36b1c11bfd9a2cf779ac1}{overlay\-\_\-symbol\-\_\-update()} updates the symbols of the base tree with the symbols of the applied overlay

This is the last step in the device tree overlay application process, allowing the reference of overlay symbols by subsequent overlay operations.

returns\-: 0 on success Negative error code on failure 

References fdt\-\_\-add\-\_\-subnode(), F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-O\-V\-E\-R\-L\-A\-Y, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-V\-A\-L\-U\-E, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-for\-\_\-each\-\_\-property\-\_\-offset, fdt\-\_\-get\-\_\-path(), fdt\-\_\-getprop\-\_\-by\-\_\-offset(), fdt\-\_\-overlay\-\_\-target\-\_\-offset(), fdt\-\_\-setprop\-\_\-placeholder(), fdt\-\_\-subnode\-\_\-offset(), fdt\-\_\-subnode\-\_\-offset\-\_\-namelen(), get\-\_\-path\-\_\-len(), memchr(), memcmp(), memcpy(), strchr(), and strlen().



Referenced by fdt\-\_\-overlay\-\_\-apply().


\begin{DoxyCode}
681 \{
682     \textcolor{keywordtype}{int} root\_sym, ov\_sym, prop, path\_len, fragment, target;
683     \textcolor{keywordtype}{int} \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len}, frag\_name\_len, ret, rel\_path\_len;
684     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *s, *e;
685     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *path;
686     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name;
687     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *frag\_name;
688     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *rel\_path;
689     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *target\_path;
690     \textcolor{keywordtype}{char} *buf;
691     \textcolor{keywordtype}{void} *p;
692 
693     ov\_sym = \hyperlink{fdt__ro_8c_a22dd90f8bea25063fe0debae7683eb02}{fdt\_subnode\_offset}(fdto, 0, \textcolor{stringliteral}{"\_\_symbols\_\_"});
694 
695     \textcolor{comment}{/* if no overlay symbols exist no problem */}
696     \textcolor{keywordflow}{if} (ov\_sym < 0)
697         \textcolor{keywordflow}{return} 0;
698 
699     root\_sym = \hyperlink{fdt__ro_8c_a22dd90f8bea25063fe0debae7683eb02}{fdt\_subnode\_offset}(fdt, 0, \textcolor{stringliteral}{"\_\_symbols\_\_"});
700 
701     \textcolor{comment}{/* it no root symbols exist we should create them */}
702     \textcolor{keywordflow}{if} (root\_sym == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
703         root\_sym = \hyperlink{fdt__rw_8c_a006872c92462f1a3c962192df483600c}{fdt\_add\_subnode}(fdt, 0, \textcolor{stringliteral}{"\_\_symbols\_\_"});
704 
705     \textcolor{comment}{/* any error is fatal now */}
706     \textcolor{keywordflow}{if} (root\_sym < 0)
707         \textcolor{keywordflow}{return} root\_sym;
708 
709     \textcolor{comment}{/* iterate over each overlay symbol */}
710     \hyperlink{libfdt_8h_ad994c33538d83be1383d449ed336803a}{fdt\_for\_each\_property\_offset}(prop, fdto, ov\_sym) \{
711         path = \hyperlink{fdt__ro_8c_a631207472dcddda9470f5791260da0fd}{fdt\_getprop\_by\_offset}(fdto, prop, &name, &path\_len);
712         \textcolor{keywordflow}{if} (!path)
713             \textcolor{keywordflow}{return} path\_len;
714 
715         \textcolor{comment}{/* verify it's a string property (terminated by a single \(\backslash\)0) */}
716         \textcolor{keywordflow}{if} (path\_len < 1 || \hyperlink{cstd_8c_a7a1a96cef371f847b925fb1478e04080}{memchr}(path, \textcolor{charliteral}{'\(\backslash\)0'}, path\_len) != &path[path\_len - 1])
717             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a69e818556330b83a02de930b95216aa9}{FDT\_ERR\_BADVALUE};
718 
719         \textcolor{comment}{/* keep end marker to avoid strlen() */}
720         e = path + path\_len;
721 
722         \textcolor{keywordflow}{if} (*path != \textcolor{charliteral}{'/'})
723             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_a69e818556330b83a02de930b95216aa9}{FDT\_ERR\_BADVALUE};
724 
725         \textcolor{comment}{/* get fragment name first */}
726         s = \hyperlink{cstd_8c_a12871ed234858ef0e363d2b8aa572fc1}{strchr}(path + 1, \textcolor{charliteral}{'/'});
727         \textcolor{keywordflow}{if} (!s) \{
728             \textcolor{comment}{/* Symbol refers to something that won't end}
729 \textcolor{comment}{             * up in the target tree */}
730             \textcolor{keywordflow}{continue};
731         \}
732 
733         frag\_name = path + 1;
734         frag\_name\_len = s - path - 1;
735 
736         \textcolor{comment}{/* verify format; safe since "s" lies in \(\backslash\)0 terminated prop */}
737         len = \textcolor{keyword}{sizeof}(\textcolor{stringliteral}{"/\_\_overlay\_\_/"}) - 1;
738         \textcolor{keywordflow}{if} ((e - s) > len && (\hyperlink{cstd_8c_ace6c4869ab3af01c6f27eac47773917a}{memcmp}(s, \textcolor{stringliteral}{"/\_\_overlay\_\_/"}, len) == 0)) \{
739             \textcolor{comment}{/* /<fragment-name>/\_\_overlay\_\_/<relative-subnode-path> */}
740             rel\_path = s + \hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len};
741             rel\_path\_len = e - rel\_path - 1;
742         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((e - s) == len
743                && (\hyperlink{cstd_8c_ace6c4869ab3af01c6f27eac47773917a}{memcmp}(s, \textcolor{stringliteral}{"/\_\_overlay\_\_"}, len - 1) == 0)) \{
744             \textcolor{comment}{/* /<fragment-name>/\_\_overlay\_\_ */}
745             rel\_path = \textcolor{stringliteral}{""};
746             rel\_path\_len = 0;
747         \} \textcolor{keywordflow}{else} \{
748             \textcolor{comment}{/* Symbol refers to something that won't end}
749 \textcolor{comment}{             * up in the target tree */}
750             \textcolor{keywordflow}{continue};
751         \}
752 
753         \textcolor{comment}{/* find the fragment index in which the symbol lies */}
754         ret = \hyperlink{fdt__ro_8c_a515ddadab660b50e9d31c05c74f7d351}{fdt\_subnode\_offset\_namelen}(fdto, 0, frag\_name,
755                            frag\_name\_len);
756         \textcolor{comment}{/* not found? */}
757         \textcolor{keywordflow}{if} (ret < 0)
758             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
759         fragment = ret;
760 
761         \textcolor{comment}{/* an \_\_overlay\_\_ subnode must exist */}
762         ret = \hyperlink{fdt__ro_8c_a22dd90f8bea25063fe0debae7683eb02}{fdt\_subnode\_offset}(fdto, fragment, \textcolor{stringliteral}{"\_\_overlay\_\_"});
763         \textcolor{keywordflow}{if} (ret < 0)
764             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
765 
766         \textcolor{comment}{/* get the target of the fragment */}
767         ret = \hyperlink{fdt__overlay_8c_aa155e9207e65bc6c432c40e301485af5}{fdt\_overlay\_target\_offset}(fdt, fdto, fragment, &target\_path);
768         \textcolor{keywordflow}{if} (ret < 0)
769             \textcolor{keywordflow}{return} ret;
770         target = ret;
771 
772         \textcolor{comment}{/* if we have a target path use */}
773         \textcolor{keywordflow}{if} (!target\_path) \{
774             ret = \hyperlink{fdt__overlay_8c_ac3e9264fbe6e8ef97f2378ead11a2fd0}{get\_path\_len}(fdt, target);
775             \textcolor{keywordflow}{if} (ret < 0)
776                 \textcolor{keywordflow}{return} ret;
777             len = ret;
778         \} \textcolor{keywordflow}{else} \{
779             len = \hyperlink{cstd_8c_a54684bded3e61e2d78d490650f9b706a}{strlen}(target\_path);
780         \}
781 
782         ret = \hyperlink{fdt__rw_8c_a77ab6d302e50d04e373b0371ac56cc9a}{fdt\_setprop\_placeholder}(fdt, root\_sym, name,
783                 len + (len > 1) + rel\_path\_len + 1, &p);
784         \textcolor{keywordflow}{if} (ret < 0)
785             \textcolor{keywordflow}{return} ret;
786 
787         \textcolor{keywordflow}{if} (!target\_path) \{
788             \textcolor{comment}{/* again in case setprop\_placeholder changed it */}
789             ret = \hyperlink{fdt__overlay_8c_aa155e9207e65bc6c432c40e301485af5}{fdt\_overlay\_target\_offset}(fdt, fdto, fragment, &target\_path);
790             \textcolor{keywordflow}{if} (ret < 0)
791                 \textcolor{keywordflow}{return} ret;
792             target = ret;
793         \}
794 
795         buf = p;
796         \textcolor{keywordflow}{if} (len > 1) \{ \textcolor{comment}{/* target is not root */}
797             \textcolor{keywordflow}{if} (!target\_path) \{
798                 ret = \hyperlink{fdt__ro_8c_a7b25d4bc3dd83403a39ef84b8a362bd5}{fdt\_get\_path}(fdt, target, buf, len + 1);
799                 \textcolor{keywordflow}{if} (ret < 0)
800                     \textcolor{keywordflow}{return} ret;
801             \} \textcolor{keywordflow}{else}
802                 \hyperlink{cstd_8c_a40deeb5b928964e60d97b3b8fd8a9b33}{memcpy}(buf, target\_path, len + 1);
803 
804         \} \textcolor{keywordflow}{else}
805             len--;
806 
807         buf[\hyperlink{structfdt__property_a48e6236319453578c3ca7c106b382a2f}{len}] = \textcolor{charliteral}{'/'};
808         \hyperlink{cstd_8c_a40deeb5b928964e60d97b3b8fd8a9b33}{memcpy}(buf + len + 1, rel\_path, rel\_path\_len);
809         buf[len + 1 + rel\_path\_len] = \textcolor{charliteral}{'\(\backslash\)0'};
810     \}
811 
812     \textcolor{keywordflow}{return} 0;
813 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a385dd43636a52dc96596827f51511419}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references@{overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references}}
\index{overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references@{overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdto, }
\item[{int}]{tree\-\_\-node, }
\item[{int}]{fixup\-\_\-node, }
\item[{{\bf uint32\-\_\-t}}]{delta}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a385dd43636a52dc96596827f51511419}
overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references -\/ Adjust the overlay references \-: Device tree overlay blob \-: Node offset of the node to operate on \-: Node offset of the matching local fixups node \-: Offset to shift the phandles of

overlay\-\_\-update\-\_\-local\-\_\-nodes\-\_\-references() update the phandles pointing to a node within the device tree overlay by adding a constant delta.

This is mainly used as part of a device tree application process, where you want the device tree overlays phandles to not conflict with the ones from the base device tree before merging them.

returns\-: 0 on success Negative error code on failure 

References cpu\-\_\-to\-\_\-fdt32(), fdt32\-\_\-to\-\_\-cpu(), F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-B\-A\-D\-O\-V\-E\-R\-L\-A\-Y, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-S\-P\-A\-C\-E, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-for\-\_\-each\-\_\-property\-\_\-offset, fdt\-\_\-for\-\_\-each\-\_\-subnode, fdt\-\_\-get\-\_\-name(), fdt\-\_\-getprop(), fdt\-\_\-getprop\-\_\-by\-\_\-offset(), fdt\-\_\-setprop\-\_\-inplace\-\_\-namelen\-\_\-partial(), fdt\-\_\-subnode\-\_\-offset(), memcpy(), N\-U\-L\-L, and strlen().



Referenced by overlay\-\_\-update\-\_\-local\-\_\-references().


\begin{DoxyCode}
209 \{
210     \textcolor{keywordtype}{int} fixup\_prop;
211     \textcolor{keywordtype}{int} fixup\_child;
212     \textcolor{keywordtype}{int} ret;
213 
214     \hyperlink{libfdt_8h_ad994c33538d83be1383d449ed336803a}{fdt\_for\_each\_property\_offset}(fixup\_prop, fdto, fixup\_node) \{
215         \textcolor{keyword}{const} \hyperlink{libfdt__env_8h_a76887ac8786252752fb3f9a39b21f3af}{fdt32\_t} *fixup\_val;
216         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *tree\_val;
217         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *name;
218         \textcolor{keywordtype}{int} fixup\_len;
219         \textcolor{keywordtype}{int} tree\_len;
220         \textcolor{keywordtype}{int} i;
221 
222         fixup\_val = \hyperlink{fdt__ro_8c_a631207472dcddda9470f5791260da0fd}{fdt\_getprop\_by\_offset}(fdto, fixup\_prop,
223                           &name, &fixup\_len);
224         \textcolor{keywordflow}{if} (!fixup\_val)
225             \textcolor{keywordflow}{return} fixup\_len;
226 
227         \textcolor{keywordflow}{if} (fixup\_len % \textcolor{keyword}{sizeof}(\hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}))
228             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
229         fixup\_len /= \textcolor{keyword}{sizeof}(\hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t});
230 
231         tree\_val = \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdto, tree\_node, name, &tree\_len);
232         \textcolor{keywordflow}{if} (!tree\_val) \{
233             \textcolor{keywordflow}{if} (tree\_len == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
234                 \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
235 
236             \textcolor{keywordflow}{return} tree\_len;
237         \}
238 
239         \textcolor{keywordflow}{for} (i = 0; i < fixup\_len; i++) \{
240             \hyperlink{libfdt__env_8h_a76887ac8786252752fb3f9a39b21f3af}{fdt32\_t} adj\_val;
241             \hyperlink{libfdt__env_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} poffset;
242 
243             poffset = \hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(fixup\_val[i]);
244 
245             \textcolor{comment}{/*}
246 \textcolor{comment}{             * phandles to fixup can be unaligned.}
247 \textcolor{comment}{             *}
248 \textcolor{comment}{             * Use a memcpy for the architectures that do}
249 \textcolor{comment}{             * not support unaligned accesses.}
250 \textcolor{comment}{             */}
251             \hyperlink{cstd_8c_a40deeb5b928964e60d97b3b8fd8a9b33}{memcpy}((\textcolor{keywordtype}{char}*) &adj\_val, tree\_val + poffset, \textcolor{keyword}{sizeof}(adj\_val));
252 
253             adj\_val = \hyperlink{libfdt__env_8h_a06ce41f441b8a56710000af3c3e516e5}{cpu\_to\_fdt32}(\hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(adj\_val) + delta);
254 
255             ret = \hyperlink{fdt__wip_8c_ad2d3b0ed8c78b7ca920550656dca6cf9}{fdt\_setprop\_inplace\_namelen\_partial}(fdto,
256                                   tree\_node,
257                                   name,
258                                   \hyperlink{cstd_8c_a54684bded3e61e2d78d490650f9b706a}{strlen}(name),
259                                   poffset,
260                                   &adj\_val,
261                                   \textcolor{keyword}{sizeof}(adj\_val));
262             \textcolor{keywordflow}{if} (ret == -\hyperlink{libfdt_8h_a149fb54f14ba915a78319a9570e4eae3}{FDT\_ERR\_NOSPACE})
263                 \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
264 
265             \textcolor{keywordflow}{if} (ret)
266                 \textcolor{keywordflow}{return} ret;
267         \}
268     \}
269 
270     \hyperlink{libfdt_8h_a7815aea6a1994b5fb035623a86e890a4}{fdt\_for\_each\_subnode}(fixup\_child, fdto, fixup\_node) \{
271         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *fixup\_child\_name = \hyperlink{fdt__ro_8c_a22a72941a288c00c88c36164fdc793c0}{fdt\_get\_name}(fdto, fixup\_child,
272                                 \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
273         \textcolor{keywordtype}{int} tree\_child;
274 
275         tree\_child = \hyperlink{fdt__ro_8c_a22dd90f8bea25063fe0debae7683eb02}{fdt\_subnode\_offset}(fdto, tree\_node,
276                         fixup\_child\_name);
277         \textcolor{keywordflow}{if} (tree\_child == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
278             \textcolor{keywordflow}{return} -\hyperlink{libfdt_8h_aa276d7f3088179b283530d41750ff5e4}{FDT\_ERR\_BADOVERLAY};
279         \textcolor{keywordflow}{if} (tree\_child < 0)
280             \textcolor{keywordflow}{return} tree\_child;
281 
282         ret = \hyperlink{fdt__overlay_8c_a385dd43636a52dc96596827f51511419}{overlay\_update\_local\_node\_references}(fdto,
283                                tree\_child,
284                                fixup\_child,
285                                delta);
286         \textcolor{keywordflow}{if} (ret)
287             \textcolor{keywordflow}{return} ret;
288     \}
289 
290     \textcolor{keywordflow}{return} 0;
291 \}
\end{DoxyCode}
\hypertarget{fdt__overlay_8c_a1c4ea38de65ffacb7708dd7641914a34}{\index{fdt\-\_\-overlay.\-c@{fdt\-\_\-overlay.\-c}!overlay\-\_\-update\-\_\-local\-\_\-references@{overlay\-\_\-update\-\_\-local\-\_\-references}}
\index{overlay\-\_\-update\-\_\-local\-\_\-references@{overlay\-\_\-update\-\_\-local\-\_\-references}!fdt_overlay.c@{fdt\-\_\-overlay.\-c}}
\subsubsection[{overlay\-\_\-update\-\_\-local\-\_\-references}]{\setlength{\rightskip}{0pt plus 5cm}static int overlay\-\_\-update\-\_\-local\-\_\-references (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdto, }
\item[{{\bf uint32\-\_\-t}}]{delta}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{fdt__overlay_8c_a1c4ea38de65ffacb7708dd7641914a34}
overlay\-\_\-update\-\_\-local\-\_\-references -\/ Adjust the overlay references \-: Device tree overlay blob \-: Offset to shift the phandles of

\hyperlink{fdt__overlay_8c_a1c4ea38de65ffacb7708dd7641914a34}{overlay\-\_\-update\-\_\-local\-\_\-references()} update all the phandles pointing to a node within the device tree overlay by adding a constant delta to not conflict with the base overlay.

This is mainly used as part of a device tree application process, where you want the device tree overlays phandles to not conflict with the ones from the base device tree before merging them.

returns\-: 0 on success Negative error code on failure 

References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-path\-\_\-offset(), and overlay\-\_\-update\-\_\-local\-\_\-node\-\_\-references().



Referenced by fdt\-\_\-overlay\-\_\-apply().


\begin{DoxyCode}
311 \{
312     \textcolor{keywordtype}{int} fixups;
313 
314     fixups = \hyperlink{fdt__ro_8c_a222c01ef0a514a4cf7586f6de8b17072}{fdt\_path\_offset}(fdto, \textcolor{stringliteral}{"/\_\_local\_fixups\_\_"});
315     \textcolor{keywordflow}{if} (fixups < 0) \{
316         \textcolor{comment}{/* There's no local phandles to adjust, bail out */}
317         \textcolor{keywordflow}{if} (fixups == -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND})
318             \textcolor{keywordflow}{return} 0;
319 
320         \textcolor{keywordflow}{return} fixups;
321     \}
322 
323     \textcolor{comment}{/*}
324 \textcolor{comment}{     * Update our local references from the root of the tree}
325 \textcolor{comment}{     */}
326     \textcolor{keywordflow}{return} \hyperlink{fdt__overlay_8c_a385dd43636a52dc96596827f51511419}{overlay\_update\_local\_node\_references}(fdto, 0, fixups,
327                             delta);
328 \}
\end{DoxyCode}
