\hypertarget{kmemory_8h}{\section{/users/enseig/franck/ko6/src/soft/kernel/kmemory.h File Reference}
\label{kmemory_8h}\index{/users/enseig/franck/ko6/src/soft/kernel/kmemory.\-h@{/users/enseig/franck/ko6/src/soft/kernel/kmemory.\-h}}
}
{\ttfamily \#include $<$common/usermem.\-h$>$}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{kmemory_8h_a34f25b1ca1556d0890274a971d46af10}{memory\-\_\-init} (void)
\begin{DoxyCompactList}\small\item\em initialize all the kernel memory allocators \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{kmemory_8h_a5f52d7c56b7d67dc2f96b2e93dfdc7be}{kmalloc} (size\-\_\-t size)
\begin{DoxyCompactList}\small\item\em allocate an object in the kernel address space \end{DoxyCompactList}\item 
void \hyperlink{kmemory_8h_a64c1f767a18f26f8c8cabd0f82f3e04d}{kfree} (void $\ast$obj, size\-\_\-t size)
\begin{DoxyCompactList}\small\item\em free an allocated object with \hyperlink{kmemory_8c_a5f52d7c56b7d67dc2f96b2e93dfdc7be}{kmalloc()} \end{DoxyCompactList}\item 
void \hyperlink{kmemory_8h_a71239547b3491efafadee92180ba2b02}{kmalloc\-\_\-print} (void)
\begin{DoxyCompactList}\small\item\em Print data about slab allocator usage. \end{DoxyCompactList}\item 
void \hyperlink{kmemory_8h_a6cfd6b96caef4efda19f082f3ef8cd2d}{kmalloc\-\_\-test} (size\-\_\-t turn, size\-\_\-t size)
\begin{DoxyCompactList}\small\item\em Test Slab alocator, allocates and frees as many values as 'turn' then free all test. \end{DoxyCompactList}\item 
int $\ast$ \hyperlink{kmemory_8h_a2ce77af8c704a7d3f2204f94750daedb}{malloc\-\_\-ustack} (void)
\begin{DoxyCompactList}\small\item\em allocate a new user stack \end{DoxyCompactList}\item 
void \hyperlink{kmemory_8h_afb66690ffe244c8c1901f4877b51a3c9}{free\-\_\-ustack} (int $\ast$stack)
\begin{DoxyCompactList}\small\item\em free a use stack \end{DoxyCompactList}\item 
void \hyperlink{kmemory_8h_ab85de89de0e4aa840b3d48ffe4f4d5e3}{print\-\_\-ustack} (void)
\begin{DoxyCompactList}\small\item\em print ustack state \end{DoxyCompactList}\item 
void \hyperlink{kmemory_8h_ad59a095064fc46b540321c14b65dab06}{test\-\_\-ustack} (size\-\_\-t turn)
\item 
void $\ast$ \hyperlink{kmemory_8h_ad3736b4c8c3376c224d8a70e39b1a017}{sbrk} (int increment)
\begin{DoxyCompactList}\small\item\em change the boundary of the heap \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{kmemory_8h_afb66690ffe244c8c1901f4877b51a3c9}{\index{kmemory.\-h@{kmemory.\-h}!free\-\_\-ustack@{free\-\_\-ustack}}
\index{free\-\_\-ustack@{free\-\_\-ustack}!kmemory.h@{kmemory.\-h}}
\subsubsection[{free\-\_\-ustack}]{\setlength{\rightskip}{0pt plus 5cm}void free\-\_\-ustack (
\begin{DoxyParamCaption}
\item[{int $\ast$}]{stack}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_afb66690ffe244c8c1901f4877b51a3c9}


free a use stack 


\begin{DoxyParams}{Parameters}
{\em stack} & is a pointer returned by kmalloc\-\_\-ustack \\
\hline
\end{DoxyParams}


References \-\_\-usermem, cmp\-\_\-addr(), list\-\_\-addsort(), list\-\_\-foreach, list\-\_\-getfirst(), M\-A\-G\-I\-C\-\_\-\-S\-T\-A\-C\-K, P\-A\-N\-I\-C\-\_\-\-I\-F, \-\_\-usermem\-\_\-s\-::ustack\-\_\-end, and U\-S\-T\-A\-C\-K\-\_\-\-S\-I\-Z\-E.



Referenced by test\-\_\-ustack().


\begin{DoxyCode}
265 \{
266     \textcolor{keywordtype}{int} * end = 1 + top - \hyperlink{usermem_8h_ad77d03e18a9477ef16ff8c4ae3c8b43d}{USTACK\_SIZE}/\textcolor{keyword}{sizeof}(int);          \textcolor{comment}{// last int of ustack (+1 because
       MAGIC)}
267     \hyperlink{debug__on_8h_a9dea4233af3c516959b7255fbea5c79b}{PANIC\_IF} (*top != \hyperlink{usermem_8h_a34ef3ea96595898f1452b49d29a1722a}{MAGIC\_STACK}, \textcolor{stringliteral}{"Corrupted top Stack"});  \textcolor{comment}{// if no magic number then
       panic}
268     \hyperlink{debug__on_8h_a9dea4233af3c516959b7255fbea5c79b}{PANIC\_IF} (*end != \hyperlink{usermem_8h_a34ef3ea96595898f1452b49d29a1722a}{MAGIC\_STACK}, \textcolor{stringliteral}{"Corrupted end Stack"});  \textcolor{comment}{// if no magic number then
       panic}
269 
270     \textcolor{keywordflow}{if} (end ==\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end}) \{                        \textcolor{comment}{// if it is the lowest stack}
271         \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end} += \hyperlink{usermem_8h_ad77d03e18a9477ef16ff8c4ae3c8b43d}{USTACK\_SIZE}/\textcolor{keyword}{sizeof}(int);     \textcolor{comment}{// shrink the
       stacks' region}
272         \hyperlink{list_8h_ad759a32561623ec6b31549db8276e8b6}{list\_foreach} (&\hyperlink{kmemory_8c_a0893d9ddd9d1a491788e16024697251e}{FreeUserStack}, stack) \{              \textcolor{comment}{// foreach free stack}
273             \textcolor{keywordflow}{if} ((\textcolor{keywordtype}{int} *)stack != \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end})        \textcolor{comment}{// if it isn't the end of
       stack region}
274                 \textcolor{keywordflow}{break};                                      \textcolor{comment}{// then stop trying to shrink}
275             end = (\textcolor{keywordtype}{int} *)\hyperlink{list_8h_a60162e4580a37bddf823ca73567011d8}{list\_getfirst} (&\hyperlink{kmemory_8c_a0893d9ddd9d1a491788e16024697251e}{FreeUserStack});    \textcolor{comment}{// extract the stack}
276             end += \hyperlink{usermem_8h_ad77d03e18a9477ef16ff8c4ae3c8b43d}{USTACK\_SIZE}/\textcolor{keyword}{sizeof}(int);                 \textcolor{comment}{// new end of stacks'region}
277             \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end} = end;                      \textcolor{comment}{// save this new end}
278         \}
279     \} \textcolor{keywordflow}{else}                                                  \textcolor{comment}{// else the freed stack isn't at the end}
280         \hyperlink{list_8h_a275c693c553662ccb0736089f2159b7d}{list\_addsort} (&\hyperlink{kmemory_8c_a0893d9ddd9d1a491788e16024697251e}{FreeUserStack},(\hyperlink{structlist__s}{list\_t}*)end,
      \hyperlink{kmemory_8c_ad548883c204308dc00349b98f839181b}{cmp\_addr});\textcolor{comment}{// add it in free list in order}
281 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_a64c1f767a18f26f8c8cabd0f82f3e04d}{\index{kmemory.\-h@{kmemory.\-h}!kfree@{kfree}}
\index{kfree@{kfree}!kmemory.h@{kmemory.\-h}}
\subsubsection[{kfree}]{\setlength{\rightskip}{0pt plus 5cm}void kfree (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{obj, }
\item[{size\-\_\-t}]{size}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_a64c1f767a18f26f8c8cabd0f82f3e04d}


free an allocated object with \hyperlink{kmemory_8c_a5f52d7c56b7d67dc2f96b2e93dfdc7be}{kmalloc()} 


\begin{DoxyParams}{Parameters}
{\em obj} & pointer to the allocated object \\
\hline
{\em size} & in bytes used for allocation \\
\hline
\end{DoxyParams}


References kmb, list\-\_\-addfirst(), list\-\_\-foreach, list\-\_\-unlink(), Max\-Line\-Page, N\-B\-L\-I\-N\-E, Nb\-Pages, Objects\-This\-Size, P\-A\-G\-E\-\_\-\-S\-I\-Z\-E, P\-A\-N\-I\-C\-\_\-\-I\-F, and page\-\_\-s\-::slab.



Referenced by dev\-\_\-free(), kmalloc\-\_\-test(), thread\-\_\-barrier\-\_\-destroy(), and thread\-\_\-mutex\-\_\-destroy().


\begin{DoxyCode}
133 \{
134     \textcolor{keywordtype}{size\_t} nbline= \hyperlink{kmemory_8c_a85a54e9787a16befde04a79fb6b83d96}{NBLINE}(size) % \hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage};              \textcolor{comment}{// which slab to use}
135     \textcolor{keywordtype}{size\_t} npage = (size\_t)(obj - (\textcolor{keywordtype}{void} *)\hyperlink{kmemory_8c_a5ca59e07ccac5f97fd636413b47818e9}{kmb})>>12;         \textcolor{comment}{// relative page number from kmb}
136 
137     \hyperlink{debug__on_8h_a9dea4233af3c516959b7255fbea5c79b}{PANIC\_IF} ((nbline>255)||(npage >= \hyperlink{kmemory_8c_a4c7f2ce6c58dbea9f3f45c967f370a4a}{NbPages}),             \textcolor{comment}{// too big or outside of the
       region}
138         \textcolor{stringliteral}{"\(\backslash\)ncan't free object not allocated by kmalloc()"});  \textcolor{comment}{// write a message then panic}
139 
140     \hyperlink{list_8h_ae9cb164fa78a37279635deb1a926a092}{list\_addfirst} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[nbline], (\hyperlink{structlist__s}{list\_t} *)obj);           \textcolor{comment}{// add it to the right
       free list}
141     \hyperlink{kmemory_8c_af2258d5c2be05af348af68e9e588a06a}{ObjectsThisSize}[nbline]--;                              \textcolor{comment}{// decr the number of obj of
       size nbline}
142     \textcolor{keywordflow}{if} (size == \hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE}) \textcolor{keywordflow}{return};
143     \textcolor{keywordflow}{if} (--\hyperlink{kmemory_8c_ad3e3a67efeec7e5535c5f05360111d34}{Page}[npage].alloc==0) \{                           \textcolor{comment}{// splitted page and no more object left}
144         \hyperlink{structlist__s}{list\_t} *page = (\hyperlink{structlist__s}{list\_t} *)((\textcolor{keywordtype}{size\_t})obj & ~0xFFF);    \textcolor{comment}{// address of the page containing
       obj}
145         \hyperlink{list_8h_ad759a32561623ec6b31549db8276e8b6}{list\_foreach} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[nbline], item) \{                \textcolor{comment}{// browse all item in free list}
146             \textcolor{keywordtype}{size\_t} np\_item = (size\_t)((\textcolor{keywordtype}{char}*)item-\hyperlink{kmemory_8c_a5ca59e07ccac5f97fd636413b47818e9}{kmb})>>12; \textcolor{comment}{// page number Page[] table}
147             \textcolor{keywordflow}{if} (np\_item == npage) \{                         \textcolor{comment}{// if current item is in the page}
148                 \hyperlink{list_8h_ac68d25438cd5f3cc2e5b04dbf174bf27}{list\_unlink} (item);                         \textcolor{comment}{// unlink it}
149             \}
150         \}
151         \hyperlink{kmemory_8c_ad3e3a67efeec7e5535c5f05360111d34}{Page}[npage].\hyperlink{structpage__s_a32a24096972b27d87a55051df616ae99}{slab} = 0;                               \textcolor{comment}{// since the page is empty, thus slab 0}
152         \hyperlink{list_8h_ae9cb164fa78a37279635deb1a926a092}{list\_addfirst} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[0], (\hyperlink{structlist__s}{list\_t} *)page);           \textcolor{comment}{// add the free page in
       slab[O]}
153         \hyperlink{kmemory_8c_af2258d5c2be05af348af68e9e588a06a}{ObjectsThisSize}[0]--;                               \textcolor{comment}{// decr the number of pages used}
154     \}
155 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_a5f52d7c56b7d67dc2f96b2e93dfdc7be}{\index{kmemory.\-h@{kmemory.\-h}!kmalloc@{kmalloc}}
\index{kmalloc@{kmalloc}!kmemory.h@{kmemory.\-h}}
\subsubsection[{kmalloc}]{\setlength{\rightskip}{0pt plus 5cm}void$\ast$ kmalloc (
\begin{DoxyParamCaption}
\item[{size\-\_\-t}]{size}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_a5f52d7c56b7d67dc2f96b2e93dfdc7be}


allocate an object in the kernel address space 


\begin{DoxyParams}{Parameters}
{\em size} & in bytes (must be at most a P\-A\-G\-E S\-I\-Z\-E) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
a pointer to an object with at least \char`\"{}size\char`\"{} byte size It is rounded up to a whole number of cache lines. 
\end{DoxyReturn}


References page\-\_\-s\-::alloc, Cache\-Line\-Size, kmalloc(), kmb, list\-\_\-addlast(), list\-\_\-getfirst(), list\-\_\-isempty(), Max\-Line\-Page, N\-B\-L\-I\-N\-E, Objects\-This\-Size, P\-A\-G\-E\-\_\-\-S\-I\-Z\-E, P\-A\-N\-I\-C\-\_\-\-I\-F, page\-\_\-s\-::slab, and wzero().



Referenced by dev\-\_\-alloc(), kmalloc(), kmalloc\-\_\-test(), memory\-\_\-init(), ns16550\-\_\-init(), soclib\-\_\-tty\-\_\-init(), thread\-\_\-barrier\-\_\-init(), thread\-\_\-create(), and thread\-\_\-mutex\-\_\-init().


\begin{DoxyCode}
106 \{
107     \hyperlink{debug__on_8h_a9dea4233af3c516959b7255fbea5c79b}{PANIC\_IF} (size > \hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE},                             \textcolor{comment}{// kmalloc is for small object}
108         \textcolor{stringliteral}{"%d is too big, more than a single page"}, size);    \textcolor{comment}{// write a message then panic}
109     \hyperlink{debug__on_8h_a9dea4233af3c516959b7255fbea5c79b}{PANIC\_IF} ((size==\hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE}) && \hyperlink{list_8h_a7c9c3af38594b844dac34c6656bdd7a0}{list\_isempty} (&
      \hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[0]), \textcolor{comment}{// free page are listed in Slab[0]}
110         \textcolor{stringliteral}{"No more kernel data space"});                       \textcolor{comment}{// write a message then panic}
111 
112     \textcolor{keywordtype}{size\_t} nbline = \hyperlink{kmemory_8c_a85a54e9787a16befde04a79fb6b83d96}{NBLINE}(size);                           \textcolor{comment}{// required lines for size}
113     size = nbline * \hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize};                          \textcolor{comment}{// actual size asked}
114 
115     \textcolor{keywordflow}{if} ((size!=\hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE}) && \hyperlink{list_8h_a7c9c3af38594b844dac34c6656bdd7a0}{list\_isempty} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[nbline])) \{\textcolor{comment}{// if no more object
       in the slab}
116         \textcolor{keywordtype}{char} *page = \hyperlink{kmemory_8c_a5f52d7c56b7d67dc2f96b2e93dfdc7be}{kmalloc} (\hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE});                   \textcolor{comment}{// ask for a free page (i.e.
       slab)}
117         \textcolor{keywordtype}{size\_t} npage = (size\_t)(page - (\textcolor{keywordtype}{char} *)\hyperlink{kmemory_8c_a5ca59e07ccac5f97fd636413b47818e9}{kmb})>>12;    \textcolor{comment}{// relative page number from kmb}
118         \hyperlink{kmemory_8c_ad3e3a67efeec7e5535c5f05360111d34}{Page}[npage].\hyperlink{structpage__s_a1b4a61989804f75b7d857636e35c9c2f}{alloc} = 0;                              \textcolor{comment}{// reset the allocated counter}
119         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{char} *p=page; p+size<=page+\hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE}; p+=size) \textcolor{comment}{// cut the slab into objects}
120             \hyperlink{list_8h_a116cfa18214dd2f855cff842bb14ca8f}{list\_addlast} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[nbline], (\hyperlink{structlist__s}{list\_t} *)p);      \textcolor{comment}{// and chain them
       together}
121     \}
122     \textcolor{keywordtype}{void} * res = \hyperlink{list_8h_a60162e4580a37bddf823ca73567011d8}{list\_getfirst} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[nbline%\hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage}]); \textcolor{comment}{// res is the first
       object in list}
123     \textcolor{keywordtype}{size\_t} npage = (size\_t)(res - (\textcolor{keywordtype}{void} *)\hyperlink{kmemory_8c_a5ca59e07ccac5f97fd636413b47818e9}{kmb})>>12;         \textcolor{comment}{// relative page number from kmb}
124     \hyperlink{kmemory_8c_af2258d5c2be05af348af68e9e588a06a}{ObjectsThisSize}[nbline%\hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage}]++;                  \textcolor{comment}{// increment the
       number of objects}
125     \hyperlink{kmemory_8c_ad3e3a67efeec7e5535c5f05360111d34}{Page}[npage].\hyperlink{structpage__s_a32a24096972b27d87a55051df616ae99}{slab} = nbline%\hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage};                  \textcolor{comment}{// this page is used of slab
       of nbline}
126     \hyperlink{kmemory_8c_ad3e3a67efeec7e5535c5f05360111d34}{Page}[npage].\hyperlink{structpage__s_a1b4a61989804f75b7d857636e35c9c2f}{alloc}++;                                    \textcolor{comment}{// one more times}
127 
128     \hyperlink{cstd_8c_a00da14b6dfa98f18494ef149ce63457f}{wzero} (res, size);                                      \textcolor{comment}{// clear allocated memory}
129     \textcolor{keywordflow}{return} res;                                             \textcolor{comment}{// finally returns res}
130 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_a71239547b3491efafadee92180ba2b02}{\index{kmemory.\-h@{kmemory.\-h}!kmalloc\-\_\-print@{kmalloc\-\_\-print}}
\index{kmalloc\-\_\-print@{kmalloc\-\_\-print}!kmemory.h@{kmemory.\-h}}
\subsubsection[{kmalloc\-\_\-print}]{\setlength{\rightskip}{0pt plus 5cm}void kmalloc\-\_\-print (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_a71239547b3491efafadee92180ba2b02}


Print data about slab allocator usage. 


\begin{DoxyItemize}
\item for each open slab, tells the object size and how many free and allocated objects
\item for each page used, tells to which stab it belongs and how many objects are allocated in 
\end{DoxyItemize}

References page\-\_\-s\-::alloc, Cache\-Line\-Size, kprintf(), list\-\_\-nbobj(), Max\-Line\-Page, Nb\-Pages, Objects\-This\-Size, and page\-\_\-s\-::slab.



Referenced by kmalloc\-\_\-test().


\begin{DoxyCode}
160 \{
161     \textcolor{keywordtype}{size\_t} cr = 0, pr = 1;
162     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"\(\backslash\)nOpen Slab[] : Object Size ; Free Objects ; Allocated Objects\(\backslash\)n"});
163     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} nbline=0 ; nbline<\hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage} ; nbline++) \{ \textcolor{comment}{// for all slabs}
164         \textcolor{keywordtype}{size\_t} sz = (nbline)?nbline*\hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize}:4096;     \textcolor{comment}{// size really allocated}
165         \textcolor{keywordtype}{size\_t} nf = \hyperlink{list_8h_a70e2ae6a0a122175e967b0cd6b2affce}{list\_nbobj} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[nbline]);             \textcolor{comment}{// number of free obj of size
       nline}
166         \textcolor{keywordtype}{size\_t} na = \hyperlink{kmemory_8c_af2258d5c2be05af348af68e9e588a06a}{ObjectsThisSize}[nbline];                \textcolor{comment}{// number of allocated obj of
       size nline}
167         \textcolor{keywordflow}{if} (nf+na) \{                                        \textcolor{comment}{// if there is something to print}
168             \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"|s %d\(\backslash\)t f %d\(\backslash\)t a %d"}, sz, nf, na);    \textcolor{comment}{// print data}
169             \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} ((++cr%3)?\textcolor{stringliteral}{"\(\backslash\)t"}:\textcolor{stringliteral}{"\(\backslash\)t|\(\backslash\)n"});                \textcolor{comment}{// adds a \(\backslash\)n all three print}
170             pr=0;
171         \}
172     \}
173     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} ((cr+pr)?\textcolor{stringliteral}{"\(\backslash\)n"}:\textcolor{stringliteral}{""});                              \textcolor{comment}{// adds a \(\backslash\)n if not just added it}
174     cr = 0; pr = 1;
175     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"\(\backslash\)nUsed Memory Pages  : Slab Type (nb cache lines) ; Allocated Objects\(\backslash\)n"});
176     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} p = 0; p < \hyperlink{kmemory_8c_a4c7f2ce6c58dbea9f3f45c967f370a4a}{NbPages}; p++) \{                  \textcolor{comment}{// for all pages}
177         \textcolor{keywordtype}{size\_t} ps = \hyperlink{kmemory_8c_ad3e3a67efeec7e5535c5f05360111d34}{Page}[p].\hyperlink{structpage__s_a32a24096972b27d87a55051df616ae99}{slab};                           \textcolor{comment}{// for what slab[] it is used}
178         \textcolor{keywordtype}{size\_t} pa = \hyperlink{kmemory_8c_ad3e3a67efeec7e5535c5f05360111d34}{Page}[p].\hyperlink{structpage__s_a1b4a61989804f75b7d857636e35c9c2f}{alloc};                          \textcolor{comment}{// how many alloc objects there are in}
179         \textcolor{keywordflow}{if} (pa) \{                                           \textcolor{comment}{// if the page contain allocated object}
180             \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"|p %d\(\backslash\)t s %d\(\backslash\)t a %d"},p,ps,pa);        \textcolor{comment}{// print data}
181             \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} ((++cr%3)?\textcolor{stringliteral}{"\(\backslash\)t"}:\textcolor{stringliteral}{"\(\backslash\)t|\(\backslash\)n"});                \textcolor{comment}{// adds a \(\backslash\)n all three print}
182             pr=0;
183 
184         \}
185     \}
186     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} ((cr+pr)?\textcolor{stringliteral}{"\(\backslash\)n"}:\textcolor{stringliteral}{""});                              \textcolor{comment}{// adds a \(\backslash\)n if not just added it}
187 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_a6cfd6b96caef4efda19f082f3ef8cd2d}{\index{kmemory.\-h@{kmemory.\-h}!kmalloc\-\_\-test@{kmalloc\-\_\-test}}
\index{kmalloc\-\_\-test@{kmalloc\-\_\-test}!kmemory.h@{kmemory.\-h}}
\subsubsection[{kmalloc\-\_\-test}]{\setlength{\rightskip}{0pt plus 5cm}void kmalloc\-\_\-test (
\begin{DoxyParamCaption}
\item[{size\-\_\-t}]{turn, }
\item[{size\-\_\-t}]{size}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_a6cfd6b96caef4efda19f082f3ef8cd2d}


Test Slab alocator, allocates and frees as many values as 'turn' then free all test. 


\begin{DoxyParams}{Parameters}
{\em turn} & is the number of allocation or release are performed \\
\hline
{\em size} & is the maximum objects size (from 1 to P\-A\-G\-E\-\_\-\-S\-I\-Z\-E) \\
\hline
\end{DoxyParams}


References Cache\-Line\-Size, kfree(), kmalloc(), kmalloc\-\_\-print(), kprintf(), list\-\_\-addlast(), list\-\_\-foreach, list\-\_\-getfirst(), list\-\_\-init(), list\-\_\-unlink(), Max\-Line\-Page, N\-B\-L\-I\-N\-E, and rand().



Referenced by memory\-\_\-init().


\begin{DoxyCode}
191 \{
192     \hyperlink{structlist__s}{list\_t} *obj;                                            \textcolor{comment}{// object allocated or freed}
193     \textcolor{keywordflow}{if} (turn == 0) \textcolor{keywordflow}{return};                                  \textcolor{comment}{// if no turn forgive now}
194     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"kmalloc test %s turn %d size max %d\(\backslash\)n"},       \textcolor{comment}{// a small message}
195              \_\_func\_\_,turn,size);
196     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0 ; i < \hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage} ; i++)                 \textcolor{comment}{// nitialize KMallocTest}
197         \hyperlink{list_8h_a4988c174e6ecc55436d5f0e3dbbb3980}{list\_init} (&\hyperlink{kmemory_8c_adb163f59e8b9324e1de98021ca40ff92}{KMallocTest}[i]);                        \textcolor{comment}{// KMallocTest[i] ->
       i*cachelinesize}
198     \textcolor{keywordflow}{while} (turn--) \{                                        \textcolor{comment}{// the number of turn is configurable}
199         \textcolor{keywordtype}{int} sz = 1+(\hyperlink{klibc_8c_ae23144bcbb8e3742b00eb687c36654d1}{rand}()+\hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize}/2) % size;         \textcolor{comment}{// choose a size}
200         \textcolor{keywordtype}{size\_t} nbline = \hyperlink{kmemory_8c_a85a54e9787a16befde04a79fb6b83d96}{NBLINE}(sz);                         \textcolor{comment}{// required lines for size}
201         nbline %= \hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage};                              \textcolor{comment}{// if sz==PAGE\_SIZE use Slab[0]}
202         \textcolor{keywordflow}{if} (\hyperlink{klibc_8c_ae23144bcbb8e3742b00eb687c36654d1}{rand}()%2) \{                                     \textcolor{comment}{// alloc or free}
203             obj = \hyperlink{kmemory_8c_a5f52d7c56b7d67dc2f96b2e93dfdc7be}{kmalloc} (sz);                             \textcolor{comment}{// allocate a new object}
204             \hyperlink{list_8h_a116cfa18214dd2f855cff842bb14ca8f}{list\_addlast} (&\hyperlink{kmemory_8c_adb163f59e8b9324e1de98021ca40ff92}{KMallocTest}[nbline], obj);       \textcolor{comment}{// add it in allocated
       object}
205         \} \textcolor{keywordflow}{else} \{                                            \textcolor{comment}{// else}
206             obj = \hyperlink{list_8h_a60162e4580a37bddf823ca73567011d8}{list\_getfirst} (&\hyperlink{kmemory_8c_adb163f59e8b9324e1de98021ca40ff92}{KMallocTest}[nbline]);     \textcolor{comment}{// try to get a
       previously allocated obj}
207             \textcolor{keywordflow}{if} (obj) \hyperlink{kmemory_8c_a64c1f767a18f26f8c8cabd0f82f3e04d}{kfree} (obj, nbline*\hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize});     \textcolor{comment}{// on success, free it}
208         \}
209     \}
210     \hyperlink{kmemory_8c_a71239547b3491efafadee92180ba2b02}{kmalloc\_print}();                                        \textcolor{comment}{// Slab status after alloc/free
       series}
211     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0 ; i < \hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage} ; i++) \{               \textcolor{comment}{// for all list}
212         \hyperlink{list_8h_ad759a32561623ec6b31549db8276e8b6}{list\_foreach} (&\hyperlink{kmemory_8c_adb163f59e8b9324e1de98021ca40ff92}{KMallocTest}[i], item) \{              \textcolor{comment}{// browse allocated
       objects}
213             \hyperlink{list_8h_ac68d25438cd5f3cc2e5b04dbf174bf27}{list\_unlink} (item);                             \textcolor{comment}{// if found it, unlinked it}
214             \hyperlink{kmemory_8c_a64c1f767a18f26f8c8cabd0f82f3e04d}{kfree} (item,i*\hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize});                   \textcolor{comment}{// then free it}
215         \}
216     \}
217     \hyperlink{kmemory_8c_a71239547b3491efafadee92180ba2b02}{kmalloc\_print}();                                        \textcolor{comment}{// Slab status after total clean
       od test}
218 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_a2ce77af8c704a7d3f2204f94750daedb}{\index{kmemory.\-h@{kmemory.\-h}!malloc\-\_\-ustack@{malloc\-\_\-ustack}}
\index{malloc\-\_\-ustack@{malloc\-\_\-ustack}!kmemory.h@{kmemory.\-h}}
\subsubsection[{malloc\-\_\-ustack}]{\setlength{\rightskip}{0pt plus 5cm}int$\ast$ malloc\-\_\-ustack (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_a2ce77af8c704a7d3f2204f94750daedb}


allocate a new user stack 

\begin{DoxyReturn}{Returns}
a pointer to an empty stack (of S\-T\-A\-C\-K\-\_\-\-S\-I\-Z\-E bytes) The pointer is just above the new stack 
\end{DoxyReturn}


References \-\_\-usermem, list\-\_\-getlast(), M\-A\-G\-I\-C\-\_\-\-S\-T\-A\-C\-K, N\-U\-L\-L, P\-A\-N\-I\-C\-\_\-\-I\-F, \-\_\-usermem\-\_\-s\-::uheap\-\_\-end, \-\_\-usermem\-\_\-s\-::ustack\-\_\-end, and U\-S\-T\-A\-C\-K\-\_\-\-S\-I\-Z\-E.



Referenced by test\-\_\-ustack(), and thread\-\_\-create().


\begin{DoxyCode}
237 \{
238     \textcolor{keywordtype}{int} * top;                                              \textcolor{comment}{// top will be the new stack pointer}
239     \textcolor{keywordtype}{int} * end = (\textcolor{keywordtype}{int} *)\hyperlink{list_8h_ab32a1c2580ccc334bb07c024d8e0a9c2}{list\_getlast} (&\hyperlink{kmemory_8c_a0893d9ddd9d1a491788e16024697251e}{FreeUserStack});       \textcolor{comment}{// get last free stack
       (biggest addr)}
240     \textcolor{keywordflow}{if} (end == \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}) \{                                      \textcolor{comment}{// if there is no more free stack}
241         top = \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end};                          \textcolor{comment}{// try to get one}
242         end = top - \hyperlink{usermem_8h_ad77d03e18a9477ef16ff8c4ae3c8b43d}{USTACK\_SIZE}/\textcolor{keyword}{sizeof}(int);                \textcolor{comment}{// and compute the end of the stack}
243         \hyperlink{debug__on_8h_a9dea4233af3c516959b7255fbea5c79b}{PANIC\_IF} (end < \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_afc2d87db58cb56804172f98d124d3c05}{uheap\_end},                 \textcolor{comment}{// if the stack end is
       in the heap}
244             \textcolor{stringliteral}{"no more space for user stack!\(\backslash\)n"});             \textcolor{comment}{// it is impossible to solve that}
245         \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end} = end;                          \textcolor{comment}{// expand the stacks' region}
246     \} \textcolor{keywordflow}{else} \{
247         top = end + \hyperlink{usermem_8h_ad77d03e18a9477ef16ff8c4ae3c8b43d}{USTACK\_SIZE}/\textcolor{keyword}{sizeof}(int);                \textcolor{comment}{// compute stack's top from stack's
       end}
248     \}
249     top--;                                                  \textcolor{comment}{// get a word to put MAGIC}
250     *top = *end = \hyperlink{usermem_8h_a34ef3ea96595898f1452b49d29a1722a}{MAGIC\_STACK};                              \textcolor{comment}{// to be able to check free}
251     \textcolor{keywordflow}{return} top;                                             \textcolor{comment}{// finally return the top}
252 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_a34f25b1ca1556d0890274a971d46af10}{\index{kmemory.\-h@{kmemory.\-h}!memory\-\_\-init@{memory\-\_\-init}}
\index{memory\-\_\-init@{memory\-\_\-init}!kmemory.h@{kmemory.\-h}}
\subsubsection[{memory\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}void memory\-\_\-init (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_a34f25b1ca1556d0890274a971d46af10}


initialize all the kernel memory allocators 



References cachelinesize, Cache\-Line\-Size, C\-E\-I\-L, kmalloc(), kmalloc\-\_\-test(), kmb, kme, list\-\_\-addlast(), list\-\_\-init(), Max\-Line\-Page, Nb\-Pages, P\-A\-G\-E\-\_\-\-S\-I\-Z\-E, and P\-A\-N\-I\-C\-\_\-\-I\-F.



Referenced by kinit().


\begin{DoxyCode}
85 \{
86     \hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize} = \hyperlink{klibc_8h_afa6921cfca101af04b9dcc8d29bc7b16}{CEIL}(\hyperlink{mips_2cache_8S_a2ffad5962fec472ce41e46451bcd8f02}{cachelinesize}(),16);               \textcolor{comment}{// true line
       size, but expand to 16 min}
87     \hyperlink{kmemory_8c_a4c7f2ce6c58dbea9f3f45c967f370a4a}{NbPages} = (\hyperlink{kmemory_8c_aac8be82d7bffa1ad691b1bd5d24492ea}{kme}-\hyperlink{kmemory_8c_a5ca59e07ccac5f97fd636413b47818e9}{kmb})/\hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE};                          \textcolor{comment}{// maximum number of
       pages}
88     \hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage} = \hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE} / \hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize};                \textcolor{comment}{// 256 when
       line is 16, 128 for 32, etc.}
89 
90     \hyperlink{debug__on_8h_a9dea4233af3c516959b7255fbea5c79b}{PANIC\_IF} (\hyperlink{kmemory_8c_a4c7f2ce6c58dbea9f3f45c967f370a4a}{NbPages}*\textcolor{keyword}{sizeof}(\hyperlink{structpage__s}{page\_t}) > \hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE},           \textcolor{comment}{// Not more than
       2048 thus 8MB}
91         \textcolor{stringliteral}{"kmalloc can't handled %d pages"}, \hyperlink{kmemory_8c_a4c7f2ce6c58dbea9f3f45c967f370a4a}{NbPages});         \textcolor{comment}{// write a message then panic}
92 
93     \hyperlink{list_8h_a4988c174e6ecc55436d5f0e3dbbb3980}{list\_init} (&\hyperlink{kmemory_8c_a0893d9ddd9d1a491788e16024697251e}{FreeUserStack});                             \textcolor{comment}{// initialize the free
       user stack list}
94 
95     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0 ; i < \hyperlink{kmemory_8c_af470e8520ef12288ba5f72c899bd4799}{MaxLinePage} ; i++)                 \textcolor{comment}{// initialize each list is Slab
       table}
96         \hyperlink{list_8h_a4988c174e6ecc55436d5f0e3dbbb3980}{list\_init} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[i]);                               \textcolor{comment}{// Slab[i] -> i*cachelinesize
       objects}
97     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{char} *p = \hyperlink{kmemory_8c_a5ca59e07ccac5f97fd636413b47818e9}{kmb}; p != \hyperlink{kmemory_8c_aac8be82d7bffa1ad691b1bd5d24492ea}{kme}; p += \hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE})           \textcolor{comment}{// initialize the page (slab)
       list}
98         \hyperlink{list_8h_a116cfa18214dd2f855cff842bb14ca8f}{list\_addlast} (&\hyperlink{kmemory_8c_af76c5bf598586d0024d1e53b108c868c}{Slab}[0], (\hyperlink{structlist__s}{list\_t} *)p);               \textcolor{comment}{// pointed by Slab[0]}
99     \hyperlink{kmemory_8c_ad3e3a67efeec7e5535c5f05360111d34}{Page} = \hyperlink{kmemory_8c_a5f52d7c56b7d67dc2f96b2e93dfdc7be}{kmalloc} (\hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE});                             \textcolor{comment}{// allocate the Page
       decritor table}
100     \hyperlink{kmemory_8c_a6cfd6b96caef4efda19f082f3ef8cd2d}{kmalloc\_test}(0,\hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE}/8);
101 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_ab85de89de0e4aa840b3d48ffe4f4d5e3}{\index{kmemory.\-h@{kmemory.\-h}!print\-\_\-ustack@{print\-\_\-ustack}}
\index{print\-\_\-ustack@{print\-\_\-ustack}!kmemory.h@{kmemory.\-h}}
\subsubsection[{print\-\_\-ustack}]{\setlength{\rightskip}{0pt plus 5cm}void print\-\_\-ustack (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_ab85de89de0e4aa840b3d48ffe4f4d5e3}


print ustack state 



References \-\_\-usermem, kprintf(), list\-\_\-foreach, \-\_\-usermem\-\_\-s\-::uheap\-\_\-beg, \-\_\-usermem\-\_\-s\-::uheap\-\_\-end, \-\_\-usermem\-\_\-s\-::ustack\-\_\-beg, \-\_\-usermem\-\_\-s\-::ustack\-\_\-end, and U\-S\-T\-A\-C\-K\-\_\-\-S\-I\-Z\-E.



Referenced by test\-\_\-ustack().


\begin{DoxyCode}
284 \{
285     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"---------------\(\backslash\)nNumber of stacks : %d\(\backslash\)n"},
286             ((\textcolor{keywordtype}{char} *)(\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2fd1c0d0e8502f93210c3a30d3746d06}{ustack\_beg}) -
287              (\textcolor{keywordtype}{char} *)(\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end}) )/\hyperlink{usermem_8h_ad77d03e18a9477ef16ff8c4ae3c8b43d}{USTACK\_SIZE});
288     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"\_usermem.ustack\_beg : %p\(\backslash\)n"}, \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2fd1c0d0e8502f93210c3a30d3746d06}{ustack\_beg});
289     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"\_usermem.ustack\_end : %p\(\backslash\)n"}, \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end});
290     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"\_usermem.uheap\_beg  : %p\(\backslash\)n"}, \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a0ada31d8a3c5cd0a5d82fe3b0ea7bbe7}{uheap\_beg} );
291     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"\_usermem.uheap\_end  : %p\(\backslash\)n"}, \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_afc2d87db58cb56804172f98d124d3c05}{uheap\_end} );
292     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"----\(\backslash\)nFree stacks : \(\backslash\)n"});
293     \hyperlink{list_8h_ad759a32561623ec6b31549db8276e8b6}{list\_foreach} (&\hyperlink{kmemory_8c_a0893d9ddd9d1a491788e16024697251e}{FreeUserStack}, item) \{
294         \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\textcolor{stringliteral}{"Address %p\(\backslash\)n"}, item);
295     \}
296 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_ad3736b4c8c3376c224d8a70e39b1a017}{\index{kmemory.\-h@{kmemory.\-h}!sbrk@{sbrk}}
\index{sbrk@{sbrk}!kmemory.h@{kmemory.\-h}}
\subsubsection[{sbrk}]{\setlength{\rightskip}{0pt plus 5cm}void$\ast$ sbrk (
\begin{DoxyParamCaption}
\item[{int}]{increment}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_ad3736b4c8c3376c224d8a70e39b1a017}


change the boundary of the heap 


\begin{DoxyParams}{Parameters}
{\em increment} & integer added to the current heap boundary \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
S\-U\-C\-C\-E\-S\-S or F\-A\-I\-L\-U\-R\-E 
\end{DoxyReturn}

\begin{DoxyCode}
223 \{
224     \hyperlink{usermem_8h_ab03f640d90fbc5bcb75285d08a0f25ed}{errno} = \hyperlink{errno_8h_a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8}{SUCCESS};
225     \textcolor{keywordtype}{int} * a = \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_afc2d87db58cb56804172f98d124d3c05}{uheap\_end} + increment/\textcolor{keyword}{sizeof}(int);   \textcolor{comment}{// sizeof() because uheap\_end
       is int*}
226     a = (\textcolor{keywordtype}{int} *) \hyperlink{klibc_8h_af76aa89c75eec80890c7a792f1fadda7}{FLOOR} (a, \hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize});                   \textcolor{comment}{// addr 'a' could be the new
       uheap\_end}
227     \textcolor{keywordflow}{if} ((a<\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a0ada31d8a3c5cd0a5d82fe3b0ea7bbe7}{uheap\_beg})||(a>\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end}))\{  \textcolor{comment}{// if it is
       outside the heap zone}
228         \hyperlink{usermem_8h_ab03f640d90fbc5bcb75285d08a0f25ed}{errno} = \hyperlink{errno_8h_a447416ba79b4777e7accabf3a8163cb3aec0aa1bb79e2e55ed6d8c165e0611eca}{ENOMEM};
229         \textcolor{keywordflow}{return} (\textcolor{keywordtype}{void} *)-1;                                  \textcolor{comment}{// -1 on failure}
230     \}
231     \textcolor{keywordflow}{return} a;                                               \textcolor{comment}{// else return a;}
232 \}
\end{DoxyCode}
\hypertarget{kmemory_8h_ad59a095064fc46b540321c14b65dab06}{\index{kmemory.\-h@{kmemory.\-h}!test\-\_\-ustack@{test\-\_\-ustack}}
\index{test\-\_\-ustack@{test\-\_\-ustack}!kmemory.h@{kmemory.\-h}}
\subsubsection[{test\-\_\-ustack}]{\setlength{\rightskip}{0pt plus 5cm}void test\-\_\-ustack (
\begin{DoxyParamCaption}
\item[{size\-\_\-t}]{turn}
\end{DoxyParamCaption}
)}}\label{kmemory_8h_ad59a095064fc46b540321c14b65dab06}


References free\-\_\-ustack(), malloc\-\_\-ustack(), N\-B\-S\-T\-A\-C\-K, N\-U\-L\-L, print\-\_\-ustack(), and rand().


\begin{DoxyCode}
299 \{
300 \textcolor{preprocessor}{#   define NBSTACK    10}
301 \textcolor{preprocessor}{}    \textcolor{keywordtype}{int} * stack [\hyperlink{kmemory_8c_a87be89cfdd7a7fa303a8f146373124bc}{NBSTACK}] = \{\hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}\};
302     \textcolor{keywordflow}{while} (turn--) \{
303         \textcolor{keywordtype}{int} place = (unsigned)\hyperlink{klibc_8c_ae23144bcbb8e3742b00eb687c36654d1}{rand}() % \hyperlink{kmemory_8c_a87be89cfdd7a7fa303a8f146373124bc}{NBSTACK};
304         \textcolor{keywordflow}{if} (stack[place])
305             \hyperlink{kmemory_8c_a77191559ef009fa20ada65a52b5e9902}{free\_ustack} (stack[place]);
306         stack[place] = \hyperlink{kmemory_8c_a2ce77af8c704a7d3f2204f94750daedb}{malloc\_ustack}();
307     \}
308     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} place = 0; place < \hyperlink{kmemory_8c_a87be89cfdd7a7fa303a8f146373124bc}{NBSTACK}; place++)
309         \textcolor{keywordflow}{if} (stack[place])
310             \hyperlink{kmemory_8c_a77191559ef009fa20ada65a52b5e9902}{free\_ustack} (stack[place]);
311     \hyperlink{kmemory_8c_ab85de89de0e4aa840b3d48ffe4f4d5e3}{print\_ustack}();
312 \}
\end{DoxyCode}
