\hypertarget{soclib-tty_8c}{\section{/users/enseig/franck/ko6/src/soft/hal/devices/chardev/soclib-\/tty.c File Reference}
\label{soclib-tty_8c}\index{/users/enseig/franck/ko6/src/soft/hal/devices/chardev/soclib-\/tty.\-c@{/users/enseig/franck/ko6/src/soft/hal/devices/chardev/soclib-\/tty.\-c}}
}
{\ttfamily \#include $<$hal/devices/chardev/soclib-\/tty.\-h$>$}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static void \hyperlink{soclib-tty_8c_a00359850c297b2f0c2cf249274763e04}{soclib\-\_\-tty\-\_\-init} (struct \hyperlink{structchardev__s}{chardev\-\_\-s} $\ast$cdev, unsigned address, unsigned baudrate)
\begin{DoxyCompactList}\small\item\em Init the soclib tty device. \end{DoxyCompactList}\item 
static int \hyperlink{soclib-tty_8c_a4431857eb67ef282186a88fda6dcd89e}{soclib\-\_\-tty\-\_\-read} (struct \hyperlink{structchardev__s}{chardev\-\_\-s} $\ast$cdev, char $\ast$buf, unsigned count)
\begin{DoxyCompactList}\small\item\em Read a buffer from the soclib tty. \end{DoxyCompactList}\item 
static int \hyperlink{soclib-tty_8c_a6abd23ad0092762798c155784b37d60a}{soclib\-\_\-tty\-\_\-write} (struct \hyperlink{structchardev__s}{chardev\-\_\-s} $\ast$cdev, char $\ast$buf, unsigned count)
\begin{DoxyCompactList}\small\item\em Write in the T\-T\-Y. \end{DoxyCompactList}\item 
void \hyperlink{soclib-tty_8c_abee08020bafa1f698839a8d477dcdafa}{soclib\-\_\-tty\-\_\-isr} (unsigned irq, struct \hyperlink{structchardev__s}{chardev\-\_\-s} $\ast$cdev)
\begin{DoxyCompactList}\small\item\em I\-S\-R for the soclib tty device The only interrupt handled is the one raised when a character is received by the tty device. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structchardev__ops__s}{chardev\-\_\-ops\-\_\-s} \hyperlink{soclib-tty_8c_ac60ea3e14652d47e0814fac85c18b2ff}{Soclib\-T\-T\-Y\-Ops}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{soclib-tty_8c_a00359850c297b2f0c2cf249274763e04}{\index{soclib-\/tty.\-c@{soclib-\/tty.\-c}!soclib\-\_\-tty\-\_\-init@{soclib\-\_\-tty\-\_\-init}}
\index{soclib\-\_\-tty\-\_\-init@{soclib\-\_\-tty\-\_\-init}!soclib-tty.c@{soclib-\/tty.\-c}}
\subsubsection[{soclib\-\_\-tty\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static void soclib\-\_\-tty\-\_\-init (
\begin{DoxyParamCaption}
\item[{struct {\bf chardev\-\_\-s} $\ast$}]{cdev, }
\item[{unsigned}]{address, }
\item[{unsigned}]{baudrate}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{soclib-tty_8c_a00359850c297b2f0c2cf249274763e04}


Init the soclib tty device. 


\begin{DoxyParams}{Parameters}
{\em cdev} & soclib device \\
\hline
{\em address} & the soclib tty address \\
\hline
{\em baudrate} & the soclib tty baudrate (unused for this device) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
nothing 
\end{DoxyReturn}


References chardev\-\_\-s\-::address, chardev\-\_\-s\-::baudrate, chardev\-\_\-s\-::driver\-\_\-data, kmalloc(), chardev\-\_\-s\-::ops, and Soclib\-T\-T\-Y\-Ops.


\begin{DoxyCode}
23 \{
24     cdev->\hyperlink{structchardev__s_a0b18bf4649bf11afe6ac3f50239144b8}{ops}        = &\hyperlink{soclib-tty_8c_ac60ea3e14652d47e0814fac85c18b2ff}{SoclibTTYOps};
25     cdev->\hyperlink{structchardev__s_add1481ed869132ee70ac2f97038eeb4f}{address}    = address;
26     cdev->\hyperlink{structchardev__s_ae6c6d2be5ba0dcf1639a4953e745d95e}{baudrate}   = baudrate;
27 
28     \textcolor{keyword}{struct }\hyperlink{structfifo__s}{fifo\_s} *fifo = \hyperlink{kmemory_8c_a5f52d7c56b7d67dc2f96b2e93dfdc7be}{kmalloc}(\textcolor{keyword}{sizeof}(\textcolor{keyword}{struct} \hyperlink{structfifo__s}{fifo\_s}));
29     cdev->\hyperlink{structchardev__s_a2265cc57d5d141a86e93b0247db7022d}{driver\_data} = (\textcolor{keywordtype}{void}*) fifo;
30 \}
\end{DoxyCode}
\hypertarget{soclib-tty_8c_abee08020bafa1f698839a8d477dcdafa}{\index{soclib-\/tty.\-c@{soclib-\/tty.\-c}!soclib\-\_\-tty\-\_\-isr@{soclib\-\_\-tty\-\_\-isr}}
\index{soclib\-\_\-tty\-\_\-isr@{soclib\-\_\-tty\-\_\-isr}!soclib-tty.c@{soclib-\/tty.\-c}}
\subsubsection[{soclib\-\_\-tty\-\_\-isr}]{\setlength{\rightskip}{0pt plus 5cm}void soclib\-\_\-tty\-\_\-isr (
\begin{DoxyParamCaption}
\item[{unsigned}]{irq, }
\item[{struct {\bf chardev\-\_\-s} $\ast$}]{cdev}
\end{DoxyParamCaption}
)}}\label{soclib-tty_8c_abee08020bafa1f698839a8d477dcdafa}


I\-S\-R for the soclib tty device The only interrupt handled is the one raised when a character is received by the tty device. 


\begin{DoxyParams}{Parameters}
{\em irq} & the irq linked to this isr \\
\hline
{\em cdev} & the device linked to this isr \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
nothing 
\end{DoxyReturn}


References chardev\-\_\-s\-::address, chardev\-\_\-s\-::driver\-\_\-data, fifo\-\_\-push(), and soclib\-\_\-tty\-\_\-regs\-\_\-s\-::read.



Referenced by soc\-\_\-tty\-\_\-init().


\begin{DoxyCode}
86 \{
87     \textcolor{keyword}{struct }\hyperlink{structsoclib__tty__regs__s}{soclib\_tty\_regs\_s} *regs = 
88         (\textcolor{keyword}{struct }\hyperlink{structsoclib__tty__regs__s}{soclib\_tty\_regs\_s} *) cdev->\hyperlink{structchardev__s_add1481ed869132ee70ac2f97038eeb4f}{address};
89     
90     \textcolor{keyword}{struct} \hyperlink{structfifo__s}{fifo\_s} *fifo = (\textcolor{keyword}{struct} \hyperlink{structfifo__s}{fifo\_s} *) cdev->\hyperlink{structchardev__s_a2265cc57d5d141a86e93b0247db7022d}{driver\_data};
91     \textcolor{keywordtype}{char} c = regs->\hyperlink{structsoclib__tty__regs__s_a1cfb8ccac69fc204c1d0c9e946e5a94f}{read};
92     \hyperlink{klibc_8c_a9d82a64f65502ac9554fc0c28b8f1f44}{fifo\_push}(fifo, c);
93 \}
\end{DoxyCode}
\hypertarget{soclib-tty_8c_a4431857eb67ef282186a88fda6dcd89e}{\index{soclib-\/tty.\-c@{soclib-\/tty.\-c}!soclib\-\_\-tty\-\_\-read@{soclib\-\_\-tty\-\_\-read}}
\index{soclib\-\_\-tty\-\_\-read@{soclib\-\_\-tty\-\_\-read}!soclib-tty.c@{soclib-\/tty.\-c}}
\subsubsection[{soclib\-\_\-tty\-\_\-read}]{\setlength{\rightskip}{0pt plus 5cm}static int soclib\-\_\-tty\-\_\-read (
\begin{DoxyParamCaption}
\item[{struct {\bf chardev\-\_\-s} $\ast$}]{cdev, }
\item[{char $\ast$}]{buf, }
\item[{unsigned}]{count}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{soclib-tty_8c_a4431857eb67ef282186a88fda6dcd89e}


Read a buffer from the soclib tty. 


\begin{DoxyParams}{Parameters}
{\em cdev} & the chardev device corresponding to the soclib tty \\
\hline
{\em buf} & the buf to fill \\
\hline
{\em count} & number of bytes to read from the tty \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
number of bytes written 
\end{DoxyReturn}


References chardev\-\_\-s\-::driver\-\_\-data, F\-A\-I\-L\-U\-R\-E, fifo\-\_\-pull(), irq\-\_\-disable, irq\-\_\-enable, and thread\-\_\-yield().


\begin{DoxyCode}
40 \{
41     \textcolor{keywordtype}{int} res = 0;                                        \textcolor{comment}{// nb of read char}
42     \textcolor{keywordtype}{int} c;                                              \textcolor{comment}{// char read}
43 
44     \textcolor{keyword}{struct }\hyperlink{structfifo__s}{fifo\_s} *fifo = (\textcolor{keyword}{struct }\hyperlink{structfifo__s}{fifo\_s} *) cdev->\hyperlink{structchardev__s_a2265cc57d5d141a86e93b0247db7022d}{driver\_data};
45     while (count--) \{
46         \textcolor{keywordflow}{while} (\hyperlink{klibc_8c_a95fd51dea7c9c02c2e2e1e9ad2333684}{fifo\_pull}(fifo, &c) == \hyperlink{errno_8h_a447416ba79b4777e7accabf3a8163cb3aa5571864412c8275a2e18a931fddcaa6}{FAILURE}) \{  \textcolor{comment}{// wait for a char from the keyboard}
47             \hyperlink{kthread_8c_affe2eebf6749bc36765d45ff48c926b1}{thread\_yield}();                                 \textcolor{comment}{// nothing then we yield the
       processor}
48             \hyperlink{mips_2irq_8S_aaef40102bb274fecd542c306bb6a8e20}{irq\_enable}();                                   \textcolor{comment}{// get few characters if thread is
       alone}
49             \hyperlink{mips_2irq_8S_ab061b784fed23b72808250b4cd9276a3}{irq\_disable}();                                  \textcolor{comment}{// close enter}
50         \}
51         *buf++ = c;
52         res++;
53     \}
54     \textcolor{keywordflow}{return} res;                                         \textcolor{comment}{// return the number of char read}
55 \}
\end{DoxyCode}
\hypertarget{soclib-tty_8c_a6abd23ad0092762798c155784b37d60a}{\index{soclib-\/tty.\-c@{soclib-\/tty.\-c}!soclib\-\_\-tty\-\_\-write@{soclib\-\_\-tty\-\_\-write}}
\index{soclib\-\_\-tty\-\_\-write@{soclib\-\_\-tty\-\_\-write}!soclib-tty.c@{soclib-\/tty.\-c}}
\subsubsection[{soclib\-\_\-tty\-\_\-write}]{\setlength{\rightskip}{0pt plus 5cm}static int soclib\-\_\-tty\-\_\-write (
\begin{DoxyParamCaption}
\item[{struct {\bf chardev\-\_\-s} $\ast$}]{cdev, }
\item[{char $\ast$}]{buf, }
\item[{unsigned}]{count}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{soclib-tty_8c_a6abd23ad0092762798c155784b37d60a}


Write in the T\-T\-Y. 


\begin{DoxyParams}{Parameters}
{\em cdev} & the device struct corresponding to the tty \\
\hline
{\em buf} & the buffer to write \\
\hline
{\em count} & number of bytes to write \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
number of bytes written 
\end{DoxyReturn}


References chardev\-\_\-s\-::address, delay(), and soclib\-\_\-tty\-\_\-regs\-\_\-s\-::write.


\begin{DoxyCode}
65 \{
66     \textcolor{keywordtype}{int} res = 0;                                        \textcolor{comment}{// nb of written char}
67     \textcolor{keyword}{struct }\hyperlink{structsoclib__tty__regs__s}{soclib\_tty\_regs\_s} *regs = 
68         (\textcolor{keyword}{struct }\hyperlink{structsoclib__tty__regs__s}{soclib\_tty\_regs\_s} *) cdev->\hyperlink{structchardev__s_add1481ed869132ee70ac2f97038eeb4f}{address};     \textcolor{comment}{// access the registers}
69 
70     while (count--) \{                                   \textcolor{comment}{// while there are chars}
71         regs->\hyperlink{structsoclib__tty__regs__s_ad0f5bc1340be3f28fb65d8174d95c846}{write} = *buf;                             \textcolor{comment}{// send the char to TTY}
72         \hyperlink{klibc_8c_a3643d04c418455ae56f321c6d12f8da8}{delay}(150);
73         res++;                                          \textcolor{comment}{// nb of written char}
74         buf++;                                          \textcolor{comment}{// but is the next address in buffer}
75     \}
76     \textcolor{keywordflow}{return} res;
77 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{soclib-tty_8c_ac60ea3e14652d47e0814fac85c18b2ff}{\index{soclib-\/tty.\-c@{soclib-\/tty.\-c}!Soclib\-T\-T\-Y\-Ops@{Soclib\-T\-T\-Y\-Ops}}
\index{Soclib\-T\-T\-Y\-Ops@{Soclib\-T\-T\-Y\-Ops}!soclib-tty.c@{soclib-\/tty.\-c}}
\subsubsection[{Soclib\-T\-T\-Y\-Ops}]{\setlength{\rightskip}{0pt plus 5cm}struct {\bf chardev\-\_\-ops\-\_\-s} Soclib\-T\-T\-Y\-Ops}}\label{soclib-tty_8c_ac60ea3e14652d47e0814fac85c18b2ff}
{\bfseries Initial value\-:}
\begin{DoxyCode}
= \{
    .chardev\_init = \hyperlink{soclib-tty_8c_a00359850c297b2f0c2cf249274763e04}{soclib\_tty\_init},
    .chardev\_read = \hyperlink{soclib-tty_8c_a4431857eb67ef282186a88fda6dcd89e}{soclib\_tty\_read},
    .chardev\_write = \hyperlink{soclib-tty_8c_a6abd23ad0092762798c155784b37d60a}{soclib\_tty\_write}
\}
\end{DoxyCode}


Referenced by soc\-\_\-tty\-\_\-init(), and soclib\-\_\-tty\-\_\-init().

