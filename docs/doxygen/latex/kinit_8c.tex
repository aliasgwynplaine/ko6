\hypertarget{kinit_8c}{\section{/users/enseig/franck/ko6/src/soft/kernel/kinit.c File Reference}
\label{kinit_8c}\index{/users/enseig/franck/ko6/src/soft/kernel/kinit.\-c@{/users/enseig/franck/ko6/src/soft/kernel/kinit.\-c}}
}
{\ttfamily \#include $<$kernel/klibc.\-h$>$}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{kinit_8c_a798e4073d613ca5ba9618e1b3253df14}{Y}~\hyperlink{esc__code_8h_aaed7cab93c90dd9b4006c2b819a39908}{E\-C\-\_\-\-B\-O\-L\-D} \hyperlink{esc__code_8h_a7f3b5cb90e3ed4bd270548f6798a5f22}{E\-C\-\_\-\-W\-H\-I\-T\-E}\char`\"{}'\char`\"{}\hyperlink{esc__code_8h_ac3a4a9518b8467436c8806b33319c327}{E\-C\-\_\-\-Y\-E\-L\-L\-O\-W}\char`\"{}v\char`\"{}E\-C\-\_\-\-W\-H\-I\-T\-E\char`\"{}'\char`\"{}\hyperlink{esc__code_8h_a5a1c367442ae3de4fdd1e989aab1d80b}{E\-C\-\_\-\-R\-E\-S\-E\-T} \hyperlink{esc__code_8h_a1f2dc30315209b1f2df2cda0c9e2e52e}{E\-C\-\_\-\-C\-Y\-A\-N}
\item 
\#define \hyperlink{kinit_8c_a207fd5507206d307cd63f95374fcd00d}{X}~\hyperlink{esc__code_8h_a69a73e6aff76280fedcf578f570b5ef4}{E\-C\-\_\-\-O\-R\-A\-N\-G\-E}\char`\"{}x\char`\"{}E\-C\-\_\-\-C\-Y\-A\-N
\item 
\#define \hyperlink{kinit_8c_ae9f9fa36f57101624ba9360f9287e6eb}{X\-\_\-\-\_\-\-\_\-\-X}~\char`\"{} \char`\"{} \hyperlink{kinit_8c_a207fd5507206d307cd63f95374fcd00d}{X} \char`\"{}\-\_\-\-\_\-\-\_\-\char`\"{} X \char`\"{} \char`\"{}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{kinit_8c_a7316311400d5b710f1b974a353b10d1c}{kinit} (void $\ast$fdt)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
static char \hyperlink{kinit_8c_a8498441dea21ca60b758bcd2395f5fb1}{Banner} \mbox{[}$\,$\mbox{]}
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{kinit_8c_a207fd5507206d307cd63f95374fcd00d}{\index{kinit.\-c@{kinit.\-c}!X@{X}}
\index{X@{X}!kinit.c@{kinit.\-c}}
\subsubsection[{X}]{\setlength{\rightskip}{0pt plus 5cm}\#define X~{\bf E\-C\-\_\-\-O\-R\-A\-N\-G\-E}\char`\"{}x\char`\"{}E\-C\-\_\-\-C\-Y\-A\-N}}\label{kinit_8c_a207fd5507206d307cd63f95374fcd00d}
\hypertarget{kinit_8c_ae9f9fa36f57101624ba9360f9287e6eb}{\index{kinit.\-c@{kinit.\-c}!X\-\_\-\-\_\-\-\_\-\-X@{X\-\_\-\-\_\-\-\_\-\-X}}
\index{X\-\_\-\-\_\-\-\_\-\-X@{X\-\_\-\-\_\-\-\_\-\-X}!kinit.c@{kinit.\-c}}
\subsubsection[{X\-\_\-\-\_\-\-\_\-\-X}]{\setlength{\rightskip}{0pt plus 5cm}\#define X\-\_\-\-\_\-\-\_\-\-X~\char`\"{} \char`\"{} {\bf X} \char`\"{}\-\_\-\-\_\-\-\_\-\char`\"{} X \char`\"{} \char`\"{}}}\label{kinit_8c_ae9f9fa36f57101624ba9360f9287e6eb}
\hypertarget{kinit_8c_a798e4073d613ca5ba9618e1b3253df14}{\index{kinit.\-c@{kinit.\-c}!Y@{Y}}
\index{Y@{Y}!kinit.c@{kinit.\-c}}
\subsubsection[{Y}]{\setlength{\rightskip}{0pt plus 5cm}\#define Y~{\bf E\-C\-\_\-\-B\-O\-L\-D} {\bf E\-C\-\_\-\-W\-H\-I\-T\-E}\char`\"{}'\char`\"{}{\bf E\-C\-\_\-\-Y\-E\-L\-L\-O\-W}\char`\"{}v\char`\"{}E\-C\-\_\-\-W\-H\-I\-T\-E\char`\"{}'\char`\"{}{\bf E\-C\-\_\-\-R\-E\-S\-E\-T} {\bf E\-C\-\_\-\-C\-Y\-A\-N}}}\label{kinit_8c_a798e4073d613ca5ba9618e1b3253df14}


\subsection{Function Documentation}
\hypertarget{kinit_8c_a7316311400d5b710f1b974a353b10d1c}{\index{kinit.\-c@{kinit.\-c}!kinit@{kinit}}
\index{kinit@{kinit}!kinit.c@{kinit.\-c}}
\subsubsection[{kinit}]{\setlength{\rightskip}{0pt plus 5cm}void kinit (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt}
\end{DoxyParamCaption}
)}}\label{kinit_8c_a7316311400d5b710f1b974a353b10d1c}


References \-\_\-\-\_\-bss\-\_\-end, \-\_\-\-\_\-bss\-\_\-origin, \-\_\-usermem, Banner, kprintf(), \-\_\-usermem\-\_\-s\-::main\-\_\-start, \-\_\-usermem\-\_\-s\-::main\-\_\-thread, memory\-\_\-init(), P\-A\-N\-I\-C\-\_\-\-I\-F, soc\-\_\-init(), thread\-\_\-create(), and thread\-\_\-main\-\_\-load().


\begin{DoxyCode}
34 \{
35     \textcolor{comment}{// put bss sections to zero. bss contains uninitialised global variables}
36     \textcolor{keyword}{extern} \textcolor{keywordtype}{int} \hyperlink{crt0_8c_a175fab0b9223d71c173fa84efe29d155}{\_\_bss\_origin};    \textcolor{comment}{// first int of bss section (defined in ldscript kernel.ld)}
37     \textcolor{keyword}{extern} \textcolor{keywordtype}{int} \hyperlink{kmemory_8c_adbad17f740c2d7f2bc4833681c93c932}{\_\_bss\_end};       \textcolor{comment}{// first int of above bss section (defined in ldscript kernel.ld)}
38     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} *a = &\_\_bss\_origin; a != &\hyperlink{kmemory_8c_adbad17f740c2d7f2bc4833681c93c932}{\_\_bss\_end}; *a++ = 0);
39 
40     \hyperlink{kmemory_8c_a34f25b1ca1556d0890274a971d46af10}{memory\_init}();                  \textcolor{comment}{// memory initialisation }
41     \textcolor{keywordflow}{if} (\hyperlink{almo1-mips_2soc_8c_a436517497969d33b08925565d4cca572}{soc\_init}(fdt, 200000) < 0)  \textcolor{comment}{// soc initialisation takes the tick as argument}
42         \textcolor{keywordflow}{goto} sleep;                 \textcolor{comment}{// initialization failed, just sleep}
43 
44     \hyperlink{klibc_8c_ac4ae3bb8e59735d2b772e77186b52228}{kprintf} (\hyperlink{kinit_8c_a8498441dea21ca60b758bcd2395f5fb1}{Banner});
45 
46     \textcolor{comment}{// first, we have to create the thread structure for the kernel thread kshell()}
47 
48     \textcolor{comment}{// second, we have to create the thread structure for the thread main()}
49     \textcolor{comment}{//   thread\_create() is the same function used to create the thread main()}
50     \textcolor{comment}{//   and to create an usual thread, here, we create the the thread main, it takes 4 args}
51     \textcolor{comment}{//   1. The address of the thread structure,}
52     \textcolor{comment}{//      This structure must be placed in the .data segment (user space) because there is}
53     \textcolor{comment}{//      the stack inside but the address of the the structure must be known by the kernel.}
54     \textcolor{comment}{//      That's why, the thread structure of main() is placed at the very beginning of .data}
55     \textcolor{comment}{//   2. The address of the thread function (cast to int), here it should be the address of}
56     \textcolor{comment}{//      main function, but we are not able to know this address because it is in the user}
57     \textcolor{comment}{//      segment .text, thus we put 0 and it is the user function \_start() which call main()}
58     \textcolor{comment}{//      function by principle (the main function is always mandatory).}
59     \textcolor{comment}{//   3. The argument of the thread function (cast to int), in that case we does not know it,}
60     \textcolor{comment}{//      thus we put 0, and it is the user function \_start() that will find the arguments}
61     \textcolor{comment}{//      of main(). Note that in our case, there is not arguments for the function main().}
62     \textcolor{comment}{//   4. The address of the main() starter, nammed \_start(), it is this function that will}
63     \textcolor{comment}{//      call the main() function with its arguments (here none) and then will call exit()}
64     \textcolor{comment}{//      when main() returns. Note, the starter of an usual thread is thread\_start() (defined}
65     \textcolor{comment}{//      in thread.c) and it  will call thread\_exit() when the thread returns.}
66 
67     \hyperlink{kthread_8c_a2525e99272c4db4198bcea374d717620}{thread\_create} ((\hyperlink{structthread__s}{thread\_t} *)&\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.
      \hyperlink{struct__usermem__s_a72dc8dd0f2611deaef667aa2f9dbeb9f}{main\_thread}, 0, 0, (\textcolor{keywordtype}{int})\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_aeb4637b2b234d4b2b4c3963bc580b993}{main\_start});
68 
69     \textcolor{comment}{// Next, we have to load the context of main() and start it}
70     \textcolor{comment}{//   It means to initialize the stack pointer, the status register and the return address ($31)}
71     \textcolor{comment}{//   And, as it it is the first load, jr $31 will go to thread\_bootstrap which go to \_start()}
72     \textcolor{comment}{//   function in user mode. You can look at the comment of the bootstrap() function in}
73     \textcolor{comment}{//   kthread.c file for details.}
74 
75     \hyperlink{kthread_8c_a95c63c8faef6c13da432a94800ad2acb}{thread\_main\_load} (\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a72dc8dd0f2611deaef667aa2f9dbeb9f}{main\_thread});
76 
77     \textcolor{comment}{// We never return of thread\_load() here because thread\_load() change $31 to thread\_bootstap()}
78     \hyperlink{debug__on_8h_a9dea4233af3c516959b7255fbea5c79b}{PANIC\_IF}(\textcolor{keyword}{true},\textcolor{stringliteral}{"Impossible to be here"});
79 
80     \textcolor{comment}{// In case anything goes wrong during initialization}
81 sleep:
82     \textcolor{keywordflow}{while} (1) ;
83 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{kinit_8c_a8498441dea21ca60b758bcd2395f5fb1}{\index{kinit.\-c@{kinit.\-c}!Banner@{Banner}}
\index{Banner@{Banner}!kinit.c@{kinit.\-c}}
\subsubsection[{Banner}]{\setlength{\rightskip}{0pt plus 5cm}char Banner\mbox{[}$\,$\mbox{]}\hspace{0.3cm}{\ttfamily [static]}}}\label{kinit_8c_a8498441dea21ca60b758bcd2395f5fb1}
{\bfseries Initial value\-:}
\begin{DoxyCode}
=          
\hyperlink{esc__code_8h_a7f3b5cb90e3ed4bd270548f6798a5f22}{EC\_WHITE}
\textcolor{stringliteral}{"   \_   "}  \hyperlink{esc__code_8h_a1f2dc30315209b1f2df2cda0c9e2e52e}{EC\_CYAN}\textcolor{stringliteral}{"  \_\_\_  "}  \hyperlink{esc__code_8h_a7f3b5cb90e3ed4bd270548f6798a5f22}{EC\_WHITE}\textcolor{stringliteral}{"  \_\_ \(\backslash\)n"}
\textcolor{stringliteral}{"  | |\_\_"}  \hyperlink{esc__code_8h_a1f2dc30315209b1f2df2cda0c9e2e52e}{EC\_CYAN}\textcolor{stringliteral}{" /"}\hyperlink{kinit_8c_a798e4073d613ca5ba9618e1b3253df14}{Y}\textcolor{stringliteral}{"\(\backslash\)\(\backslash\) "} \hyperlink{esc__code_8h_a7f3b5cb90e3ed4bd270548f6798a5f22}{EC\_WHITE}\textcolor{stringliteral}{" / / \(\backslash\)n"}
\textcolor{stringliteral}{"  | / /"}  \hyperlink{esc__code_8h_a1f2dc30315209b1f2df2cda0c9e2e52e}{EC\_CYAN}\textcolor{stringliteral}{"(     )"}  \hyperlink{esc__code_8h_a7f3b5cb90e3ed4bd270548f6798a5f22}{EC\_WHITE}\textcolor{stringliteral}{"/ \_ \(\backslash\)\(\backslash\)\(\backslash\)n"}
\textcolor{stringliteral}{"  |\_\(\backslash\)\(\backslash\)\_\(\backslash\)\(\backslash\)"}\hyperlink{esc__code_8h_a1f2dc30315209b1f2df2cda0c9e2e52e}{EC\_CYAN}  \hyperlink{kinit_8c_ae9f9fa36f57101624ba9360f9287e6eb}{X\_\_\_X}    \hyperlink{esc__code_8h_a7f3b5cb90e3ed4bd270548f6798a5f22}{EC\_WHITE}\textcolor{stringliteral}{"\(\backslash\)\(\backslash\)\_\_\_/\(\backslash\)n\(\backslash\)n"}
\hyperlink{esc__code_8h_a5a1c367442ae3de4fdd1e989aab1d80b}{EC\_RESET}
\end{DoxyCode}


Referenced by kinit().

