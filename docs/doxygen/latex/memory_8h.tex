\hypertarget{memory_8h}{\section{/users/enseig/franck/ko6/src/soft/ulib/memory.h File Reference}
\label{memory_8h}\index{/users/enseig/franck/ko6/src/soft/ulib/memory.\-h@{/users/enseig/franck/ko6/src/soft/ulib/memory.\-h}}
}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{memory_8h_ac825a564c0baeef745c317659440f436}{sbrk\-\_\-s} (void)
\item 
void $\ast$ \hyperlink{memory_8h_ad3736b4c8c3376c224d8a70e39b1a017}{sbrk} (int increment)
\begin{DoxyCompactList}\small\item\em change the boundary of heap \end{DoxyCompactList}\item 
void \hyperlink{memory_8h_abec89c1ec75c687671f30b1cc0875f9d}{malloc\-\_\-print} (size\-\_\-t level)
\begin{DoxyCompactList}\small\item\em print the heap state \end{DoxyCompactList}\item 
void \hyperlink{memory_8h_a552e72b11235cf8c6263b5d199e988ad}{malloc\-\_\-init} (void $\ast$start)
\begin{DoxyCompactList}\small\item\em Heap initialiation, called only once before to call the \hyperlink{ktools_8c_a0ddf1224851353fc92bfbff6f499fa97}{main()} fonction. \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{memory_8h_a6c41a332d0a2d4f17354120435d5db2f}{malloc} (unsigned size)
\begin{DoxyCompactList}\small\item\em Try to find a free object large enough, if none, merge free segments and try again. \end{DoxyCompactList}\item 
void \hyperlink{memory_8h_afbedc913aa4651b3c3b4b3aecd9b4711}{free} (void $\ast$ptr)
\begin{DoxyCompactList}\small\item\em free an allocated object with \hyperlink{memory_8c_a7ac38fce3243a7dcf448301ee9ffd392}{malloc()}, object is not erased. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{memory_8h_afbedc913aa4651b3c3b4b3aecd9b4711}{\index{memory.\-h@{memory.\-h}!free@{free}}
\index{free@{free}!memory.h@{memory.\-h}}
\subsubsection[{free}]{\setlength{\rightskip}{0pt plus 5cm}void free (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{ptr}
\end{DoxyParamCaption}
)}}\label{memory_8h_afbedc913aa4651b3c3b4b3aecd9b4711}


free an allocated object with \hyperlink{memory_8c_a7ac38fce3243a7dcf448301ee9ffd392}{malloc()}, object is not erased. 


\begin{DoxyParams}{Parameters}
{\em ptr} & previously allocated object pointer \\
\hline
\end{DoxyParams}


References exit(), block\-\_\-info\-\_\-s\-::full, block\-\_\-info\-\_\-s\-::magic, and M\-A\-G\-I\-C\-\_\-\-H\-E\-A\-P.



Referenced by build(), and split().


\begin{DoxyCode}
110 \{
111     \hyperlink{structblock__info__s}{block\_info\_t} *info = (\hyperlink{structblock__info__s}{block\_info\_t} *)ptr - 1;           \textcolor{comment}{// block\_info is just
       before ptr}
112     \textcolor{keywordflow}{if} (!ptr || !info->\hyperlink{structblock__info__s_a630efa05da2102ab8ea4f41836e8fdf1}{full} || (info->\hyperlink{structblock__info__s_ac16e3bd98da13d928f64af612e8f8c40}{magic} != \hyperlink{usermem_8h_a90d67f1ad6ff70aec014a689031953a2}{MAGIC\_HEAP})) \textcolor{comment}{// pt NULL OR segment free
       OR not MAGIC}
113         \hyperlink{klibc_8c_a55e99c539cf7723ec15e856b7e0a8cee}{exit}(1);                                            \textcolor{comment}{// memory corrupted}
114     info->\hyperlink{structblock__info__s_a630efa05da2102ab8ea4f41836e8fdf1}{full} = 0;                                         \textcolor{comment}{// erase the full flag}
115 \}
\end{DoxyCode}
\hypertarget{memory_8h_a6c41a332d0a2d4f17354120435d5db2f}{\index{memory.\-h@{memory.\-h}!malloc@{malloc}}
\index{malloc@{malloc}!memory.h@{memory.\-h}}
\subsubsection[{malloc}]{\setlength{\rightskip}{0pt plus 5cm}void$\ast$ malloc (
\begin{DoxyParamCaption}
\item[{unsigned}]{size}
\end{DoxyParamCaption}
)}}\label{memory_8h_a6c41a332d0a2d4f17354120435d5db2f}


Try to find a free object large enough, if none, merge free segments and try again. 


\begin{DoxyParams}{Parameters}
{\em size} & number of bytes asked \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
A pointer of the allocated object or N\-U\-L\-L if there is not place anymore. 
\end{DoxyReturn}
\hypertarget{memory_8h_a552e72b11235cf8c6263b5d199e988ad}{\index{memory.\-h@{memory.\-h}!malloc\-\_\-init@{malloc\-\_\-init}}
\index{malloc\-\_\-init@{malloc\-\_\-init}!memory.h@{memory.\-h}}
\subsubsection[{malloc\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}void malloc\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{start}
\end{DoxyParamCaption}
)}}\label{memory_8h_a552e72b11235cf8c6263b5d199e988ad}


Heap initialiation, called only once before to call the \hyperlink{ktools_8c_a0ddf1224851353fc92bfbff6f499fa97}{main()} fonction. 


\begin{DoxyParams}{Parameters}
{\em start} & address of the first byte \\
\hline
\end{DoxyParams}


References heap\-\_\-s\-::beg, Cache\-Line\-Size, cachelinesize, heap\-\_\-s\-::end, exit(), block\-\_\-info\-\_\-s\-::full, Heap, L\-I\-N\-E\-\_\-\-F\-L\-O\-O\-R, block\-\_\-info\-\_\-s\-::magic, M\-A\-G\-I\-C\-\_\-\-H\-E\-A\-P, P\-A\-G\-E\-\_\-\-S\-I\-Z\-E, sbrk(), and block\-\_\-info\-\_\-s\-::size.



Referenced by \-\_\-start().


\begin{DoxyCode}
84 \{
85     \hyperlink{memory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize} = \hyperlink{mips_2cache_8S_a2ffad5962fec472ce41e46451bcd8f02}{cachelinesize}();                        \textcolor{comment}{// need to know the
       cache line size}
86     \textcolor{keywordtype}{int} *end = \hyperlink{kmemory_8c_ad3736b4c8c3376c224d8a70e39b1a017}{sbrk} (4* \hyperlink{usermem_8h_a7d467c1d283fdfa1f2081ba1e0d01b6e}{PAGE\_SIZE});                         \textcolor{comment}{// try to get 4 pages (16ko)}
87 
88     \textcolor{keywordflow}{if} (end == (\textcolor{keywordtype}{int} *)-1) \hyperlink{klibc_8c_a55e99c539cf7723ec15e856b7e0a8cee}{exit} (2);                         \textcolor{comment}{// if impossible exit the app}
89     \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg} = \hyperlink{memory_8c_af1a89b64a4a03cb2d9a2d85f5fe22cc8}{LINE\_FLOOR} (beg);                            \textcolor{comment}{// address of the first BLOCK}
90     \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a5cd7ea9b707bc85c4466b832aeb03919}{end} = \hyperlink{memory_8c_af1a89b64a4a03cb2d9a2d85f5fe22cc8}{LINE\_FLOOR} (end);                            \textcolor{comment}{// address of the boundary}
91     \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg}->\hyperlink{structblock__info__s_a630efa05da2102ab8ea4f41836e8fdf1}{full} = 0;                                     \textcolor{comment}{// empty at the begining}
92     \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg}->\hyperlink{structblock__info__s_ac16e3bd98da13d928f64af612e8f8c40}{magic} = \hyperlink{usermem_8h_a90d67f1ad6ff70aec014a689031953a2}{MAGIC\_HEAP};                           \textcolor{comment}{// to try detect Heap
       corruption}
93     \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg}->\hyperlink{structblock__info__s_ac5d895bc19d09c9bb8dc9dafea66e159}{size} = \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a5cd7ea9b707bc85c4466b832aeb03919}{end} - \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg};                   \textcolor{comment}{// size of free space}
94     \hyperlink{memory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize} = \hyperlink{mips_2cache_8S_a2ffad5962fec472ce41e46451bcd8f02}{cachelinesize}();                        \textcolor{comment}{// ask the kernel for
       cache line size}
95 \}
\end{DoxyCode}
\hypertarget{memory_8h_abec89c1ec75c687671f30b1cc0875f9d}{\index{memory.\-h@{memory.\-h}!malloc\-\_\-print@{malloc\-\_\-print}}
\index{malloc\-\_\-print@{malloc\-\_\-print}!memory.h@{memory.\-h}}
\subsubsection[{malloc\-\_\-print}]{\setlength{\rightskip}{0pt plus 5cm}void malloc\-\_\-print (
\begin{DoxyParamCaption}
\item[{size\-\_\-t}]{level}
\end{DoxyParamCaption}
)}}\label{memory_8h_abec89c1ec75c687671f30b1cc0875f9d}


print the heap state 


\begin{DoxyParams}{Parameters}
{\em level} & use\-: 0 = full/free bytes; 1 = the nb of blocks full/free per size; 2 = all details \\
\hline
\end{DoxyParams}


References heap\-\_\-s\-::beg, B\-I\-N\-F\-O\-\_\-\-S\-Z, heap\-\_\-s\-::end, fprintf(), block\-\_\-info\-\_\-s\-::full, Heap, and block\-\_\-info\-\_\-s\-::size.


\begin{DoxyCode}
118 \{
119     \hyperlink{structblock__info__s}{block\_info\_t} *ptr;
120     \hyperlink{libc_8c_a4e7edf0e8df09b47566d572e19dad429}{fprintf} (0, \textcolor{stringliteral}{"------------ %p ------------\(\backslash\)n"}, \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg});
121     \textcolor{keywordflow}{for} (ptr = \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg}; ptr < Heap.end; ptr += ptr->size)  \textcolor{comment}{// browse all blocks}
122         \hyperlink{libc_8c_a4e7edf0e8df09b47566d572e19dad429}{fprintf} (0, \textcolor{stringliteral}{" %s  [ %x\(\backslash\)t- %x\(\backslash\)t] = %d\(\backslash\)n"},
123             (ptr->\hyperlink{structblock__info__s_a630efa05da2102ab8ea4f41836e8fdf1}{full}) ? \textcolor{stringliteral}{"full"} : \textcolor{stringliteral}{"free"},                  \textcolor{comment}{// print if block is full or free}
124             \hyperlink{memory_8c_ae4cf233b234f33932972141bf43a21ca}{BINFO\_SZ}*(\textcolor{keywordtype}{size\_t})(ptr - \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg}),              \textcolor{comment}{// print block begin position}
125             \hyperlink{memory_8c_ae4cf233b234f33932972141bf43a21ca}{BINFO\_SZ}*(\textcolor{keywordtype}{size\_t})((ptr + ptr->\hyperlink{structblock__info__s_ac5d895bc19d09c9bb8dc9dafea66e159}{size}) - \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a30840749cc5d580c1d1560051e4c8c2a}{beg}),\textcolor{comment}{// print block end position}
126             \hyperlink{memory_8c_ae4cf233b234f33932972141bf43a21ca}{BINFO\_SZ}*(\textcolor{keywordtype}{size\_t})(ptr->\hyperlink{structblock__info__s_ac5d895bc19d09c9bb8dc9dafea66e159}{size}));                  \textcolor{comment}{// print block size}
127     \hyperlink{libc_8c_a4e7edf0e8df09b47566d572e19dad429}{fprintf} (0, \textcolor{stringliteral}{"------------ %p ------------\(\backslash\)n"}, \hyperlink{memory_8c_a58da4284214d7464432b6e2e431e02d4}{Heap}.\hyperlink{structheap__s_a5cd7ea9b707bc85c4466b832aeb03919}{end});
128 \}
\end{DoxyCode}
\hypertarget{memory_8h_ad3736b4c8c3376c224d8a70e39b1a017}{\index{memory.\-h@{memory.\-h}!sbrk@{sbrk}}
\index{sbrk@{sbrk}!memory.h@{memory.\-h}}
\subsubsection[{sbrk}]{\setlength{\rightskip}{0pt plus 5cm}void$\ast$ sbrk (
\begin{DoxyParamCaption}
\item[{int}]{increment}
\end{DoxyParamCaption}
)}}\label{memory_8h_ad3736b4c8c3376c224d8a70e39b1a017}


change the boundary of heap 


\begin{DoxyParams}{Parameters}
{\em increment} & is the signed number of bytes , which will be aligned on a cache line \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
new end address of the heap, (increment=0) gives the current one, returns -\/1 on failure
\end{DoxyReturn}
change the boundary of heap


\begin{DoxyParams}{Parameters}
{\em increment} & integer added to the current heap boundary \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
S\-U\-C\-C\-E\-S\-S or F\-A\-I\-L\-U\-R\-E 
\end{DoxyReturn}


References \-\_\-usermem, Cache\-Line\-Size, E\-N\-O\-M\-E\-M, errno, F\-L\-O\-O\-R, sbrk\-\_\-s, S\-U\-C\-C\-E\-S\-S, syscall\-\_\-fct, S\-Y\-S\-C\-A\-L\-L\-\_\-\-S\-B\-R\-K, \-\_\-usermem\-\_\-s\-::uheap\-\_\-beg, \-\_\-usermem\-\_\-s\-::uheap\-\_\-end, and \-\_\-usermem\-\_\-s\-::ustack\-\_\-end.



Referenced by malloc\-\_\-init().


\begin{DoxyCode}
223 \{
224     \hyperlink{usermem_8h_ab03f640d90fbc5bcb75285d08a0f25ed}{errno} = \hyperlink{errno_8h_a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8}{SUCCESS};
225     \textcolor{keywordtype}{int} * a = \hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_afc2d87db58cb56804172f98d124d3c05}{uheap\_end} + increment/\textcolor{keyword}{sizeof}(int);   \textcolor{comment}{// sizeof() because uheap\_end
       is int*}
226     a = (\textcolor{keywordtype}{int} *) \hyperlink{klibc_8h_af76aa89c75eec80890c7a792f1fadda7}{FLOOR} (a, \hyperlink{kmemory_8c_a7a2da4d001f5945106528b32581206e2}{CacheLineSize});                   \textcolor{comment}{// addr 'a' could be the new
       uheap\_end}
227     \textcolor{keywordflow}{if} ((a<\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a0ada31d8a3c5cd0a5d82fe3b0ea7bbe7}{uheap\_beg})||(a>\hyperlink{usermem_8h_af044184d28c9a8b78f17bd1d8e1059b4}{\_usermem}.\hyperlink{struct__usermem__s_a2ff86fc41cdbe6063962b5be6aef49fc}{ustack\_end}))\{  \textcolor{comment}{// if it is
       outside the heap zone}
228         \hyperlink{usermem_8h_ab03f640d90fbc5bcb75285d08a0f25ed}{errno} = \hyperlink{errno_8h_a447416ba79b4777e7accabf3a8163cb3aec0aa1bb79e2e55ed6d8c165e0611eca}{ENOMEM};
229         \textcolor{keywordflow}{return} (\textcolor{keywordtype}{void} *)-1;                                  \textcolor{comment}{// -1 on failure}
230     \}
231     \textcolor{keywordflow}{return} a;                                               \textcolor{comment}{// else return a;}
232 \}
\end{DoxyCode}
\hypertarget{memory_8h_ac825a564c0baeef745c317659440f436}{\index{memory.\-h@{memory.\-h}!sbrk\-\_\-s@{sbrk\-\_\-s}}
\index{sbrk\-\_\-s@{sbrk\-\_\-s}!memory.h@{memory.\-h}}
\subsubsection[{sbrk\-\_\-s}]{\setlength{\rightskip}{0pt plus 5cm}void sbrk\-\_\-s (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{memory_8h_ac825a564c0baeef745c317659440f436}
T\-O\-D\-O\-: ask about this 