\hypertarget{almo1-mips_2soc_8c}{\section{/users/enseig/franck/ko6/src/soft/hal/soc/almo1-\/mips/soc.c File Reference}
\label{almo1-mips_2soc_8c}\index{/users/enseig/franck/ko6/src/soft/hal/soc/almo1-\/mips/soc.\-c@{/users/enseig/franck/ko6/src/soft/hal/soc/almo1-\/mips/soc.\-c}}
}
{\ttfamily \#include $<$hal/devices/chardev/soclib-\/tty.\-h$>$}\\*
{\ttfamily \#include $<$hal/devices/timer/soclib-\/timer.\-h$>$}\\*
{\ttfamily \#include $<$hal/devices/icu/soclib-\/icu.\-h$>$}\\*
{\ttfamily \#include $<$hal/devices/dma/soclib-\/dma.\-h$>$}\\*
{\ttfamily \#include $<$hal/cpu/irq.\-h$>$}\\*
{\ttfamily \#include $<$kernel/kthread.\-h$>$}\\*
{\ttfamily \#include $<$kernel/klibc.\-h$>$}\\*
{\ttfamily \#include $<$kernel/kirq.\-h$>$}\\*
{\ttfamily \#include $<$external/libfdt/libfdt.\-h$>$}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static unsigned \hyperlink{almo1-mips_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\-\_\-base\-\_\-address} (void $\ast$fdt, int offset)
\begin{DoxyCompactList}\small\item\em Get the base address of a F\-D\-T device node (reg property) T\-O\-D\-O\-: take in account the cells attribute of a node. \end{DoxyCompactList}\item 
static unsigned \hyperlink{almo1-mips_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}{get\-\_\-irq} (void $\ast$fdt, int offset)
\begin{DoxyCompactList}\small\item\em Get the I\-R\-Q of a F\-D\-T device node (interrupts property) T\-O\-D\-O\-: handle multiple I\-R\-Qs per node. \end{DoxyCompactList}\item 
static void \hyperlink{almo1-mips_2soc_8c_a4c268c213e6a62adfab96031629fa015}{soc\-\_\-icu\-\_\-init} (void $\ast$fdt)
\begin{DoxyCompactList}\small\item\em Initialize I\-C\-Us described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. \end{DoxyCompactList}\item 
static int \hyperlink{almo1-mips_2soc_8c_a05f9476d07e118d280add6f5e3de365b}{soc\-\_\-tty\-\_\-init} (void $\ast$fdt)
\begin{DoxyCompactList}\small\item\em Initialize the T\-T\-Ys present on the S\-O\-C based on the device-\/tree content Basically, every device initialization follow the same process\-: We loop on each device compatible with our drivers for this platform, by exemple soclib,tty For each device, we find it's base address in the reg property of the device tree node and its I\-R\-Q in the interrupts property. Once we've fetched this data, we allocate a new device (see hal/dev.\-h) and register it in the device list. We then setup the device with a device-\/specific function declared by the H\-A\-L (ex\-: tty\-\_\-init) Last thing we do is unmask the interrupt in the I\-C\-U and register the I\-S\-R for the device. \end{DoxyCompactList}\item 
static int \hyperlink{almo1-mips_2soc_8c_aeb589179b71725cd918f71b4f23b21d2}{soc\-\_\-timer\-\_\-init} (void $\ast$fdt, unsigned tick)
\begin{DoxyCompactList}\small\item\em Initialize timers described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. \end{DoxyCompactList}\item 
static void \hyperlink{almo1-mips_2soc_8c_a5fb66f75ca9173a1a6dd99fc4be6706b}{soc\-\_\-dma\-\_\-init} (void $\ast$fdt)
\begin{DoxyCompactList}\small\item\em Initialize dmas described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. \end{DoxyCompactList}\item 
int \hyperlink{almo1-mips_2soc_8c_a436517497969d33b08925565d4cca572}{soc\-\_\-init} (void $\ast$fdt, int tick)
\begin{DoxyCompactList}\small\item\em For the So\-C almo1, I\-R\-Q n'x (that is I\-C\-U.\-P\-I\-N\mbox{[}x\mbox{]}) is wired to the Interrup Signal of device n'y. \end{DoxyCompactList}\item 
void \hyperlink{almo1-mips_2soc_8c_af2c90b7651cda327df23f561f6c6ebfd}{isrcall} ()
\begin{DoxyCompactList}\small\item\em This function calls the I\-S\-R of the highest priority I\-R\-Q It is called by the irq\-\_\-handler routine when a C\-P\-U is interrupted by an I\-R\-Q Its aims is to find out which I\-R\-Q is now active to know which device needs the C\-P\-U. and to launch the right I\-S\-R of the right device instance by using I\-R\-Q\-Vector tables. T\-O\-D\-O\-: maybe this should also be a \char`\"{}standard\char`\"{} function, declared in a H\-A\-L file. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{almo1-mips_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{\index{almo1-\/mips/soc.\-c@{almo1-\/mips/soc.\-c}!get\-\_\-base\-\_\-address@{get\-\_\-base\-\_\-address}}
\index{get\-\_\-base\-\_\-address@{get\-\_\-base\-\_\-address}!almo1-mips/soc.c@{almo1-\/mips/soc.\-c}}
\subsubsection[{get\-\_\-base\-\_\-address}]{\setlength{\rightskip}{0pt plus 5cm}static unsigned get\-\_\-base\-\_\-address (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{int}]{offset}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{almo1-mips_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}


Get the base address of a F\-D\-T device node (reg property) T\-O\-D\-O\-: take in account the cells attribute of a node. 


\begin{DoxyParams}{Parameters}
{\em fdt} & address of the F\-D\-T in memory \\
\hline
{\em offset} & offset of the node in the F\-D\-T \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
the address contained by the reg property 
\end{DoxyReturn}


References fdt32\-\_\-to\-\_\-cpu(), fdt\-\_\-getprop(), and N\-U\-L\-L.



Referenced by soc\-\_\-dma\-\_\-init(), soc\-\_\-icu\-\_\-init(), soc\-\_\-timer\-\_\-init(), and soc\-\_\-tty\-\_\-init().


\begin{DoxyCode}
35 \{
36     \textcolor{keywordflow}{return} \hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(
37         *(\textcolor{keywordtype}{unsigned} *) \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdt, offset, \textcolor{stringliteral}{"reg"}, \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
38 \}
\end{DoxyCode}
\hypertarget{almo1-mips_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}{\index{almo1-\/mips/soc.\-c@{almo1-\/mips/soc.\-c}!get\-\_\-irq@{get\-\_\-irq}}
\index{get\-\_\-irq@{get\-\_\-irq}!almo1-mips/soc.c@{almo1-\/mips/soc.\-c}}
\subsubsection[{get\-\_\-irq}]{\setlength{\rightskip}{0pt plus 5cm}static unsigned get\-\_\-irq (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{int}]{offset}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{almo1-mips_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}


Get the I\-R\-Q of a F\-D\-T device node (interrupts property) T\-O\-D\-O\-: handle multiple I\-R\-Qs per node. 


\begin{DoxyParams}{Parameters}
{\em fdt} & address of the F\-D\-T in memory \\
\hline
{\em offset} & offset of the node in the F\-D\-T \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
the I\-R\-Q contained by the interrupts property 
\end{DoxyReturn}


References fdt32\-\_\-to\-\_\-cpu(), fdt\-\_\-getprop(), and N\-U\-L\-L.



Referenced by soc\-\_\-timer\-\_\-init(), and soc\-\_\-tty\-\_\-init().


\begin{DoxyCode}
48 \{
49     \textcolor{keywordflow}{return} \hyperlink{libfdt__env_8h_a6485ea7225a1927cc5ab1a34dabe298f}{fdt32\_to\_cpu}(
50         *(\textcolor{keywordtype}{unsigned} *) \hyperlink{fdt__ro_8c_a0a72997fe1eb5a57885bbb988256d08f}{fdt\_getprop}(fdt, offset, \textcolor{stringliteral}{"interrupts"}, \hyperlink{kfs_8c_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
51 \}
\end{DoxyCode}
\hypertarget{almo1-mips_2soc_8c_af2c90b7651cda327df23f561f6c6ebfd}{\index{almo1-\/mips/soc.\-c@{almo1-\/mips/soc.\-c}!isrcall@{isrcall}}
\index{isrcall@{isrcall}!almo1-mips/soc.c@{almo1-\/mips/soc.\-c}}
\subsubsection[{isrcall}]{\setlength{\rightskip}{0pt plus 5cm}void isrcall (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{almo1-mips_2soc_8c_af2c90b7651cda327df23f561f6c6ebfd}


This function calls the I\-S\-R of the highest priority I\-R\-Q It is called by the irq\-\_\-handler routine when a C\-P\-U is interrupted by an I\-R\-Q Its aims is to find out which I\-R\-Q is now active to know which device needs the C\-P\-U. and to launch the right I\-S\-R of the right device instance by using I\-R\-Q\-Vector tables. T\-O\-D\-O\-: maybe this should also be a \char`\"{}standard\char`\"{} function, declared in a H\-A\-L file. 



References cpuid, icu\-\_\-get, icu\-\_\-ops\-\_\-s\-::icu\-\_\-get\-\_\-highest, icu\-\_\-s\-::ops, and route\-\_\-interrupt().


\begin{DoxyCode}
223 \{
224     \textcolor{keyword}{struct }\hyperlink{structicu__s}{icu\_s} *icu = \hyperlink{icu_8h_a8ea2773b171799420c4542ff4e3bac3c}{icu\_get}(\hyperlink{mips_2cpuregs_8S_a78a056c2e0d1097b3c4d7e569b8cdc0a}{cpuid}());           \textcolor{comment}{// get the ICU which has dev.no ==
       cpuid()}
225     \textcolor{keywordtype}{int} irq = icu->\hyperlink{structicu__s_a7f989a94a922fa1c782cfcf7547bd8c5}{ops}->\hyperlink{structicu__ops__s_a7aa5d37f9a8ef9f3e59211ff5ab213c0}{icu\_get\_highest}(icu);       \textcolor{comment}{// IRQ nb with the highest prio}
226     \hyperlink{kirq_8c_aa9ad3c6e921343d32bd93189e56344ac}{route\_interrupt}(irq);                           \textcolor{comment}{// launch the ISR for the bound device}
227 \}
\end{DoxyCode}
\hypertarget{almo1-mips_2soc_8c_a5fb66f75ca9173a1a6dd99fc4be6706b}{\index{almo1-\/mips/soc.\-c@{almo1-\/mips/soc.\-c}!soc\-\_\-dma\-\_\-init@{soc\-\_\-dma\-\_\-init}}
\index{soc\-\_\-dma\-\_\-init@{soc\-\_\-dma\-\_\-init}!almo1-mips/soc.c@{almo1-\/mips/soc.\-c}}
\subsubsection[{soc\-\_\-dma\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static void soc\-\_\-dma\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{almo1-mips_2soc_8c_a5fb66f75ca9173a1a6dd99fc4be6706b}


Initialize dmas described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. 


\begin{DoxyParams}{Parameters}
{\em fdt} & fdt address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
nothing 
\end{DoxyReturn}


References dma\-\_\-alloc, dma\-\_\-ops\-\_\-s\-::dma\-\_\-init, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-node\-\_\-offset\-\_\-by\-\_\-compatible(), get\-\_\-base\-\_\-address(), and Soclib\-D\-M\-A\-Ops.



Referenced by soc\-\_\-init().


\begin{DoxyCode}
159 \{
160     \textcolor{comment}{// TODO: handle DMA interrupts}
161     \textcolor{keywordtype}{int} dma\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, -1, \textcolor{stringliteral}{"soclib,dma"});
162     \textcolor{keywordflow}{while} (dma\_off != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND}) \{
163         \textcolor{keywordtype}{unsigned} addr = \hyperlink{almo1-mips_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\_base\_address}(fdt, dma\_off);
164 
165         \textcolor{keyword}{struct }\hyperlink{structdma__s}{dma\_s} *dma = \hyperlink{dma_8h_af17023464eb4ace08274aa4adfdeb042}{dma\_alloc}();
166         \hyperlink{soclib-dma_8c_a80351df0b0525153b84f567f1d5c77d1}{SoclibDMAOps}.\hyperlink{structdma__ops__s_aa1ac2356cd662860a73d46a0d140154f}{dma\_init}(dma, addr);
167 
168         dma\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, dma\_off, \textcolor{stringliteral}{"soclib,dma"});
169     \}
170 \}
\end{DoxyCode}
\hypertarget{almo1-mips_2soc_8c_a4c268c213e6a62adfab96031629fa015}{\index{almo1-\/mips/soc.\-c@{almo1-\/mips/soc.\-c}!soc\-\_\-icu\-\_\-init@{soc\-\_\-icu\-\_\-init}}
\index{soc\-\_\-icu\-\_\-init@{soc\-\_\-icu\-\_\-init}!almo1-mips/soc.c@{almo1-\/mips/soc.\-c}}
\subsubsection[{soc\-\_\-icu\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static void soc\-\_\-icu\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{almo1-mips_2soc_8c_a4c268c213e6a62adfab96031629fa015}


Initialize I\-C\-Us described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. 


\begin{DoxyParams}{Parameters}
{\em fdt} & fdt address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
nothing 
\end{DoxyReturn}


References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-node\-\_\-offset\-\_\-by\-\_\-compatible(), get\-\_\-base\-\_\-address(), icu\-\_\-alloc, icu\-\_\-ops\-\_\-s\-::icu\-\_\-init, and Soclib\-I\-C\-U\-Ops.



Referenced by soc\-\_\-init().


\begin{DoxyCode}
60 \{
61     \textcolor{keywordtype}{int} icu\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, -1, \textcolor{stringliteral}{"soclib,icu"});
62     \textcolor{keywordflow}{while} (icu\_off != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND}) \{
63         \textcolor{keywordtype}{unsigned} addr = \hyperlink{almo1-mips_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\_base\_address}(fdt, icu\_off);
64 
65         \textcolor{keyword}{struct }\hyperlink{structicu__s}{icu\_s} *icu = \hyperlink{icu_8h_a288933830f60a333ea46fd2252b8120e}{icu\_alloc}();
66         \hyperlink{icu_2soclib-icu_8c_a57148fb85883dc5ca0480a7b55398c58}{SoclibICUOps}.\hyperlink{structicu__ops__s_acfb85f348f0664db040ecc73ebbd5cc7}{icu\_init}(icu, addr);
67 
68         icu\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, icu\_off, \textcolor{stringliteral}{"soclib,icu"});
69     \}
70 \}
\end{DoxyCode}
\hypertarget{almo1-mips_2soc_8c_a436517497969d33b08925565d4cca572}{\index{almo1-\/mips/soc.\-c@{almo1-\/mips/soc.\-c}!soc\-\_\-init@{soc\-\_\-init}}
\index{soc\-\_\-init@{soc\-\_\-init}!almo1-mips/soc.c@{almo1-\/mips/soc.\-c}}
\subsubsection[{soc\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}int soc\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{int}]{tick}
\end{DoxyParamCaption}
)}}\label{almo1-mips_2soc_8c_a436517497969d33b08925565d4cca572}


For the So\-C almo1, I\-R\-Q n'x (that is I\-C\-U.\-P\-I\-N\mbox{[}x\mbox{]}) is wired to the Interrup Signal of device n'y. 

Request the initialization of all the architecture of the S\-O\-C This function configures each used devices and configures which I\-R\-Q are used and how they are connected to the C\-P\-U thanks to the I\-C\-U Mask.

There are at most 14 I\-R\-Qs for almo1, but the real number depends of the prototype paramaters There are as many timers as C\-P\-U, thus N\-C\-P\-U\-S timers There are Nicus ttys There are also a D\-M\-A to perfom memcpy and optionnal Block Device (hard drive)

Device I\-R\-Qs are wired as following\-:
\begin{DoxyItemize}
\item I\-C\-U.\-P\-I\-N \mbox{[}0\mbox{]} \-: timer 0 \char`\"{}     \char`\"{} " depending on N\-C\-P\-U\-S (0 to 7)
\item I\-C\-U.\-P\-I\-N \mbox{[}7\mbox{]} \-: timer 7
\item I\-C\-U.\-P\-I\-N \mbox{[}8\mbox{]} \-: bd Bloc Device (Hard Drive)
\item I\-C\-U.\-P\-I\-N \mbox{[}9\mbox{]} \-: dma Direct Memory Access (Hard memcpy)
\item I\-C\-U.\-P\-I\-N \mbox{[}10\mbox{]} \-: T\-T\-Y0 T\-T\-Y n'0 \char`\"{}     \char`\"{} " depending on N\-T\-T\-Y\-S (0 to 3)
\item I\-C\-U.\-P\-I\-N \mbox{[}13\mbox{]} \-: T\-T\-Y3 
\begin{DoxyParams}{Parameters}
{\em tick} & number of ticks between two timer interrupts \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
-\/1 if the initialization failed, 0 if it succeeded 
\end{DoxyReturn}

\end{DoxyItemize}

Referenced by kinit().


\begin{DoxyCode}
193 \{
194     \textcolor{keywordflow}{if} (\hyperlink{libfdt_8h_a783c67f6971d10232c84ecd0aa76f461}{fdt\_magic}(fdt) != 0xd00dfeed)
195         \textcolor{keywordflow}{return} -1;
196 
197     \textcolor{comment}{// We MUST initialize the ICU first since every other device}
198     \textcolor{comment}{// initialization will rely on it for its interrupts}
199     \hyperlink{almo1-mips_2soc_8c_a4c268c213e6a62adfab96031629fa015}{soc\_icu\_init}(fdt);
200 
201     \textcolor{comment}{// Initialize TTY early so we can debug as soon as possible}
202     \textcolor{keywordflow}{if} (\hyperlink{almo1-mips_2soc_8c_a05f9476d07e118d280add6f5e3de365b}{soc\_tty\_init}(fdt) < 0)
203         \textcolor{keywordflow}{return} -1;
204 
205     \hyperlink{almo1-mips_2soc_8c_a5fb66f75ca9173a1a6dd99fc4be6706b}{soc\_dma\_init}(fdt);
206 
207     \textcolor{comment}{// Finish by the timer (we don't want to schedule anything until everything}
208     \textcolor{comment}{// is initialized)}
209     \textcolor{keywordflow}{if} (\hyperlink{almo1-mips_2soc_8c_aeb589179b71725cd918f71b4f23b21d2}{soc\_timer\_init}(fdt, tick) < 0)
210         \textcolor{keywordflow}{return} -1;
211 
212     \textcolor{keywordflow}{return} 0;
213 \}
\end{DoxyCode}
\hypertarget{almo1-mips_2soc_8c_aeb589179b71725cd918f71b4f23b21d2}{\index{almo1-\/mips/soc.\-c@{almo1-\/mips/soc.\-c}!soc\-\_\-timer\-\_\-init@{soc\-\_\-timer\-\_\-init}}
\index{soc\-\_\-timer\-\_\-init@{soc\-\_\-timer\-\_\-init}!almo1-mips/soc.c@{almo1-\/mips/soc.\-c}}
\subsubsection[{soc\-\_\-timer\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static int soc\-\_\-timer\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt, }
\item[{unsigned}]{tick}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{almo1-mips_2soc_8c_aeb589179b71725cd918f71b4f23b21d2}


Initialize timers described by the device tree See the soc\-\_\-tty\-\_\-init function for a detailed explanation. 


\begin{DoxyParams}{Parameters}
{\em fdt} & fdt address \\
\hline
{\em tick} & number of ticks between two timer interrupts \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
-\/1 if the initialization failed, 0 if it succeeded 
\end{DoxyReturn}


References F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-node\-\_\-offset\-\_\-by\-\_\-compatible(), get\-\_\-base\-\_\-address(), get\-\_\-irq(), icu\-\_\-get, icu\-\_\-ops\-\_\-s\-::icu\-\_\-unmask, timer\-\_\-s\-::ops, icu\-\_\-s\-::ops, register\-\_\-interrupt(), soclib\-\_\-timer\-\_\-isr(), Soclib\-Timer\-Ops, thread\-\_\-yield(), timer\-\_\-alloc, timer\-\_\-ops\-\_\-s\-::timer\-\_\-init, and timer\-\_\-ops\-\_\-s\-::timer\-\_\-set\-\_\-event.



Referenced by soc\-\_\-init().


\begin{DoxyCode}
126 \{
127     \textcolor{comment}{// Fetch the ICU device}
128     \textcolor{keyword}{struct }\hyperlink{structicu__s}{icu\_s} *icu = \hyperlink{icu_8h_a8ea2773b171799420c4542ff4e3bac3c}{icu\_get}(0);
129     \textcolor{keywordflow}{if} (!icu)
130         \textcolor{keywordflow}{return} -1;
131 
132     \textcolor{keywordtype}{int} timer\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, -1, \textcolor{stringliteral}{"soclib,timer"});
133 
134     \textcolor{keywordflow}{while} (timer\_off != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND}) \{
135         \textcolor{keywordtype}{unsigned} addr = \hyperlink{almo1-mips_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\_base\_address}(fdt, timer\_off);
136         \textcolor{keywordtype}{unsigned} irq = \hyperlink{almo1-mips_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}{get\_irq}(fdt, timer\_off);
137 
138         \textcolor{keyword}{struct }\hyperlink{structtimer__s}{timer\_s} *timer = \hyperlink{timer_8h_a9b16e7c947532969c0eb7525c66405f6}{timer\_alloc}();
139         \hyperlink{soclib-timer_8c_aa3f96a0578c32ac8fd0d3b2526182084}{SoclibTimerOps}.\hyperlink{structtimer__ops__s_a0eb1142effbe0998fda5c43a6650dc93}{timer\_init}(timer, addr, tick);
140         timer->\hyperlink{structtimer__s_a859db5220e0605eabaa9100121940b5e}{ops}->\hyperlink{structtimer__ops__s_a68a024355e7c40dc7cf97b0e9975cf73}{timer\_set\_event}(timer,
141             (\textcolor{keywordtype}{void} (*)(\textcolor{keywordtype}{void} *)) \hyperlink{kthread_8c_affe2eebf6749bc36765d45ff48c926b1}{thread\_yield}, (\textcolor{keywordtype}{void} *) 0);
142 
143         icu->\hyperlink{structicu__s_a7f989a94a922fa1c782cfcf7547bd8c5}{ops}->\hyperlink{structicu__ops__s_a4aee28cc809733a67481e782c1efd1fa}{icu\_unmask}(icu, irq);
144         \hyperlink{kirq_8c_a7bb6fb99500c6f10708c7653cef722e8}{register\_interrupt}(irq, (\hyperlink{kirq_8h_a6c476c213249d7236d7888257e71628d}{isr\_t}) \hyperlink{soclib-timer_8c_ad4d0316e8dbbe5427118ba5a8a03f12d}{soclib\_timer\_isr}, timer);
145 
146         timer\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, timer\_off, \textcolor{stringliteral}{"
      soclib,timer"});
147     \}
148 
149     \textcolor{keywordflow}{return} 0;
150 \}
\end{DoxyCode}
\hypertarget{almo1-mips_2soc_8c_a05f9476d07e118d280add6f5e3de365b}{\index{almo1-\/mips/soc.\-c@{almo1-\/mips/soc.\-c}!soc\-\_\-tty\-\_\-init@{soc\-\_\-tty\-\_\-init}}
\index{soc\-\_\-tty\-\_\-init@{soc\-\_\-tty\-\_\-init}!almo1-mips/soc.c@{almo1-\/mips/soc.\-c}}
\subsubsection[{soc\-\_\-tty\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static int soc\-\_\-tty\-\_\-init (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{fdt}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{almo1-mips_2soc_8c_a05f9476d07e118d280add6f5e3de365b}


Initialize the T\-T\-Ys present on the S\-O\-C based on the device-\/tree content Basically, every device initialization follow the same process\-: We loop on each device compatible with our drivers for this platform, by exemple soclib,tty For each device, we find it's base address in the reg property of the device tree node and its I\-R\-Q in the interrupts property. Once we've fetched this data, we allocate a new device (see hal/dev.\-h) and register it in the device list. We then setup the device with a device-\/specific function declared by the H\-A\-L (ex\-: tty\-\_\-init) Last thing we do is unmask the interrupt in the I\-C\-U and register the I\-S\-R for the device. 


\begin{DoxyParams}{Parameters}
{\em fdt} & fdt address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
-\/1 if the initialization failed, 0 if it succeeded 
\end{DoxyReturn}


References chardev\-\_\-alloc, chardev\-\_\-ops\-\_\-s\-::chardev\-\_\-init, F\-D\-T\-\_\-\-E\-R\-R\-\_\-\-N\-O\-T\-F\-O\-U\-N\-D, fdt\-\_\-node\-\_\-offset\-\_\-by\-\_\-compatible(), get\-\_\-base\-\_\-address(), get\-\_\-irq(), icu\-\_\-get, icu\-\_\-ops\-\_\-s\-::icu\-\_\-unmask, icu\-\_\-s\-::ops, register\-\_\-interrupt(), soclib\-\_\-tty\-\_\-isr(), and Soclib\-T\-T\-Y\-Ops.



Referenced by soc\-\_\-init().


\begin{DoxyCode}
86 \{
87     \textcolor{comment}{// Fetch the ICU device}
88     \textcolor{keyword}{struct }\hyperlink{structicu__s}{icu\_s} *icu = \hyperlink{icu_8h_a8ea2773b171799420c4542ff4e3bac3c}{icu\_get}(0);
89     \textcolor{comment}{// Check that the ICU has already been initialized}
90     \textcolor{keywordflow}{if} (!icu)
91         \textcolor{keywordflow}{return} -1;
92 
93     \textcolor{comment}{// Find the first TTY device}
94     \textcolor{keywordtype}{int} tty\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, -1, \textcolor{stringliteral}{"soclib,tty"});
95 
96     \textcolor{comment}{// Loop until we can't find any more compatible ttys in the device tree}
97     \textcolor{keywordflow}{while} (tty\_off != -\hyperlink{libfdt_8h_a93cfa052f4b28df4bfc7d336b692fa07}{FDT\_ERR\_NOTFOUND}) \{
98         \textcolor{comment}{// Fetch the necessary properties from the device tree}
99         \textcolor{keywordtype}{unsigned} addr = \hyperlink{almo1-mips_2soc_8c_a8f32c2785fa3edd070abdaa34c96f6a7}{get\_base\_address}(fdt, tty\_off);
100         \textcolor{keywordtype}{unsigned} irq = \hyperlink{almo1-mips_2soc_8c_a7bd21ef4af7971db5dad06231290d8d1}{get\_irq}(fdt, tty\_off);
101 
102         \textcolor{comment}{// Allocate the structure and add it in the global device list}
103         \textcolor{keyword}{struct }\hyperlink{structchardev__s}{chardev\_s} *tty = \hyperlink{chardev_8h_a0f9abac4f27deb18dd30410b33ba7e72}{chardev\_alloc}();
104         \textcolor{comment}{// Initialize the device}
105         \hyperlink{soclib-tty_8c_ac60ea3e14652d47e0814fac85c18b2ff}{SoclibTTYOps}.\hyperlink{structchardev__ops__s_acde8ff309c1553a2209756737f2b2d31}{chardev\_init}(tty, addr, 0);
106         \textcolor{comment}{// Unmask the interrupt}
107         icu->\hyperlink{structicu__s_a7f989a94a922fa1c782cfcf7547bd8c5}{ops}->\hyperlink{structicu__ops__s_a4aee28cc809733a67481e782c1efd1fa}{icu\_unmask}(icu, irq);
108         \textcolor{comment}{// Register the corresponding ISR}
109         \hyperlink{kirq_8c_a7bb6fb99500c6f10708c7653cef722e8}{register\_interrupt}(irq, (\hyperlink{kirq_8h_a6c476c213249d7236d7888257e71628d}{isr\_t}) \hyperlink{soclib-tty_8c_abee08020bafa1f698839a8d477dcdafa}{soclib\_tty\_isr}, tty);
110 
111         \textcolor{comment}{// Find the next compatible tty}
112         tty\_off = \hyperlink{fdt__ro_8c_a7fee20e876e2af4dd32e987c6c8f104a}{fdt\_node\_offset\_by\_compatible}(fdt, tty\_off, \textcolor{stringliteral}{"soclib,tty"});
113     \}
114 
115     \textcolor{keywordflow}{return} 0;
116 \}
\end{DoxyCode}
