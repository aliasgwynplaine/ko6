<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>ko6: /users/enseig/franck/ko6/src/soft/kernel/kthread.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo55.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ko6
   </div>
   <div id="projectbrief">ko6 (prononce it &#39;kit-O-sys&#39; O is  the letter not the number) is a small operating system for educationnal purpose</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_8785740846211ac34fd04c61a1fdd888.html">soft</a></li><li class="navelem"><a class="el" href="dir_f1add7e60d3117fa5e9acdff1c3c9be3.html">kernel</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">kthread.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><a href="kthread_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a425c1da89e5866d87fc20a624da7cbec"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a425c1da89e5866d87fc20a624da7cbec">THREAD_MAX</a>&#160;&#160;&#160;4</td></tr>
<tr class="separator:a425c1da89e5866d87fc20a624da7cbec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab47e8c012560fa0368dfd3f6e45e07b5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#ab47e8c012560fa0368dfd3f6e45e07b5">TH_TYPE_USER</a>&#160;&#160;&#160;0       /* Most of threads belongs to the user */</td></tr>
<tr class="separator:ab47e8c012560fa0368dfd3f6e45e07b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad90e71a21f2353f675f63fee7aff63a7"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#ad90e71a21f2353f675f63fee7aff63a7">TH_TYPE_KERNEL</a>&#160;&#160;&#160;1       /* There are a few kernel's threads, p.ex. for kshell  */</td></tr>
<tr class="separator:ad90e71a21f2353f675f63fee7aff63a7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a83c4c9d919043cd3b5bac98b7250d506"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a83c4c9d919043cd3b5bac98b7250d506">TH_STATE_RUNNING</a>&#160;&#160;&#160;0       /* there is at most one thread per processor */</td></tr>
<tr class="separator:a83c4c9d919043cd3b5bac98b7250d506"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1887e40b17ecfda05b4a398375d527fb"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>&#160;&#160;&#160;1       /* threads that need the processor */</td></tr>
<tr class="separator:a1887e40b17ecfda05b4a398375d527fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeae3234bde1a15d5c671a41286949bc5"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#aeae3234bde1a15d5c671a41286949bc5">TH_STATE_DEAD</a>&#160;&#160;&#160;2       /* threads that have exited and whose retval has been <a class="el" href="libc_8h.html#aec19a0626d6167a834fa9f5b25214f7f">read</a> */</td></tr>
<tr class="separator:aeae3234bde1a15d5c671a41286949bc5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a75c1c2f7da0a338d818a2950b582b74a"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a>&#160;&#160;&#160;3       /* threads that is waiting for something to run again */</td></tr>
<tr class="separator:a75c1c2f7da0a338d818a2950b582b74a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55287315008b2fea47936dc065bbabb7"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a>&#160;&#160;&#160;4       /* threads that are exited but their retval is not yet <a class="el" href="libc_8h.html#aec19a0626d6167a834fa9f5b25214f7f">read</a> */</td></tr>
<tr class="separator:a55287315008b2fea47936dc065bbabb7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a755fbb4a945decf90cb1c0eb5fd16878"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structthread__s.html">thread_s</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a></td></tr>
<tr class="memdesc:a755fbb4a945decf90cb1c0eb5fd16878"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hidden definition of thread_t, other C files don't know what is in the struct <a class="el" href="structthread__s.html" title="thread_s structure which contains all we need to define a thread the size of thread_s struct is a mul...">thread_s</a>.  <a href="#a755fbb4a945decf90cb1c0eb5fd16878">More...</a><br/></td></tr>
<tr class="separator:a755fbb4a945decf90cb1c0eb5fd16878"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a915acd568076749f98a0878936790ca4"><td class="memItemLeft" align="right" valign="top">long long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a915acd568076749f98a0878936790ca4">thread_randseed_set</a> (long long seed)</td></tr>
<tr class="memdesc:a915acd568076749f98a0878936790ca4"><td class="mdescLeft">&#160;</td><td class="mdescRight">set the seed for the current running thread  <a href="#a915acd568076749f98a0878936790ca4">More...</a><br/></td></tr>
<tr class="separator:a915acd568076749f98a0878936790ca4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4bf00d3ebfff22db494125012393cddf"><td class="memItemLeft" align="right" valign="top">long long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a4bf00d3ebfff22db494125012393cddf">thread_randseed_get</a> (void)</td></tr>
<tr class="memdesc:a4bf00d3ebfff22db494125012393cddf"><td class="mdescLeft">&#160;</td><td class="mdescRight">get the seed for the current running thread  <a href="#a4bf00d3ebfff22db494125012393cddf">More...</a><br/></td></tr>
<tr class="separator:a4bf00d3ebfff22db494125012393cddf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3ecc03b8319efabea835c1205c8fff4d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a3ecc03b8319efabea835c1205c8fff4d">thread_addlast</a> (<a class="el" href="list_8h.html#ad3b2684139c847cd572cb7b9679ce227">list_t</a> *root, <a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> thread)</td></tr>
<tr class="separator:a3ecc03b8319efabea835c1205c8fff4d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a79b0f0a19a09db45e1689ff011f6109b"><td class="memItemLeft" align="right" valign="top"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a79b0f0a19a09db45e1689ff011f6109b">thread_item</a> (<a class="el" href="list_8h.html#ad3b2684139c847cd572cb7b9679ce227">list_t</a> *item)</td></tr>
<tr class="separator:a79b0f0a19a09db45e1689ff011f6109b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a02cfe68dc8f379c88d448172f997b09e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump</a> (void)</td></tr>
<tr class="memdesc:a02cfe68dc8f379c88d448172f997b09e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Displays on the console (tty0) all active threads, it is for debugging.  <a href="#a02cfe68dc8f379c88d448172f997b09e">More...</a><br/></td></tr>
<tr class="separator:a02cfe68dc8f379c88d448172f997b09e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a227d30321d9dddb518fe5d116aa7d90b"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a227d30321d9dddb518fe5d116aa7d90b">thread_create</a> (<a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> *thread, int fun, int arg, int start)</td></tr>
<tr class="memdesc:a227d30321d9dddb518fe5d116aa7d90b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calls by the kernel in order to implement the user <a class="el" href="kthread_8c.html#a2525e99272c4db4198bcea374d717620" title="Calls by the kernel in order to implement the user thread_create() syscall This function has the same...">thread_create()</a> syscall This function has the same arguments as <a class="el" href="kthread_8c.html#a2525e99272c4db4198bcea374d717620" title="Calls by the kernel in order to implement the user thread_create() syscall This function has the same...">thread_create()</a>, plus one which is the pointer to the function that will start the thread, there are two of those: one for the main thread (nammed _start defined in <a class="el" href="crt0_8c.html">crt0.c</a>) and one for the standard thread (nammed thread_start defined in thread.c). These two functions do not have the same type but it does not matter because we are converting to int.  <a href="#a227d30321d9dddb518fe5d116aa7d90b">More...</a><br/></td></tr>
<tr class="separator:a227d30321d9dddb518fe5d116aa7d90b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a95c63c8faef6c13da432a94800ad2acb"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a95c63c8faef6c13da432a94800ad2acb">thread_main_load</a> (<a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> thread)</td></tr>
<tr class="memdesc:a95c63c8faef6c13da432a94800ad2acb"><td class="mdescLeft">&#160;</td><td class="mdescRight">load the context of the <a class="el" href="ktools_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a> thread, only used by kinit  <a href="#a95c63c8faef6c13da432a94800ad2acb">More...</a><br/></td></tr>
<tr class="separator:a95c63c8faef6c13da432a94800ad2acb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:affe2eebf6749bc36765d45ff48c926b1"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#affe2eebf6749bc36765d45ff48c926b1">thread_yield</a> (void)</td></tr>
<tr class="memdesc:affe2eebf6749bc36765d45ff48c926b1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Causes the current thread to give up the CPU in order to give it to another.  <a href="#affe2eebf6749bc36765d45ff48c926b1">More...</a><br/></td></tr>
<tr class="separator:affe2eebf6749bc36765d45ff48c926b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a19b16adf05364471bae2840aa564329a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a19b16adf05364471bae2840aa564329a">thread_exit</a> (void *retval)</td></tr>
<tr class="memdesc:a19b16adf05364471bae2840aa564329a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Terminates the current thread, it never returns (see details in <a class="el" href="kthread_8c.html">kthread.c</a>)  <a href="#a19b16adf05364471bae2840aa564329a">More...</a><br/></td></tr>
<tr class="separator:a19b16adf05364471bae2840aa564329a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9cff35af30e36a1fc0381f648ab9a976"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a9cff35af30e36a1fc0381f648ab9a976">thread_join</a> (<a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> thread, void **retval)</td></tr>
<tr class="memdesc:a9cff35af30e36a1fc0381f648ab9a976"><td class="mdescLeft">&#160;</td><td class="mdescRight">Wait for a thread termination (see details in <a class="el" href="kthread_8c.html">kthread.c</a>)  <a href="#a9cff35af30e36a1fc0381f648ab9a976">More...</a><br/></td></tr>
<tr class="separator:a9cff35af30e36a1fc0381f648ab9a976"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0c0fd0ef94a8688f65d53216ae6c33e7"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a0c0fd0ef94a8688f65d53216ae6c33e7">thread_wait</a> (void)</td></tr>
<tr class="memdesc:a0c0fd0ef94a8688f65d53216ae6c33e7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a>. In some cases, when <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> is called just before <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> has had time to put the current thread in the WAIT state (this is possible, since <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> is called by another thread running on another processor) then the current thread is already READY but <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> yields the processor anyway, so the current thread should lose the processor for a while, until the scheduler chooses it again.  <a href="#a0c0fd0ef94a8688f65d53216ae6c33e7">More...</a><br/></td></tr>
<tr class="separator:a0c0fd0ef94a8688f65d53216ae6c33e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc9196e88e8db0daa5b13544cfe62996"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#acc9196e88e8db0daa5b13544cfe62996">thread_notify</a> (<a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> thread)</td></tr>
<tr class="memdesc:acc9196e88e8db0daa5b13544cfe62996"><td class="mdescLeft">&#160;</td><td class="mdescRight">Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a>. In some cases, when <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> is called just before <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> has had time to put the current thread in the WAIT state (this is possible, since <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> is called by another thread running on another processor) then the current thread is already READY but <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> yields the processor anyway, so the current thread should lose the processor for a while, until the scheduler chooses it again.  <a href="#acc9196e88e8db0daa5b13544cfe62996">More...</a><br/></td></tr>
<tr class="separator:acc9196e88e8db0daa5b13544cfe62996"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac0393114fc2fb6571188e9c619042c46"><td class="memItemLeft" align="right" valign="top">int *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#ac0393114fc2fb6571188e9c619042c46">thread_errno</a> (<a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> thread)</td></tr>
<tr class="memdesc:ac0393114fc2fb6571188e9c619042c46"><td class="mdescLeft">&#160;</td><td class="mdescRight">return address of errno for the thread given this function is defined here, because it needs to access at the hidden thread struct  <a href="#ac0393114fc2fb6571188e9c619042c46">More...</a><br/></td></tr>
<tr class="separator:ac0393114fc2fb6571188e9c619042c46"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac8ecc48f4f6134c6118c90a593b187bc"><td class="memItemLeft" align="right" valign="top">unsigned long long *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#ac8ecc48f4f6134c6118c90a593b187bc">thread_krandseed</a> (<a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> thread)</td></tr>
<tr class="memdesc:ac8ecc48f4f6134c6118c90a593b187bc"><td class="mdescLeft">&#160;</td><td class="mdescRight">return address of krandseed for the thread given this function is defined here, because it needs to access at the hidden thread struct  <a href="#ac8ecc48f4f6134c6118c90a593b187bc">More...</a><br/></td></tr>
<tr class="separator:ac8ecc48f4f6134c6118c90a593b187bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a1da5431310f6068f6d1113c402eff5f8"><td class="memItemLeft" align="right" valign="top"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="kthread_8h.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a></td></tr>
<tr class="memdesc:a1da5431310f6068f6d1113c402eff5f8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Pointeur to the current RUNNING thread (only one per processor) TODO should be an array if there are several processor TODO add a variable to count the number of threads and check it when tbread_create.  <a href="#a1da5431310f6068f6d1113c402eff5f8">More...</a><br/></td></tr>
<tr class="separator:a1da5431310f6068f6d1113c402eff5f8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="aeae3234bde1a15d5c671a41286949bc5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TH_STATE_DEAD&#160;&#160;&#160;2       /* threads that have exited and whose retval has been <a class="el" href="libc_8h.html#aec19a0626d6167a834fa9f5b25214f7f">read</a> */</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="pthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump()</a>, and <a class="el" href="kthread_8h.html#a9cff35af30e36a1fc0381f648ab9a976">thread_join()</a>.</p>

</div>
</div>
<a class="anchor" id="a1887e40b17ecfda05b4a398375d527fb"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TH_STATE_READY&#160;&#160;&#160;1       /* threads that need the processor */</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="kthread_8c.html#ab9600d6716f732f0ca9bac066fa6ed7c">__attribute__()</a>, <a class="el" href="pthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump()</a>, <a class="el" href="kthread_8h.html#a227d30321d9dddb518fe5d116aa7d90b">thread_create()</a>, <a class="el" href="kthread_8h.html#a19b16adf05364471bae2840aa564329a">thread_exit()</a>, <a class="el" href="kthread_8h.html#acc9196e88e8db0daa5b13544cfe62996">thread_notify()</a>, and <a class="el" href="kthread_8h.html#affe2eebf6749bc36765d45ff48c926b1">thread_yield()</a>.</p>

</div>
</div>
<a class="anchor" id="a83c4c9d919043cd3b5bac98b7250d506"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TH_STATE_RUNNING&#160;&#160;&#160;0       /* there is at most one thread per processor */</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="pthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump()</a>, <a class="el" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch()</a>, <a class="el" href="kthread_8c.html#ab6382c52388aa3e432787e2b9b4671bb">thread_bootstrap()</a>, and <a class="el" href="kthread_8h.html#a0c0fd0ef94a8688f65d53216ae6c33e7">thread_wait()</a>.</p>

</div>
</div>
<a class="anchor" id="a75c1c2f7da0a338d818a2950b582b74a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TH_STATE_WAIT&#160;&#160;&#160;3       /* threads that is waiting for something to run again */</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="pthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump()</a>, <a class="el" href="kthread_8h.html#a9cff35af30e36a1fc0381f648ab9a976">thread_join()</a>, and <a class="el" href="kthread_8h.html#a0c0fd0ef94a8688f65d53216ae6c33e7">thread_wait()</a>.</p>

</div>
</div>
<a class="anchor" id="a55287315008b2fea47936dc065bbabb7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TH_STATE_ZOMBIE&#160;&#160;&#160;4       /* threads that are exited but their retval is not yet <a class="el" href="libc_8h.html#aec19a0626d6167a834fa9f5b25214f7f">read</a> */</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="pthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump()</a>, <a class="el" href="kthread_8h.html#a19b16adf05364471bae2840aa564329a">thread_exit()</a>, and <a class="el" href="kthread_8h.html#a9cff35af30e36a1fc0381f648ab9a976">thread_join()</a>.</p>

</div>
</div>
<a class="anchor" id="ad90e71a21f2353f675f63fee7aff63a7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TH_TYPE_KERNEL&#160;&#160;&#160;1       /* There are a few kernel's threads, p.ex. for kshell  */</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="pthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump()</a>.</p>

</div>
</div>
<a class="anchor" id="ab47e8c012560fa0368dfd3f6e45e07b5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TH_TYPE_USER&#160;&#160;&#160;0       /* Most of threads belongs to the user */</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="pthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump()</a>.</p>

</div>
</div>
<a class="anchor" id="a425c1da89e5866d87fc20a624da7cbec"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define THREAD_MAX&#160;&#160;&#160;4</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="kthread_8c.html#ab9600d6716f732f0ca9bac066fa6ed7c">__attribute__()</a>, <a class="el" href="pthread_8h.html#a02cfe68dc8f379c88d448172f997b09e">sched_dump()</a>, and <a class="el" href="kthread_8c.html#ad094fddcf3208d43f3385ed2aa419c10">sched_insert()</a>.</p>

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a class="anchor" id="a755fbb4a945decf90cb1c0eb5fd16878"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structthread__s.html">thread_s</a>* <a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hidden definition of thread_t, other C files don't know what is in the struct <a class="el" href="structthread__s.html" title="thread_s structure which contains all we need to define a thread the size of thread_s struct is a mul...">thread_s</a>. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a02cfe68dc8f379c88d448172f997b09e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sched_dump </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Displays on the console (tty0) all active threads, it is for debugging. </p>
<div class="fragment"><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;{</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="keywordtype">char</span> *state_name[16] = {</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        [<a class="code" href="kthread_8h.html#a83c4c9d919043cd3b5bac98b7250d506">TH_STATE_RUNNING</a>] = <span class="stringliteral">&quot;RUNNING&quot;</span>,</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        [<a class="code" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>] = <span class="stringliteral">&quot;READY&quot;</span>,</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        [<a class="code" href="kthread_8h.html#aeae3234bde1a15d5c671a41286949bc5">TH_STATE_DEAD</a>] = <span class="stringliteral">&quot;DEAD&quot;</span>,</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        [<a class="code" href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a>] = <span class="stringliteral">&quot;WAIT&quot;</span>,</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        [<a class="code" href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a>] = <span class="stringliteral">&quot;ZOMBIE&quot;</span>,</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    };</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keywordtype">char</span> *type_name[16] = {</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        [<a class="code" href="kthread_8h.html#ab47e8c012560fa0368dfd3f6e45e07b5">TH_TYPE_USER</a>] = <span class="stringliteral">&quot;USER&quot;</span>,</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        [<a class="code" href="kthread_8h.html#ad90e71a21f2353f675f63fee7aff63a7">TH_TYPE_KERNEL</a>] = <span class="stringliteral">&quot;KERNEL&quot;</span>,</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    };</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<a class="code" href="kthread_8c.html#a798e4073d613ca5ba9618e1b3253df14">Y</a><span class="stringliteral">&quot;-------------------------- DUMP ALL THREADS ---------------------------\n&quot;</span>);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<a class="code" href="kthread_8c.html#a649b8f01fd6c0f47ff3cbddaeba63bfb">W</a><span class="stringliteral">&quot;thread current (&quot;</span><a class="code" href="kthread_8c.html#a2748566f4c443ee77aa831e63dbb5ebe">P</a><span class="stringliteral">&quot;) : &quot;</span><a class="code" href="kthread_8c.html#af316c33cc298530f245e8b55330e86b5">D</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>, <a class="code" href="kthread_8c.html#ae48ff9d5d8665f90c44ae6ad4acb5b6d">ThreadCurrentIdx</a>);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> th = 0; th &lt; <a class="code" href="kthread_8h.html#a425c1da89e5866d87fc20a624da7cbec">THREAD_MAX</a>; th++) {</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <a class="code" href="structthread__s.html">thread_t</a> thread = <a class="code" href="kthread_8c.html#aea4c4ea36a124f36c5a513e838d95419">ThreadTab</a>[th];</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="keywordflow">if</span> (thread) {</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<a class="code" href="kthread_8c.html#a798e4073d613ca5ba9618e1b3253df14">Y</a><span class="stringliteral">&quot;----------------------------------------------------------------------- &quot;</span>);</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<a class="code" href="kthread_8c.html#af316c33cc298530f245e8b55330e86b5">D</a><span class="stringliteral">&quot;\n&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#ad1ed1d821f595f5a7c1d68f09ba36bf5">tid</a>);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;[&quot;</span><a class="code" href="kthread_8c.html#af316c33cc298530f245e8b55330e86b5">D</a><span class="stringliteral">&quot;] thread: &quot;</span><a class="code" href="kthread_8c.html#a2748566f4c443ee77aa831e63dbb5ebe">P</a>,  <a class="code" href="mips_2cpuregs_8S.html#af7e0f9f0eada9d28b46b4d1f7ae5b702">clock</a> (), thread);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;  type:      &quot;</span><a class="code" href="kthread_8c.html#af933676109efed7ab34cea71d748a517">S</a><span class="stringliteral">&quot;\t&quot;</span>, type_name[thread-&gt;<a class="code" href="structthread__s.html#a2eda0c064f0ed88103b27bf2b5a640e2">type</a>]);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;   errmsg: &quot;</span><a class="code" href="kthread_8c.html#af933676109efed7ab34cea71d748a517">S</a><span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="errno_8c.html#a752b191220a1b00e3d70f9359a660f0f">errno_mess</a>[<span class="comment">/*errno+*/</span>1]);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot; - state:     &quot;</span><a class="code" href="kthread_8c.html#af933676109efed7ab34cea71d748a517">S</a><span class="stringliteral">&quot;\t&quot;</span>, state_name[thread-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a>]);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;   wait.next: &quot;</span>P<span class="stringliteral">&quot;\t&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">wait</a>.<a class="code" href="structlist__s.html#a3fe402fa883820f9823c1e47246f9880">next</a>);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;   wait.prev: &quot;</span>P<span class="stringliteral">&quot;\n&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">wait</a>.<a class="code" href="structlist__s.html#af220645f4ec4f64798bc6d8ea9765185">prev</a>);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot; - retval:    &quot;</span>P<span class="stringliteral">&quot;\t&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">retval</a>);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;   join:      &quot;</span>P<span class="stringliteral">&quot;\t&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">join</a>);</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;           <span class="comment">//kprintf (&quot;   errno:     &quot;P&quot;\n&quot;, errno);</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;   errno:     &quot;</span>P<span class="stringliteral">&quot;\n&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">ptls</a>-&gt;<a class="code" href="struct__tls__s.html#a2b0505d872f110754ab80cdfe94bf58e">tls_errno</a>);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot; - start:     &quot;</span>P<span class="stringliteral">&quot;\t&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a63551d8e6d21a7370c5b3652cea282fc">start</a>);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;   function:  &quot;</span>P<span class="stringliteral">&quot;\t&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a9a97385576dda275389e95ef13168cfc">fun</a>);</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot;   arg:       &quot;</span>P<span class="stringliteral">&quot;\n&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a5cdab21069c6c184a86d024a0aa238aa">arg</a>);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot; - ustack_b:  &quot;</span>P<span class="stringliteral">&quot; (&quot;</span>P<span class="stringliteral">&quot;)\t&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a8d51270c2f7572479276f7629940c3ea">ustack_b</a>, *(<span class="keywordtype">int</span>*)thread-&gt;<a class="code" href="structthread__s.html#a8d51270c2f7572479276f7629940c3ea">ustack_b</a>);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (  <span class="stringliteral">&quot; ustack_e:  &quot;</span>P<span class="stringliteral">&quot; (&quot;</span>P<span class="stringliteral">&quot;)\n&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a021e8a50ddb4a5978f18d6babfc4ea6e">ustack_e</a>, *(<span class="keywordtype">int</span>*)thread-&gt;<a class="code" href="structthread__s.html#a021e8a50ddb4a5978f18d6babfc4ea6e">ustack_e</a>);</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<span class="stringliteral">&quot; - kstack_b:  &quot;</span>P<span class="stringliteral">&quot; (&quot;</span>P<span class="stringliteral">&quot;)\t&quot;</span>, thread-&gt;<a class="code" href="structthread__s.html#a6885e765fcfe5d2ad0e5a07c2df3ee69">kstack_b</a>, *(<span class="keywordtype">int</span>*)thread-&gt;<a class="code" href="structthread__s.html#a6885e765fcfe5d2ad0e5a07c2df3ee69">kstack_b</a>);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;           <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (  <span class="stringliteral">&quot; kstack_e:  &quot;</span>P<span class="stringliteral">&quot; (&quot;</span>P<span class="stringliteral">&quot;)\n&quot;</span>, &amp;thread-&gt;<a class="code" href="structthread__s.html#a1159b3f03199aed705bf099f2eb33a92">kstack</a>, thread-&gt;<a class="code" href="structthread__s.html#a1159b3f03199aed705bf099f2eb33a92">kstack</a>[0]);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">           kprintf (&quot; - context:&quot;);</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">           kprintf (&quot;   S0: &quot;P,          thread-&gt;context[TH_CONTEXT_S0]);</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">           kprintf (&quot;   S1: &quot;P,          thread-&gt;context[TH_CONTEXT_S1]);</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment">           kprintf (&quot;   S2: &quot;P,          thread-&gt;context[TH_CONTEXT_S2]);</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">           kprintf (&quot;   S3: &quot;P&quot;\n\t   &quot;, thread-&gt;context[TH_CONTEXT_S3]);</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">           kprintf (&quot;   S4: &quot;P,          thread-&gt;context[TH_CONTEXT_S4]);</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">           kprintf (&quot;   S5: &quot;P,          thread-&gt;context[TH_CONTEXT_S5]);</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">           kprintf (&quot;   S6: &quot;P,          thread-&gt;context[TH_CONTEXT_S6]);</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">           kprintf (&quot;   S7: &quot;P&quot;\n\t   &quot;, thread-&gt;context[TH_CONTEXT_S7]);</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">           kprintf (&quot;   S8: &quot;P,          thread-&gt;context[TH_CONTEXT_S8]);</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="comment">           kprintf (&quot;   SR: &quot;P,          thread-&gt;context[TH_CONTEXT_SR]);</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="comment">           kprintf (&quot;   RA: &quot;P,          thread-&gt;context[TH_CONTEXT_RA]);</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">           kprintf (&quot;   SP: &quot;P&quot;\n&quot;,      thread-&gt;context[TH_CONTEXT_SP]);</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        }</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    }</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <a class="code" href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a> (<a class="code" href="kthread_8c.html#a798e4073d613ca5ba9618e1b3253df14">Y</a><span class="stringliteral">&quot;------------------------ END DUMP ALL THREADS -------------------------\n&quot;</span>);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;}</div>
<div class="ttc" id="kthread_8h_html_ad90e71a21f2353f675f63fee7aff63a7"><div class="ttname"><a href="kthread_8h.html#ad90e71a21f2353f675f63fee7aff63a7">TH_TYPE_KERNEL</a></div><div class="ttdeci">#define TH_TYPE_KERNEL</div><div class="ttdef"><b>Definition:</b> kthread.h:32</div></div>
<div class="ttc" id="mips_2cpuregs_8S_html_af7e0f9f0eada9d28b46b4d1f7ae5b702"><div class="ttname"><a href="mips_2cpuregs_8S.html#af7e0f9f0eada9d28b46b4d1f7ae5b702">clock</a></div><div class="ttdeci">globl clock clock</div><div class="ttdef"><b>Definition:</b> cpuregs.S:20</div></div>
<div class="ttc" id="structthread__s_html_a7ad218d5b7c4b6bc9c4602e6b1a89815"><div class="ttname"><a href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">thread_s::ptls</a></div><div class="ttdeci">_tls_t * ptls</div><div class="ttdoc">ptr to current thread local storage (see common/usermem.h) </div><div class="ttdef"><b>Definition:</b> kthread.c:41</div></div>
<div class="ttc" id="structthread__s_html_a021e8a50ddb4a5978f18d6babfc4ea6e"><div class="ttname"><a href="structthread__s.html#a021e8a50ddb4a5978f18d6babfc4ea6e">thread_s::ustack_e</a></div><div class="ttdeci">int ustack_e</div><div class="ttdoc">user stack end (thus the lowest addr) </div><div class="ttdef"><b>Definition:</b> kthread.c:36</div></div>
<div class="ttc" id="kthread_8c_html_af316c33cc298530f245e8b55330e86b5"><div class="ttname"><a href="kthread_8c.html#af316c33cc298530f245e8b55330e86b5">D</a></div><div class="ttdeci">#define D</div><div class="ttdef"><b>Definition:</b> kthread.c:174</div></div>
<div class="ttc" id="kthread_8h_html_a55287315008b2fea47936dc065bbabb7"><div class="ttname"><a href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a></div><div class="ttdeci">#define TH_STATE_ZOMBIE</div><div class="ttdef"><b>Definition:</b> kthread.h:44</div></div>
<div class="ttc" id="structthread__s_html_a5cdab21069c6c184a86d024a0aa238aa"><div class="ttname"><a href="structthread__s.html#a5cdab21069c6c184a86d024a0aa238aa">thread_s::arg</a></div><div class="ttdeci">int arg</div><div class="ttdoc">thread argument (cast to int) </div><div class="ttdef"><b>Definition:</b> kthread.c:46</div></div>
<div class="ttc" id="structthread__s_html_a2eda0c064f0ed88103b27bf2b5a640e2"><div class="ttname"><a href="structthread__s.html#a2eda0c064f0ed88103b27bf2b5a640e2">thread_s::type</a></div><div class="ttdeci">int type</div><div class="ttdoc">two types : 0 user, 1 kernel </div><div class="ttdef"><b>Definition:</b> kthread.c:37</div></div>
<div class="ttc" id="structthread__s_html_aeefa131a48c8c3c45e6c3c0819f21cd0"><div class="ttname"><a href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">thread_s::retval</a></div><div class="ttdeci">void * retval</div><div class="ttdoc">return value </div><div class="ttdef"><b>Definition:</b> kthread.c:42</div></div>
<div class="ttc" id="kthread_8c_html_a649b8f01fd6c0f47ff3cbddaeba63bfb"><div class="ttname"><a href="kthread_8c.html#a649b8f01fd6c0f47ff3cbddaeba63bfb">W</a></div><div class="ttdeci">#define W</div><div class="ttdef"><b>Definition:</b> kthread.c:168</div></div>
<div class="ttc" id="errno_8c_html_a752b191220a1b00e3d70f9359a660f0f"><div class="ttname"><a href="errno_8c.html#a752b191220a1b00e3d70f9359a660f0f">errno_mess</a></div><div class="ttdeci">char * errno_mess[]</div><div class="ttdoc">errno is a thread local variable, that means it is like a global variable (thus accessible anywhere) ...</div><div class="ttdef"><b>Definition:</b> errno.c:18</div></div>
<div class="ttc" id="kthread_8c_html_ae48ff9d5d8665f90c44ae6ad4acb5b6d"><div class="ttname"><a href="kthread_8c.html#ae48ff9d5d8665f90c44ae6ad4acb5b6d">ThreadCurrentIdx</a></div><div class="ttdeci">static int ThreadCurrentIdx</div><div class="ttdef"><b>Definition:</b> kthread.c:54</div></div>
<div class="ttc" id="structlist__s_html_af220645f4ec4f64798bc6d8ea9765185"><div class="ttname"><a href="structlist__s.html#af220645f4ec4f64798bc6d8ea9765185">list_s::prev</a></div><div class="ttdeci">struct list_s * prev</div><div class="ttdoc">backward </div><div class="ttdef"><b>Definition:</b> list.h:83</div></div>
<div class="ttc" id="structlist__s_html_a3fe402fa883820f9823c1e47246f9880"><div class="ttname"><a href="structlist__s.html#a3fe402fa883820f9823c1e47246f9880">list_s::next</a></div><div class="ttdeci">struct list_s * next</div><div class="ttdoc">toward another same type struct in a root or a item list </div><div class="ttdef"><b>Definition:</b> list.h:82</div></div>
<div class="ttc" id="structthread__s_html_a6885e765fcfe5d2ad0e5a07c2df3ee69"><div class="ttname"><a href="structthread__s.html#a6885e765fcfe5d2ad0e5a07c2df3ee69">thread_s::kstack_b</a></div><div class="ttdeci">int kstack_b</div><div class="ttdoc">kernel stack beginning (the highest addr, outside the stack) </div><div class="ttdef"><b>Definition:</b> kthread.c:34</div></div>
<div class="ttc" id="structthread__s_html_a1159b3f03199aed705bf099f2eb33a92"><div class="ttname"><a href="structthread__s.html#a1159b3f03199aed705bf099f2eb33a92">thread_s::kstack</a></div><div class="ttdeci">int kstack[1]</div><div class="ttdoc">lowest address of kernel stack of thread (with MAGIC_STACK) </div><div class="ttdef"><b>Definition:</b> kthread.c:50</div></div>
<div class="ttc" id="kthread_8h_html_aeae3234bde1a15d5c671a41286949bc5"><div class="ttname"><a href="kthread_8h.html#aeae3234bde1a15d5c671a41286949bc5">TH_STATE_DEAD</a></div><div class="ttdeci">#define TH_STATE_DEAD</div><div class="ttdef"><b>Definition:</b> kthread.h:42</div></div>
<div class="ttc" id="kthread_8c_html_a2748566f4c443ee77aa831e63dbb5ebe"><div class="ttname"><a href="kthread_8c.html#a2748566f4c443ee77aa831e63dbb5ebe">P</a></div><div class="ttdeci">#define P</div><div class="ttdef"><b>Definition:</b> kthread.c:173</div></div>
<div class="ttc" id="kthread_8h_html_a425c1da89e5866d87fc20a624da7cbec"><div class="ttname"><a href="kthread_8h.html#a425c1da89e5866d87fc20a624da7cbec">THREAD_MAX</a></div><div class="ttdeci">#define THREAD_MAX</div><div class="ttdef"><b>Definition:</b> kthread.h:23</div></div>
<div class="ttc" id="klibc_8c_html_ac4ae3bb8e59735d2b772e77186b52228"><div class="ttname"><a href="klibc_8c.html#ac4ae3bb8e59735d2b772e77186b52228">kprintf</a></div><div class="ttdeci">int kprintf(char *fmt,...)</div><div class="ttdoc">print a formated string to the TTY0 this a simplified version which handles only: c...</div><div class="ttdef"><b>Definition:</b> klibc.c:37</div></div>
<div class="ttc" id="structthread__s_html_a9a97385576dda275389e95ef13168cfc"><div class="ttname"><a href="structthread__s.html#a9a97385576dda275389e95ef13168cfc">thread_s::fun</a></div><div class="ttdeci">int fun</div><div class="ttdoc">pointer to the thread function (cast to int) </div><div class="ttdef"><b>Definition:</b> kthread.c:45</div></div>
<div class="ttc" id="kthread_8c_html_af933676109efed7ab34cea71d748a517"><div class="ttname"><a href="kthread_8c.html#af933676109efed7ab34cea71d748a517">S</a></div><div class="ttdeci">#define S</div><div class="ttdef"><b>Definition:</b> kthread.c:172</div></div>
<div class="ttc" id="kthread_8c_html_a1da5431310f6068f6d1113c402eff5f8"><div class="ttname"><a href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a></div><div class="ttdeci">thread_t ThreadCurrent</div><div class="ttdoc">Pointeur to the current RUNNING thread (only one per processor) TODO should be an array if there are ...</div><div class="ttdef"><b>Definition:</b> kthread.c:55</div></div>
<div class="ttc" id="struct__tls__s_html_a2b0505d872f110754ab80cdfe94bf58e"><div class="ttname"><a href="struct__tls__s.html#a2b0505d872f110754ab80cdfe94bf58e">_tls_s::tls_errno</a></div><div class="ttdeci">int tls_errno</div><div class="ttdoc">syscall error number </div><div class="ttdef"><b>Definition:</b> usermem.h:71</div></div>
<div class="ttc" id="structthread__s_html_a8d51270c2f7572479276f7629940c3ea"><div class="ttname"><a href="structthread__s.html#a8d51270c2f7572479276f7629940c3ea">thread_s::ustack_b</a></div><div class="ttdeci">int ustack_b</div><div class="ttdoc">user stack beginning (the highest address, outside the stack) </div><div class="ttdef"><b>Definition:</b> kthread.c:35</div></div>
<div class="ttc" id="kthread_8c_html_aea4c4ea36a124f36c5a513e838d95419"><div class="ttname"><a href="kthread_8c.html#aea4c4ea36a124f36c5a513e838d95419">ThreadTab</a></div><div class="ttdeci">static thread_t ThreadTab[THREAD_MAX]</div><div class="ttdef"><b>Definition:</b> kthread.c:53</div></div>
<div class="ttc" id="structthread__s_html_a291769866cccb5d37937ef14cedc38bf"><div class="ttname"><a href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">thread_s::wait</a></div><div class="ttdeci">list_t wait</div><div class="ttdoc">list element to chain threads waiting for the same resource </div><div class="ttdef"><b>Definition:</b> kthread.c:38</div></div>
<div class="ttc" id="kthread_8c_html_a798e4073d613ca5ba9618e1b3253df14"><div class="ttname"><a href="kthread_8c.html#a798e4073d613ca5ba9618e1b3253df14">Y</a></div><div class="ttdeci">#define Y</div><div class="ttdoc">Dump all the threads that are in the scheduler. </div><div class="ttdef"><b>Definition:</b> kthread.c:167</div></div>
<div class="ttc" id="structthread__s_html_ad1ed1d821f595f5a7c1d68f09ba36bf5"><div class="ttname"><a href="structthread__s.html#ad1ed1d821f595f5a7c1d68f09ba36bf5">thread_s::tid</a></div><div class="ttdeci">int tid</div><div class="ttdoc">thread identifer MUST BE PLACED JUST BEFORE CONTEXT (trace) </div><div class="ttdef"><b>Definition:</b> kthread.c:47</div></div>
<div class="ttc" id="kthread_8h_html_a83c4c9d919043cd3b5bac98b7250d506"><div class="ttname"><a href="kthread_8h.html#a83c4c9d919043cd3b5bac98b7250d506">TH_STATE_RUNNING</a></div><div class="ttdeci">#define TH_STATE_RUNNING</div><div class="ttdef"><b>Definition:</b> kthread.h:40</div></div>
<div class="ttc" id="structthread__s_html_a84fafe08d8ef25fc4b5a8fb1e833619c"><div class="ttname"><a href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">thread_s::join</a></div><div class="ttdeci">thread_t join</div><div class="ttdoc">expected thread in case of thread_join() </div><div class="ttdef"><b>Definition:</b> kthread.c:43</div></div>
<div class="ttc" id="structthread__s_html"><div class="ttname"><a href="structthread__s.html">thread_s</a></div><div class="ttdoc">thread_s structure which contains all we need to define a thread the size of thread_s struct is a mul...</div><div class="ttdef"><b>Definition:</b> kthread.c:33</div></div>
<div class="ttc" id="kthread_8h_html_a1887e40b17ecfda05b4a398375d527fb"><div class="ttname"><a href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a></div><div class="ttdeci">#define TH_STATE_READY</div><div class="ttdef"><b>Definition:</b> kthread.h:41</div></div>
<div class="ttc" id="structthread__s_html_a63551d8e6d21a7370c5b3652cea282fc"><div class="ttname"><a href="structthread__s.html#a63551d8e6d21a7370c5b3652cea282fc">thread_s::start</a></div><div class="ttdeci">int start</div><div class="ttdoc">pointer to the function which calls fun(arg) </div><div class="ttdef"><b>Definition:</b> kthread.c:44</div></div>
<div class="ttc" id="structthread__s_html_ab3fce89938b5156047553299f71a1370"><div class="ttname"><a href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a></div><div class="ttdeci">int state</div><div class="ttdoc">thread state from the scheduler point of view </div><div class="ttdef"><b>Definition:</b> kthread.c:40</div></div>
<div class="ttc" id="kthread_8h_html_ab47e8c012560fa0368dfd3f6e45e07b5"><div class="ttname"><a href="kthread_8h.html#ab47e8c012560fa0368dfd3f6e45e07b5">TH_TYPE_USER</a></div><div class="ttdeci">#define TH_TYPE_USER</div><div class="ttdef"><b>Definition:</b> kthread.h:31</div></div>
<div class="ttc" id="kthread_8h_html_a75c1c2f7da0a338d818a2950b582b74a"><div class="ttname"><a href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a></div><div class="ttdeci">#define TH_STATE_WAIT</div><div class="ttdef"><b>Definition:</b> kthread.h:43</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a3ecc03b8319efabea835c1205c8fff4d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void thread_addlast </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="list_8h.html#ad3b2684139c847cd572cb7b9679ce227">list_t</a> *&#160;</td>
          <td class="paramname"><em>root</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a>&#160;</td>
          <td class="paramname"><em>thread</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>References <a class="el" href="list_8h.html#a116cfa18214dd2f855cff842bb14ca8f">list_addlast()</a>, and <a class="el" href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">thread_s::wait</a>.</p>

<p>Referenced by <a class="el" href="ksynchro_8h.html#aea6f07b8093fabd5e248aae8b7e64abb">thread_barrier_wait()</a>, and <a class="el" href="ksynchro_8h.html#aa5d516e2832e4c1f4d222a79fabe76a2">thread_mutex_lock()</a>.</p>
<div class="fragment"><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;{</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <a class="code" href="list_8h.html#a116cfa18214dd2f855cff842bb14ca8f">list_addlast</a> (root, &amp;thread-&gt;<a class="code" href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">wait</a>);</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;}</div>
<div class="ttc" id="structthread__s_html_a291769866cccb5d37937ef14cedc38bf"><div class="ttname"><a href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">thread_s::wait</a></div><div class="ttdeci">list_t wait</div><div class="ttdoc">list element to chain threads waiting for the same resource </div><div class="ttdef"><b>Definition:</b> kthread.c:38</div></div>
<div class="ttc" id="list_8h_html_a116cfa18214dd2f855cff842bb14ca8f"><div class="ttname"><a href="list_8h.html#a116cfa18214dd2f855cff842bb14ca8f">list_addlast</a></div><div class="ttdeci">static void list_addlast(list_t *root, list_t *added_item)</div><div class="ttdoc">Add a new added item before the current item which is root the most often. then the added item is pla...</div><div class="ttdef"><b>Definition:</b> list.h:221</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a227d30321d9dddb518fe5d116aa7d90b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int thread_create </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> *&#160;</td>
          <td class="paramname"><em>thread</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fun</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>arg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>start</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calls by the kernel in order to implement the user <a class="el" href="kthread_8c.html#a2525e99272c4db4198bcea374d717620" title="Calls by the kernel in order to implement the user thread_create() syscall This function has the same...">thread_create()</a> syscall This function has the same arguments as <a class="el" href="kthread_8c.html#a2525e99272c4db4198bcea374d717620" title="Calls by the kernel in order to implement the user thread_create() syscall This function has the same...">thread_create()</a>, plus one which is the pointer to the function that will start the thread, there are two of those: one for the main thread (nammed _start defined in <a class="el" href="crt0_8c.html">crt0.c</a>) and one for the standard thread (nammed thread_start defined in thread.c). These two functions do not have the same type but it does not matter because we are converting to int. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">thread</td><td>pointer to the thread structure </td></tr>
    <tr><td class="paramname">fun</td><td>pointer to the function of the thread (cast to int) </td></tr>
    <tr><td class="paramname">arg</td><td>the argument given to fun() (cast to int) </td></tr>
    <tr><td class="paramname">start</td><td>pointer to the function which will start the thread (cast to int) This function is defined in the same address space as the thread. If it is a user thread the start function is in user space </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, an error code on fealure </dd></dl>

<p>References <a class="el" href="structthread__s.html#a5cdab21069c6c184a86d024a0aa238aa">thread_s::arg</a>, <a class="el" href="structthread__s.html#a668771e7e3444ba13544b50e1ff312a6">thread_s::context</a>, <a class="el" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3a4bde0de54c0b708a605ed5095959c14e">EAGAIN</a>, <a class="el" href="structthread__s.html#a9a97385576dda275389e95ef13168cfc">thread_s::fun</a>, <a class="el" href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">thread_s::join</a>, <a class="el" href="kmemory_8c.html#a5f52d7c56b7d67dc2f96b2e93dfdc7be">kmalloc()</a>, <a class="el" href="structthread__s.html#ae4614b780e1a47305c562869870d6e41">thread_s::krandseed</a>, <a class="el" href="structthread__s.html#a1159b3f03199aed705bf099f2eb33a92">thread_s::kstack</a>, <a class="el" href="structthread__s.html#a6885e765fcfe5d2ad0e5a07c2df3ee69">thread_s::kstack_b</a>, <a class="el" href="list_8h.html#a4988c174e6ecc55436d5f0e3dbbb3980">list_init()</a>, <a class="el" href="usermem_8h.html#a34ef3ea96595898f1452b49d29a1722a">MAGIC_STACK</a>, <a class="el" href="kmemory_8c.html#a2ce77af8c704a7d3f2204f94750daedb">malloc_ustack()</a>, <a class="el" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="el" href="usermem_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>, <a class="el" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">thread_s::ptls</a>, <a class="el" href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">thread_s::retval</a>, <a class="el" href="kthread_8c.html#ad094fddcf3208d43f3385ed2aa419c10">sched_insert()</a>, <a class="el" href="structthread__s.html#a63551d8e6d21a7370c5b3652cea282fc">thread_s::start</a>, <a class="el" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a>, <a class="el" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a>, <a class="el" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>, <a class="el" href="kthread_8c.html#ab6382c52388aa3e432787e2b9b4671bb">thread_bootstrap()</a>, <a class="el" href="mips_2threadc_8c.html#af63f55ab4a65c97f8effe4ff21de0b1e">thread_context_init()</a>, <a class="el" href="struct__tls__s.html#a2b0505d872f110754ab80cdfe94bf58e">_tls_s::tls_errno</a>, <a class="el" href="structthread__s.html#a8d51270c2f7572479276f7629940c3ea">thread_s::ustack_b</a>, <a class="el" href="structthread__s.html#a021e8a50ddb4a5978f18d6babfc4ea6e">thread_s::ustack_e</a>, <a class="el" href="usermem_8h.html#ad77d03e18a9477ef16ff8c4ae3c8b43d">USTACK_SIZE</a>, and <a class="el" href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">thread_s::wait</a>.</p>

<p>Referenced by <a class="el" href="kinit_8c.html#a7316311400d5b710f1b974a353b10d1c">kinit()</a>.</p>
<div class="fragment"><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;{</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <a class="code" href="structthread__s.html">thread_t</a> thread = <a class="code" href="kmemory_8c.html#a5f52d7c56b7d67dc2f96b2e93dfdc7be">kmalloc</a> (<a class="code" href="usermem_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>);                      <span class="comment">// thread is thus always aligned</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keywordflow">if</span> (thread == <a class="code" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3a4bde0de54c0b708a605ed5095959c14e">EAGAIN</a>;                          <span class="comment">// Not enough memory</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a6885e765fcfe5d2ad0e5a07c2df3ee69">kstack_b</a> = (int)thread + <a class="code" href="usermem_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a> - 4;             <span class="comment">// kstack beginning (highest addr)</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a8d51270c2f7572479276f7629940c3ea">ustack_b</a> = (int)<a class="code" href="kmemory_8c.html#a2ce77af8c704a7d3f2204f94750daedb">malloc_ustack</a>();                    <span class="comment">// stack beginning (highest address)</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a021e8a50ddb4a5978f18d6babfc4ea6e">ustack_e</a> = thread-&gt;<a class="code" href="structthread__s.html#a8d51270c2f7572479276f7629940c3ea">ustack_b</a> - <a class="code" href="usermem_8h.html#ad77d03e18a9477ef16ff8c4ae3c8b43d">USTACK_SIZE</a> + 4;      <span class="comment">// stack end (lowest addr)</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a>    = <a class="code" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>;                          <span class="comment">// it can be chosen by the scheduler</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <a class="code" href="list_8h.html#a4988c174e6ecc55436d5f0e3dbbb3980">list_init</a> (&amp;thread-&gt;<a class="code" href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">wait</a>);                                  <span class="comment">// initialize the waiting list</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">retval</a>   = <a class="code" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;                                    <span class="comment">// default return value</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">join</a>     = <a class="code" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;                                    <span class="comment">// no awaited thread</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a63551d8e6d21a7370c5b3652cea282fc">start</a>    = start;                                   <span class="comment">// start() will call fun(arg)</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a9a97385576dda275389e95ef13168cfc">fun</a>      = fun;                                     <span class="comment">// function of the thread</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a5cdab21069c6c184a86d024a0aa238aa">arg</a>      = arg;                                     <span class="comment">// argument of the thread</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">ptls</a>     = (<a class="code" href="struct__tls__s.html">_tls_t</a> *)(thread-&gt;<a class="code" href="structthread__s.html#a8d51270c2f7572479276f7629940c3ea">ustack_b</a> - <span class="keyword">sizeof</span>(<a class="code" href="struct__tls__s.html">_tls_t</a>)); <span class="comment">// pointer to the current tls</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <a class="code" href="mips_2threadc_8c.html#af63f55ab4a65c97f8effe4ff21de0b1e">thread_context_init</a>(thread-&gt;<a class="code" href="structthread__s.html#a668771e7e3444ba13544b50e1ff312a6">context</a>,                        <span class="comment">// table to store context</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                        <a class="code" href="kthread_8c.html#ab6382c52388aa3e432787e2b9b4671bb">thread_bootstrap</a>,                       <span class="comment">// thread_bootstrap() to begin</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                        thread-&gt;<a class="code" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">ptls</a>);                          <span class="comment">// stack pointer addr (below tls)</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#ae4614b780e1a47305c562869870d6e41">krandseed</a>  = 1;                                     <span class="comment">// default kernel random seed</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    *(<span class="keywordtype">int</span>*)thread-&gt;<a class="code" href="structthread__s.html#a6885e765fcfe5d2ad0e5a07c2df3ee69">kstack_b</a> = <a class="code" href="usermem_8h.html#a34ef3ea96595898f1452b49d29a1722a">MAGIC_STACK</a>;                      <span class="comment">// should not be erased</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a1159b3f03199aed705bf099f2eb33a92">kstack</a>[0] = <a class="code" href="usermem_8h.html#a34ef3ea96595898f1452b49d29a1722a">MAGIC_STACK</a>;                            <span class="comment">// (is kstack_e) should not erased</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <a class="code" href="kthread_8c.html#ad094fddcf3208d43f3385ed2aa419c10">sched_insert</a> (thread);                                      <span class="comment">// insert new thread in scheduler</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    *thread_p = thread;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">ptls</a>-&gt;<a class="code" href="struct__tls__s.html#a2b0505d872f110754ab80cdfe94bf58e">tls_errno</a> = <a class="code" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a>;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a>;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;}</div>
<div class="ttc" id="structthread__s_html_a7ad218d5b7c4b6bc9c4602e6b1a89815"><div class="ttname"><a href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">thread_s::ptls</a></div><div class="ttdeci">_tls_t * ptls</div><div class="ttdoc">ptr to current thread local storage (see common/usermem.h) </div><div class="ttdef"><b>Definition:</b> kthread.c:41</div></div>
<div class="ttc" id="structthread__s_html_a021e8a50ddb4a5978f18d6babfc4ea6e"><div class="ttname"><a href="structthread__s.html#a021e8a50ddb4a5978f18d6babfc4ea6e">thread_s::ustack_e</a></div><div class="ttdeci">int ustack_e</div><div class="ttdoc">user stack end (thus the lowest addr) </div><div class="ttdef"><b>Definition:</b> kthread.c:36</div></div>
<div class="ttc" id="kmemory_8c_html_a2ce77af8c704a7d3f2204f94750daedb"><div class="ttname"><a href="kmemory_8c.html#a2ce77af8c704a7d3f2204f94750daedb">malloc_ustack</a></div><div class="ttdeci">int * malloc_ustack(void)</div><div class="ttdoc">allocate a new user stack </div><div class="ttdef"><b>Definition:</b> kmemory.c:236</div></div>
<div class="ttc" id="structthread__s_html_a668771e7e3444ba13544b50e1ff312a6"><div class="ttname"><a href="structthread__s.html#a668771e7e3444ba13544b50e1ff312a6">thread_s::context</a></div><div class="ttdeci">int context[TH_CONTEXT_SIZE]</div><div class="ttdoc">table to store registers when thread lose the cpu </div><div class="ttdef"><b>Definition:</b> kthread.c:49</div></div>
<div class="ttc" id="structthread__s_html_a5cdab21069c6c184a86d024a0aa238aa"><div class="ttname"><a href="structthread__s.html#a5cdab21069c6c184a86d024a0aa238aa">thread_s::arg</a></div><div class="ttdeci">int arg</div><div class="ttdoc">thread argument (cast to int) </div><div class="ttdef"><b>Definition:</b> kthread.c:46</div></div>
<div class="ttc" id="kmemory_8c_html_a5f52d7c56b7d67dc2f96b2e93dfdc7be"><div class="ttname"><a href="kmemory_8c.html#a5f52d7c56b7d67dc2f96b2e93dfdc7be">kmalloc</a></div><div class="ttdeci">void * kmalloc(size_t size)</div><div class="ttdoc">allocate an object in the kernel address space </div><div class="ttdef"><b>Definition:</b> kmemory.c:105</div></div>
<div class="ttc" id="usermem_8h_html_a34ef3ea96595898f1452b49d29a1722a"><div class="ttname"><a href="usermem_8h.html#a34ef3ea96595898f1452b49d29a1722a">MAGIC_STACK</a></div><div class="ttdeci">#define MAGIC_STACK</div><div class="ttdef"><b>Definition:</b> usermem.h:21</div></div>
<div class="ttc" id="usermem_8h_html_a7d467c1d283fdfa1f2081ba1e0d01b6e"><div class="ttname"><a href="usermem_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a></div><div class="ttdeci">#define PAGE_SIZE</div><div class="ttdef"><b>Definition:</b> usermem.h:19</div></div>
<div class="ttc" id="errno_8h_html_a447416ba79b4777e7accabf3a8163cb3a4bde0de54c0b708a605ed5095959c14e"><div class="ttname"><a href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3a4bde0de54c0b708a605ed5095959c14e">EAGAIN</a></div><div class="ttdef"><b>Definition:</b> errno.h:37</div></div>
<div class="ttc" id="kthread_8c_html_ab6382c52388aa3e432787e2b9b4671bb"><div class="ttname"><a href="kthread_8c.html#ab6382c52388aa3e432787e2b9b4671bb">thread_bootstrap</a></div><div class="ttdeci">static void thread_bootstrap(void)</div><div class="ttdoc">thread_bootstrap() function is the bootstrap of the thread. It means that it is the very first functi...</div><div class="ttdef"><b>Definition:</b> kthread.c:274</div></div>
<div class="ttc" id="structthread__s_html_aeefa131a48c8c3c45e6c3c0819f21cd0"><div class="ttname"><a href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">thread_s::retval</a></div><div class="ttdeci">void * retval</div><div class="ttdoc">return value </div><div class="ttdef"><b>Definition:</b> kthread.c:42</div></div>
<div class="ttc" id="struct__tls__s_html"><div class="ttname"><a href="struct__tls__s.html">_tls_s</a></div><div class="ttdoc">thread local storage structure definition. There is one structure per thread placed at the beginning ...</div><div class="ttdef"><b>Definition:</b> usermem.h:70</div></div>
<div class="ttc" id="structthread__s_html_a6885e765fcfe5d2ad0e5a07c2df3ee69"><div class="ttname"><a href="structthread__s.html#a6885e765fcfe5d2ad0e5a07c2df3ee69">thread_s::kstack_b</a></div><div class="ttdeci">int kstack_b</div><div class="ttdoc">kernel stack beginning (the highest addr, outside the stack) </div><div class="ttdef"><b>Definition:</b> kthread.c:34</div></div>
<div class="ttc" id="structthread__s_html_ae4614b780e1a47305c562869870d6e41"><div class="ttname"><a href="structthread__s.html#ae4614b780e1a47305c562869870d6e41">thread_s::krandseed</a></div><div class="ttdeci">unsigned long long krandseed</div><div class="ttdoc">each thread has its own kernel random seed, it is thread safe </div><div class="ttdef"><b>Definition:</b> kthread.c:48</div></div>
<div class="ttc" id="list_8h_html_a4988c174e6ecc55436d5f0e3dbbb3980"><div class="ttname"><a href="list_8h.html#a4988c174e6ecc55436d5f0e3dbbb3980">list_init</a></div><div class="ttdeci">static void list_init(list_t *root)</div><div class="ttdoc">Initialize of the list root. </div><div class="ttdef"><b>Definition:</b> list.h:191</div></div>
<div class="ttc" id="errno_8h_html_a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8"><div class="ttname"><a href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a></div><div class="ttdef"><b>Definition:</b> errno.h:34</div></div>
<div class="ttc" id="structthread__s_html_a1159b3f03199aed705bf099f2eb33a92"><div class="ttname"><a href="structthread__s.html#a1159b3f03199aed705bf099f2eb33a92">thread_s::kstack</a></div><div class="ttdeci">int kstack[1]</div><div class="ttdoc">lowest address of kernel stack of thread (with MAGIC_STACK) </div><div class="ttdef"><b>Definition:</b> kthread.c:50</div></div>
<div class="ttc" id="mips_2threadc_8c_html_af63f55ab4a65c97f8effe4ff21de0b1e"><div class="ttname"><a href="mips_2threadc_8c.html#af63f55ab4a65c97f8effe4ff21de0b1e">thread_context_init</a></div><div class="ttdeci">void thread_context_init(int context[], void *bootstrap, void *stack_pointer)</div><div class="ttdoc">Initialize the thread context at the very beginning. </div><div class="ttdef"><b>Definition:</b> threadc.c:19</div></div>
<div class="ttc" id="kthread_8c_html_ad094fddcf3208d43f3385ed2aa419c10"><div class="ttname"><a href="kthread_8c.html#ad094fddcf3208d43f3385ed2aa419c10">sched_insert</a></div><div class="ttdeci">static void sched_insert(thread_t thread_new)</div><div class="ttdoc">Insert a new thread, in the scheduler The scheduler is a simple table of all the threads To insert a ...</div><div class="ttdef"><b>Definition:</b> kthread.c:97</div></div>
<div class="ttc" id="structthread__s_html_a9a97385576dda275389e95ef13168cfc"><div class="ttname"><a href="structthread__s.html#a9a97385576dda275389e95ef13168cfc">thread_s::fun</a></div><div class="ttdeci">int fun</div><div class="ttdoc">pointer to the thread function (cast to int) </div><div class="ttdef"><b>Definition:</b> kthread.c:45</div></div>
<div class="ttc" id="struct__tls__s_html_a2b0505d872f110754ab80cdfe94bf58e"><div class="ttname"><a href="struct__tls__s.html#a2b0505d872f110754ab80cdfe94bf58e">_tls_s::tls_errno</a></div><div class="ttdeci">int tls_errno</div><div class="ttdoc">syscall error number </div><div class="ttdef"><b>Definition:</b> usermem.h:71</div></div>
<div class="ttc" id="structthread__s_html_a8d51270c2f7572479276f7629940c3ea"><div class="ttname"><a href="structthread__s.html#a8d51270c2f7572479276f7629940c3ea">thread_s::ustack_b</a></div><div class="ttdeci">int ustack_b</div><div class="ttdoc">user stack beginning (the highest address, outside the stack) </div><div class="ttdef"><b>Definition:</b> kthread.c:35</div></div>
<div class="ttc" id="structthread__s_html_a291769866cccb5d37937ef14cedc38bf"><div class="ttname"><a href="structthread__s.html#a291769866cccb5d37937ef14cedc38bf">thread_s::wait</a></div><div class="ttdeci">list_t wait</div><div class="ttdoc">list element to chain threads waiting for the same resource </div><div class="ttdef"><b>Definition:</b> kthread.c:38</div></div>
<div class="ttc" id="usermem_8h_html_ad77d03e18a9477ef16ff8c4ae3c8b43d"><div class="ttname"><a href="usermem_8h.html#ad77d03e18a9477ef16ff8c4ae3c8b43d">USTACK_SIZE</a></div><div class="ttdeci">#define USTACK_SIZE</div><div class="ttdef"><b>Definition:</b> usermem.h:20</div></div>
<div class="ttc" id="structthread__s_html_a84fafe08d8ef25fc4b5a8fb1e833619c"><div class="ttname"><a href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">thread_s::join</a></div><div class="ttdeci">thread_t join</div><div class="ttdoc">expected thread in case of thread_join() </div><div class="ttdef"><b>Definition:</b> kthread.c:43</div></div>
<div class="ttc" id="structthread__s_html"><div class="ttname"><a href="structthread__s.html">thread_s</a></div><div class="ttdoc">thread_s structure which contains all we need to define a thread the size of thread_s struct is a mul...</div><div class="ttdef"><b>Definition:</b> kthread.c:33</div></div>
<div class="ttc" id="kfs_8c_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> kfs.c:24</div></div>
<div class="ttc" id="kthread_8h_html_a1887e40b17ecfda05b4a398375d527fb"><div class="ttname"><a href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a></div><div class="ttdeci">#define TH_STATE_READY</div><div class="ttdef"><b>Definition:</b> kthread.h:41</div></div>
<div class="ttc" id="structthread__s_html_a63551d8e6d21a7370c5b3652cea282fc"><div class="ttname"><a href="structthread__s.html#a63551d8e6d21a7370c5b3652cea282fc">thread_s::start</a></div><div class="ttdeci">int start</div><div class="ttdoc">pointer to the function which calls fun(arg) </div><div class="ttdef"><b>Definition:</b> kthread.c:44</div></div>
<div class="ttc" id="structthread__s_html_ab3fce89938b5156047553299f71a1370"><div class="ttname"><a href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a></div><div class="ttdeci">int state</div><div class="ttdoc">thread state from the scheduler point of view </div><div class="ttdef"><b>Definition:</b> kthread.c:40</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ac0393114fc2fb6571188e9c619042c46"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int* thread_errno </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a>&#160;</td>
          <td class="paramname"><em>thread</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>return address of errno for the thread given this function is defined here, because it needs to access at the hidden thread struct </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">thread</td><td>where errno is searched </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>an address in user space where the last syscall error is put </dd></dl>

<p>References <a class="el" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">thread_s::ptls</a>, and <a class="el" href="struct__tls__s.html#a2b0505d872f110754ab80cdfe94bf58e">_tls_s::tls_errno</a>.</p>
<div class="fragment"><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;{</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keywordflow">return</span> &amp;(thread-&gt;<a class="code" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">ptls</a>-&gt;<a class="code" href="struct__tls__s.html#a2b0505d872f110754ab80cdfe94bf58e">tls_errno</a>);</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;}</div>
<div class="ttc" id="structthread__s_html_a7ad218d5b7c4b6bc9c4602e6b1a89815"><div class="ttname"><a href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">thread_s::ptls</a></div><div class="ttdeci">_tls_t * ptls</div><div class="ttdoc">ptr to current thread local storage (see common/usermem.h) </div><div class="ttdef"><b>Definition:</b> kthread.c:41</div></div>
<div class="ttc" id="struct__tls__s_html_a2b0505d872f110754ab80cdfe94bf58e"><div class="ttname"><a href="struct__tls__s.html#a2b0505d872f110754ab80cdfe94bf58e">_tls_s::tls_errno</a></div><div class="ttdeci">int tls_errno</div><div class="ttdoc">syscall error number </div><div class="ttdef"><b>Definition:</b> usermem.h:71</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a19b16adf05364471bae2840aa564329a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void thread_exit </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>retval</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Terminates the current thread, it never returns (see details in <a class="el" href="kthread_8c.html">kthread.c</a>) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">retval</td><td>the value can be retrieved by calling the thread_join function by another thread </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>return the value retval</dd></dl>
<p><a class="el" href="kthread_8c.html#a19b16adf05364471bae2840aa564329a" title="Terminates the current thread, it never returns (see details in kthread.c) ">thread_exit()</a> is to exit the current thread. Read this comment then the thread_join's comment. E1) firstly, store the return value and tell the current thread is becoming ZOMBIE E2) If the task waiting for the end of the current thread is already known E3) &ndash; then since, this task is waiting, change it state to READY Finally, definitively yield the processor (the current thread never come back Critical section: In case of real parallelism with thread_join, we must avoid the sequence: J1 J2 E1 E2 E3 J3 because then, the thread that executes the join gets the state WAIT and won't be never notified Thus, a critical section is created using the thread structure lock of the expected thread </p>

<p>References <a class="el" href="debug__off_8h.html#ade9dd5644bb3e429458471976764c5ab">INFO</a>, <a class="el" href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">thread_s::join</a>, <a class="el" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">thread_s::lock</a>, <a class="el" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="el" href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">thread_s::retval</a>, <a class="el" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch()</a>, <a class="el" href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a>, <a class="el" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a>, <a class="el" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a>, <a class="el" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>, and <a class="el" href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a>.</p>
<div class="fragment"><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;{</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <a class="code" href="debug__off_8h.html#ade9dd5644bb3e429458471976764c5ab">INFO</a> (<span class="stringliteral">&quot;thread %p retval %p\n&quot;</span>, <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>, retval);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">retval</a> = retval;                             <span class="comment">// E1: store the return value</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> = <a class="code" href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a>;                     <span class="comment">//     tell that is the end</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <a class="code" href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a> (&amp;<a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                           <span class="comment">// avoid sequence J1 J2 E1 E2 E3 J3</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">join</a> != <a class="code" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)                            <span class="comment">// E2: if there is a thread waiting</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">join</a>-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> = <a class="code" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>;            <span class="comment">// E3: then change its state</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <a class="code" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a> (&amp;<a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                         <span class="comment">// end of critical section</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <a class="code" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch</a> ();                                            <span class="comment">// at last, definitively yield proc</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;}</div>
<div class="ttc" id="kthread_8h_html_a55287315008b2fea47936dc065bbabb7"><div class="ttname"><a href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a></div><div class="ttdeci">#define TH_STATE_ZOMBIE</div><div class="ttdef"><b>Definition:</b> kthread.h:44</div></div>
<div class="ttc" id="mips_2atomic_8S_html_a18d39a883be260c78529672999549545"><div class="ttname"><a href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a></div><div class="ttdeci">section text globl spin_lock spin_lock_delay spin_lock_delay spin_lock jr globl spin_unlock spin_unlock</div><div class="ttdef"><b>Definition:</b> atomic.S:22</div></div>
<div class="ttc" id="debug__off_8h_html_ade9dd5644bb3e429458471976764c5ab"><div class="ttname"><a href="debug__off_8h.html#ade9dd5644bb3e429458471976764c5ab">INFO</a></div><div class="ttdeci">#define INFO(fmt, arg...)</div><div class="ttdef"><b>Definition:</b> debug_off.h:28</div></div>
<div class="ttc" id="structthread__s_html_aeefa131a48c8c3c45e6c3c0819f21cd0"><div class="ttname"><a href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">thread_s::retval</a></div><div class="ttdeci">void * retval</div><div class="ttdoc">return value </div><div class="ttdef"><b>Definition:</b> kthread.c:42</div></div>
<div class="ttc" id="structthread__s_html_a483959ed6abed6c12f49643c4495a7b1"><div class="ttname"><a href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">thread_s::lock</a></div><div class="ttdeci">spinlock_t lock</div><div class="ttdoc">lock to protected structure during modification </div><div class="ttdef"><b>Definition:</b> kthread.c:39</div></div>
<div class="ttc" id="mips_2atomic_8S_html_abff7230a2ee820f538a2574ee5b3a593"><div class="ttname"><a href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a></div><div class="ttdeci">section text globl spin_lock spin_lock_delay spin_lock</div><div class="ttdef"><b>Definition:</b> atomic.S:22</div></div>
<div class="ttc" id="kthread_8c_html_a1da5431310f6068f6d1113c402eff5f8"><div class="ttname"><a href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a></div><div class="ttdeci">thread_t ThreadCurrent</div><div class="ttdoc">Pointeur to the current RUNNING thread (only one per processor) TODO should be an array if there are ...</div><div class="ttdef"><b>Definition:</b> kthread.c:55</div></div>
<div class="ttc" id="structthread__s_html_a84fafe08d8ef25fc4b5a8fb1e833619c"><div class="ttname"><a href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">thread_s::join</a></div><div class="ttdeci">thread_t join</div><div class="ttdoc">expected thread in case of thread_join() </div><div class="ttdef"><b>Definition:</b> kthread.c:43</div></div>
<div class="ttc" id="kfs_8c_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> kfs.c:24</div></div>
<div class="ttc" id="kthread_8h_html_a1887e40b17ecfda05b4a398375d527fb"><div class="ttname"><a href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a></div><div class="ttdeci">#define TH_STATE_READY</div><div class="ttdef"><b>Definition:</b> kthread.h:41</div></div>
<div class="ttc" id="structthread__s_html_ab3fce89938b5156047553299f71a1370"><div class="ttname"><a href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a></div><div class="ttdeci">int state</div><div class="ttdoc">thread state from the scheduler point of view </div><div class="ttdef"><b>Definition:</b> kthread.c:40</div></div>
<div class="ttc" id="kthread_8c_html_a79c9880ce2be11d3a2c217c383d256fb"><div class="ttname"><a href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch</a></div><div class="ttdeci">static void sched_switch(void)</div><div class="ttdoc">Change the current thread for another, it can be unchanged if it is alone. </div><div class="ttdef"><b>Definition:</b> kthread.c:150</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a79b0f0a19a09db45e1689ff011f6109b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> thread_item </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="list_8h.html#ad3b2684139c847cd572cb7b9679ce227">list_t</a> *&#160;</td>
          <td class="paramname"><em>item</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>References <a class="el" href="list_8h.html#a99f8755f2301e99adad3c8490df79052">list_item</a>.</p>

<p>Referenced by <a class="el" href="ksynchro_8h.html#aea6f07b8093fabd5e248aae8b7e64abb">thread_barrier_wait()</a>, and <a class="el" href="ksynchro_8h.html#ad515bf71cd806fc2d1a5c4143aca3988">thread_mutex_unlock()</a>.</p>
<div class="fragment"><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;{</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="list_8h.html#a99f8755f2301e99adad3c8490df79052">list_item</a> (item, <span class="keyword">struct</span> <a class="code" href="structthread__s.html">thread_s</a>, wait);</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;}</div>
<div class="ttc" id="list_8h_html_a99f8755f2301e99adad3c8490df79052"><div class="ttname"><a href="list_8h.html#a99f8755f2301e99adad3c8490df79052">list_item</a></div><div class="ttdeci">#define list_item(ITEM, TYPE, MEMBER)</div><div class="ttdoc">Macro to get the address of the container of a list item. </div><div class="ttdef"><b>Definition:</b> list.h:183</div></div>
<div class="ttc" id="structthread__s_html"><div class="ttname"><a href="structthread__s.html">thread_s</a></div><div class="ttdoc">thread_s structure which contains all we need to define a thread the size of thread_s struct is a mul...</div><div class="ttdef"><b>Definition:</b> kthread.c:33</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a9cff35af30e36a1fc0381f648ab9a976"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int thread_join </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a>&#160;</td>
          <td class="paramname"><em>thread_expected</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void **&#160;</td>
          <td class="paramname"><em>retval</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Wait for a thread termination (see details in <a class="el" href="kthread_8c.html">kthread.c</a>) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">thread</td><td>pointer to the awaited thread structure </td></tr>
    <tr><td class="paramname">retval</td><td>pointer to the return value of the awaited thread </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, an error code on fealure (not yet implemented)</dd></dl>
<p>Please, read first the <a class="el" href="kthread_8c.html#a19b16adf05364471bae2840aa564329a" title="Terminates the current thread, it never returns (see details in kthread.c) ">thread_exit()</a> comment. <a class="el" href="kthread_8c.html#a4e54fc344bbd735b027c03629927abb9" title="Wait for a thread termination (see details in kthread.c) ">thread_join()</a> is to wait another thread. J1) firstly, tell the excepted thread that the current thread is waiting for it J2) If the expected thread is still alive, J3) &ndash; then wait for it if the expected thread is already a ZOMBIE, so take its return value and change it to DEAD Critical section: see the comment of thread_exit TODO check is thread_expected is a real thread (add a MAGIC number is struct <a class="el" href="structthread__s.html" title="thread_s structure which contains all we need to define a thread the size of thread_s struct is a mul...">thread_s</a> </p>

<p>References <a class="el" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3a4e376a13d0c1557d399f473218915625">ESRCH</a>, <a class="el" href="debug__off_8h.html#ade9dd5644bb3e429458471976764c5ab">INFO</a>, <a class="el" href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">thread_s::join</a>, <a class="el" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">thread_s::lock</a>, <a class="el" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="el" href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">thread_s::retval</a>, <a class="el" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch()</a>, <a class="el" href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a>, <a class="el" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a>, <a class="el" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a>, <a class="el" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a>, <a class="el" href="kthread_8h.html#aeae3234bde1a15d5c671a41286949bc5">TH_STATE_DEAD</a>, <a class="el" href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a>, <a class="el" href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a>, and <a class="el" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>.</p>
<div class="fragment"><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;{</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <a class="code" href="debug__off_8h.html#ade9dd5644bb3e429458471976764c5ab">INFO</a> (<span class="stringliteral">&quot;thread %p expects %p\n&quot;</span>, <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>, thread_expected);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordflow">if</span> (thread_expected == <a class="code" href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3a4e376a13d0c1557d399f473218915625">ESRCH</a>;                  <span class="comment">// Error code</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    thread_expected-&gt;<a class="code" href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">join</a> = <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>;                      <span class="comment">// J1: tell ThreadCurrent is waiting</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <a class="code" href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a> (&amp;thread_expected-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                         <span class="comment">// avoid J1 J2 E1 E2 E3 J3</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordflow">if</span> (thread_expected-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> != <a class="code" href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a>) {            <span class="comment">// J2: if expected thread not ended</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> = <a class="code" href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a>;                   <span class="comment">// J3: then wait for it</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <a class="code" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a> (&amp;thread_expected-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                   <span class="comment">// end of critical section</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        <a class="code" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch</a> ();                                        <span class="comment">// yield the proc till READY</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        <a class="code" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a> (&amp;thread_expected-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                   <span class="comment">// end of critical section</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    }</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    *retval = thread_expected-&gt;<a class="code" href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">retval</a>;                          <span class="comment">// get the return value</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    thread_expected-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> = <a class="code" href="kthread_8h.html#aeae3234bde1a15d5c671a41286949bc5">TH_STATE_DEAD</a>;                     <span class="comment">// finally, the thread is DEAD</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a>;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;}</div>
<div class="ttc" id="kthread_8h_html_a55287315008b2fea47936dc065bbabb7"><div class="ttname"><a href="kthread_8h.html#a55287315008b2fea47936dc065bbabb7">TH_STATE_ZOMBIE</a></div><div class="ttdeci">#define TH_STATE_ZOMBIE</div><div class="ttdef"><b>Definition:</b> kthread.h:44</div></div>
<div class="ttc" id="mips_2atomic_8S_html_a18d39a883be260c78529672999549545"><div class="ttname"><a href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a></div><div class="ttdeci">section text globl spin_lock spin_lock_delay spin_lock_delay spin_lock jr globl spin_unlock spin_unlock</div><div class="ttdef"><b>Definition:</b> atomic.S:22</div></div>
<div class="ttc" id="debug__off_8h_html_ade9dd5644bb3e429458471976764c5ab"><div class="ttname"><a href="debug__off_8h.html#ade9dd5644bb3e429458471976764c5ab">INFO</a></div><div class="ttdeci">#define INFO(fmt, arg...)</div><div class="ttdef"><b>Definition:</b> debug_off.h:28</div></div>
<div class="ttc" id="structthread__s_html_aeefa131a48c8c3c45e6c3c0819f21cd0"><div class="ttname"><a href="structthread__s.html#aeefa131a48c8c3c45e6c3c0819f21cd0">thread_s::retval</a></div><div class="ttdeci">void * retval</div><div class="ttdoc">return value </div><div class="ttdef"><b>Definition:</b> kthread.c:42</div></div>
<div class="ttc" id="errno_8h_html_a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8"><div class="ttname"><a href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a></div><div class="ttdef"><b>Definition:</b> errno.h:34</div></div>
<div class="ttc" id="structthread__s_html_a483959ed6abed6c12f49643c4495a7b1"><div class="ttname"><a href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">thread_s::lock</a></div><div class="ttdeci">spinlock_t lock</div><div class="ttdoc">lock to protected structure during modification </div><div class="ttdef"><b>Definition:</b> kthread.c:39</div></div>
<div class="ttc" id="kthread_8h_html_aeae3234bde1a15d5c671a41286949bc5"><div class="ttname"><a href="kthread_8h.html#aeae3234bde1a15d5c671a41286949bc5">TH_STATE_DEAD</a></div><div class="ttdeci">#define TH_STATE_DEAD</div><div class="ttdef"><b>Definition:</b> kthread.h:42</div></div>
<div class="ttc" id="mips_2atomic_8S_html_abff7230a2ee820f538a2574ee5b3a593"><div class="ttname"><a href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a></div><div class="ttdeci">section text globl spin_lock spin_lock_delay spin_lock</div><div class="ttdef"><b>Definition:</b> atomic.S:22</div></div>
<div class="ttc" id="kthread_8c_html_a1da5431310f6068f6d1113c402eff5f8"><div class="ttname"><a href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a></div><div class="ttdeci">thread_t ThreadCurrent</div><div class="ttdoc">Pointeur to the current RUNNING thread (only one per processor) TODO should be an array if there are ...</div><div class="ttdef"><b>Definition:</b> kthread.c:55</div></div>
<div class="ttc" id="structthread__s_html_a84fafe08d8ef25fc4b5a8fb1e833619c"><div class="ttname"><a href="structthread__s.html#a84fafe08d8ef25fc4b5a8fb1e833619c">thread_s::join</a></div><div class="ttdeci">thread_t join</div><div class="ttdoc">expected thread in case of thread_join() </div><div class="ttdef"><b>Definition:</b> kthread.c:43</div></div>
<div class="ttc" id="kfs_8c_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="kfs_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> kfs.c:24</div></div>
<div class="ttc" id="errno_8h_html_a447416ba79b4777e7accabf3a8163cb3a4e376a13d0c1557d399f473218915625"><div class="ttname"><a href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3a4e376a13d0c1557d399f473218915625">ESRCH</a></div><div class="ttdef"><b>Definition:</b> errno.h:54</div></div>
<div class="ttc" id="structthread__s_html_ab3fce89938b5156047553299f71a1370"><div class="ttname"><a href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a></div><div class="ttdeci">int state</div><div class="ttdoc">thread state from the scheduler point of view </div><div class="ttdef"><b>Definition:</b> kthread.c:40</div></div>
<div class="ttc" id="kthread_8c_html_a79c9880ce2be11d3a2c217c383d256fb"><div class="ttname"><a href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch</a></div><div class="ttdeci">static void sched_switch(void)</div><div class="ttdoc">Change the current thread for another, it can be unchanged if it is alone. </div><div class="ttdef"><b>Definition:</b> kthread.c:150</div></div>
<div class="ttc" id="kthread_8h_html_a75c1c2f7da0a338d818a2950b582b74a"><div class="ttname"><a href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a></div><div class="ttdeci">#define TH_STATE_WAIT</div><div class="ttdef"><b>Definition:</b> kthread.h:43</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ac8ecc48f4f6134c6118c90a593b187bc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long long* thread_krandseed </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a>&#160;</td>
          <td class="paramname"><em>thread</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>return address of krandseed for the thread given this function is defined here, because it needs to access at the hidden thread struct </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">thread</td><td>where krandseed is searched </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>an address in user space where the last syscall error is put </dd></dl>

<p>References <a class="el" href="structthread__s.html#ae4614b780e1a47305c562869870d6e41">thread_s::krandseed</a>.</p>
<div class="fragment"><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;{</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keywordflow">return</span> &amp;(thread-&gt;<a class="code" href="structthread__s.html#ae4614b780e1a47305c562869870d6e41">krandseed</a>);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;}</div>
<div class="ttc" id="structthread__s_html_ae4614b780e1a47305c562869870d6e41"><div class="ttname"><a href="structthread__s.html#ae4614b780e1a47305c562869870d6e41">thread_s::krandseed</a></div><div class="ttdeci">unsigned long long krandseed</div><div class="ttdoc">each thread has its own kernel random seed, it is thread safe </div><div class="ttdef"><b>Definition:</b> kthread.c:48</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a95c63c8faef6c13da432a94800ad2acb"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void thread_main_load </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a>&#160;</td>
          <td class="paramname"><em>thread</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>load the context of the <a class="el" href="ktools_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a> thread, only used by kinit </p>
<dl class="section return"><dt>Returns</dt><dd>nothing but the thread is launched and never come back </dd></dl>

<p>References <a class="el" href="usermem_8h.html#af044184d28c9a8b78f17bd1d8e1059b4">_usermem</a>, <a class="el" href="structthread__s.html#a668771e7e3444ba13544b50e1ff312a6">thread_s::context</a>, <a class="el" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">thread_s::ptls</a>, <a class="el" href="struct__usermem__s.html#a092a5f4499ea31a3da83e6716d959626">_usermem_s::ptls</a>, and <a class="el" href="mips_2threada_8S.html#a398387f3c20a09104dea669ec8dfdab6">thread_context_load</a>.</p>

<p>Referenced by <a class="el" href="kinit_8c.html#a7316311400d5b710f1b974a353b10d1c">kinit()</a>.</p>
<div class="fragment"><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;{</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <a class="code" href="usermem_8h.html#af044184d28c9a8b78f17bd1d8e1059b4">_usermem</a>.<a class="code" href="struct__usermem__s.html#a092a5f4499ea31a3da83e6716d959626">ptls</a> = thread-&gt;<a class="code" href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">ptls</a>;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <a class="code" href="mips_2threada_8S.html#a398387f3c20a09104dea669ec8dfdab6">thread_context_load</a> (thread-&gt;<a class="code" href="structthread__s.html#a668771e7e3444ba13544b50e1ff312a6">context</a>);</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;}</div>
<div class="ttc" id="structthread__s_html_a7ad218d5b7c4b6bc9c4602e6b1a89815"><div class="ttname"><a href="structthread__s.html#a7ad218d5b7c4b6bc9c4602e6b1a89815">thread_s::ptls</a></div><div class="ttdeci">_tls_t * ptls</div><div class="ttdoc">ptr to current thread local storage (see common/usermem.h) </div><div class="ttdef"><b>Definition:</b> kthread.c:41</div></div>
<div class="ttc" id="structthread__s_html_a668771e7e3444ba13544b50e1ff312a6"><div class="ttname"><a href="structthread__s.html#a668771e7e3444ba13544b50e1ff312a6">thread_s::context</a></div><div class="ttdeci">int context[TH_CONTEXT_SIZE]</div><div class="ttdoc">table to store registers when thread lose the cpu </div><div class="ttdef"><b>Definition:</b> kthread.c:49</div></div>
<div class="ttc" id="struct__usermem__s_html_a092a5f4499ea31a3da83e6716d959626"><div class="ttname"><a href="struct__usermem__s.html#a092a5f4499ea31a3da83e6716d959626">_usermem_s::ptls</a></div><div class="ttdeci">struct _tls_s * ptls</div><div class="ttdoc">pointer to the thread local storage of the current thread </div><div class="ttdef"><b>Definition:</b> usermem.h:57</div></div>
<div class="ttc" id="usermem_8h_html_af044184d28c9a8b78f17bd1d8e1059b4"><div class="ttname"><a href="usermem_8h.html#af044184d28c9a8b78f17bd1d8e1059b4">_usermem</a></div><div class="ttdeci">_usermem_t _usermem</div></div>
<div class="ttc" id="mips_2threada_8S_html_a398387f3c20a09104dea669ec8dfdab6"><div class="ttname"><a href="mips_2threada_8S.html#a398387f3c20a09104dea669ec8dfdab6">thread_context_load</a></div><div class="ttdeci">section text globl thread_context_save TH_CONTEXT_S0 TH_CONTEXT_S1 TH_CONTEXT_S2 TH_CONTEXT_S3 TH_CONTEXT_S4 TH_CONTEXT_S5 TH_CONTEXT_S6 TH_CONTEXT_S7 TH_CONTEXT_S8 TH_CONTEXT_SR TH_CONTEXT_EPC TH_CONTEXT_RA TH_CONTEXT_SP jr globl thread_context_load thread_context_load</div><div class="ttdef"><b>Definition:</b> threada.S:22</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="acc9196e88e8db0daa5b13544cfe62996"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void thread_notify </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a>&#160;</td>
          <td class="paramname"><em>thread</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a>. In some cases, when <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> is called just before <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> has had time to put the current thread in the WAIT state (this is possible, since <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> is called by another thread running on another processor) then the current thread is already READY but <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> yields the processor anyway, so the current thread should lose the processor for a while, until the scheduler chooses it again. </p>
<p>Start to read the <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> comment to understand what is T0 and T1. T1 calls the tread_notify() function when the resource expected by T0 has occurred. When T1 enter the critical section of thread_notify, there are two possibilities 1) T0 already passed through the critical section of thread_wait and so T0 is in WAIT 2) T0 has not yet crossed the critical section of thread_wait and T0 is therefore in RUNNING yet. In both cases, we must ask T0 to notify, which is done by setting T0's state to READY </p>

<p>References <a class="el" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">thread_s::lock</a>, <a class="el" href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a>, <a class="el" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a>, <a class="el" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a>, and <a class="el" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>.</p>

<p>Referenced by <a class="el" href="ksynchro_8h.html#aea6f07b8093fabd5e248aae8b7e64abb">thread_barrier_wait()</a>, and <a class="el" href="ksynchro_8h.html#ad515bf71cd806fc2d1a5c4143aca3988">thread_mutex_unlock()</a>.</p>
<div class="fragment"><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;{</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <a class="code" href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a> (&amp;<a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                           <span class="comment">// !--! critical section</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    thread-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> = <a class="code" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>;                             <span class="comment">// (RUNNING or WAIT) to READY</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <a class="code" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a> (&amp;<a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                         <span class="comment">// !--! end of critical section</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;}</div>
<div class="ttc" id="mips_2atomic_8S_html_a18d39a883be260c78529672999549545"><div class="ttname"><a href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a></div><div class="ttdeci">section text globl spin_lock spin_lock_delay spin_lock_delay spin_lock jr globl spin_unlock spin_unlock</div><div class="ttdef"><b>Definition:</b> atomic.S:22</div></div>
<div class="ttc" id="structthread__s_html_a483959ed6abed6c12f49643c4495a7b1"><div class="ttname"><a href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">thread_s::lock</a></div><div class="ttdeci">spinlock_t lock</div><div class="ttdoc">lock to protected structure during modification </div><div class="ttdef"><b>Definition:</b> kthread.c:39</div></div>
<div class="ttc" id="mips_2atomic_8S_html_abff7230a2ee820f538a2574ee5b3a593"><div class="ttname"><a href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a></div><div class="ttdeci">section text globl spin_lock spin_lock_delay spin_lock</div><div class="ttdef"><b>Definition:</b> atomic.S:22</div></div>
<div class="ttc" id="kthread_8c_html_a1da5431310f6068f6d1113c402eff5f8"><div class="ttname"><a href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a></div><div class="ttdeci">thread_t ThreadCurrent</div><div class="ttdoc">Pointeur to the current RUNNING thread (only one per processor) TODO should be an array if there are ...</div><div class="ttdef"><b>Definition:</b> kthread.c:55</div></div>
<div class="ttc" id="kthread_8h_html_a1887e40b17ecfda05b4a398375d527fb"><div class="ttname"><a href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a></div><div class="ttdeci">#define TH_STATE_READY</div><div class="ttdef"><b>Definition:</b> kthread.h:41</div></div>
<div class="ttc" id="structthread__s_html_ab3fce89938b5156047553299f71a1370"><div class="ttname"><a href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a></div><div class="ttdeci">int state</div><div class="ttdoc">thread state from the scheduler point of view </div><div class="ttdef"><b>Definition:</b> kthread.c:40</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a4bf00d3ebfff22db494125012393cddf"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">long long thread_randseed_get </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>get the seed for the current running thread </p>
<dl class="section return"><dt>Returns</dt><dd>the current seed </dd></dl>

</div>
</div>
<a class="anchor" id="a915acd568076749f98a0878936790ca4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">long long thread_randseed_set </td>
          <td>(</td>
          <td class="paramtype">long long&#160;</td>
          <td class="paramname"><em>seed</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>set the seed for the current running thread </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">seed</td><td>the new seed </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the new seed </dd></dl>

</div>
</div>
<a class="anchor" id="a0c0fd0ef94a8688f65d53216ae6c33e7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void thread_wait </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a>. In some cases, when <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> is called just before <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> has had time to put the current thread in the WAIT state (this is possible, since <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> is called by another thread running on another processor) then the current thread is already READY but <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> yields the processor anyway, so the current thread should lose the processor for a while, until the scheduler chooses it again. </p>
<dl class="section return"><dt>Returns</dt><dd>nothing but there is a state changement</dd></dl>
<p><a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> and <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> are made to handle the WAIT state, please read both comments. Use this function to put the current thread (say T0) into a WAIT state. We need this when T0 has just tried to acquire a busy resource. We assume that T0 has already been added to the resource's waiting list, so we still need to detach T0 from its processor's availability list. The problem is that the resource may become available during the state change of T0. Suppose another thread (say T1) returns the resource and calls thread_notify(T0). T1 is necessarily running on another CPU, so there is a risk that T0 will become READY (because of the call to thread_notify(T0)) with the resource in its possession and then become WAIT (because of the call to <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a> just after). In this case, T0 will never notified again. This is the end. there are two possibilities: A [ wait then notify ] or B [ notify then wait ] A) That is the normal case. T0 is first detached from ready list, then secondly, T0 is notified and become READY B) That is a abnormal case. T0 begins to notify, because T1 gives it the resource and calls <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> then T0 becomes READY, but just after that T0 calls <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a>! Thus, <a class="el" href="kthread_8c.html#a0c0fd0ef94a8688f65d53216ae6c33e7" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_wait()</a>, called by T0, must know that <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> has already been called, it is simply possible by looking its state. If T0 is always RUNNING, then it means that <a class="el" href="kthread_8c.html#acc9196e88e8db0daa5b13544cfe62996" title="Ask the current RUNNING thread to WAIT the current thread must become READY again after the call to t...">thread_notify()</a> has not been called yet, because otherwise the state would have been READY In that case T0 has to wait, otherwise T0 is READY and we DO NOT change the state The lock is to protect the sequence [ read - test - modification ] Note that it is possible that the notify() occurs after unlocking and just before <a class="el" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb" title="Change the current thread for another, it can be unchanged if it is alone. ">sched_switch()</a>. In this case, T0 will be READY but will lose the CPU even if it owns the resource. This is unfortunate, as the resource is locked for a quantum of time, but it is not fatal. </p>

<p>References <a class="el" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">thread_s::lock</a>, <a class="el" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch()</a>, <a class="el" href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a>, <a class="el" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a>, <a class="el" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a>, <a class="el" href="kthread_8h.html#a83c4c9d919043cd3b5bac98b7250d506">TH_STATE_RUNNING</a>, and <a class="el" href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a>.</p>

<p>Referenced by <a class="el" href="ksynchro_8h.html#aea6f07b8093fabd5e248aae8b7e64abb">thread_barrier_wait()</a>, and <a class="el" href="ksynchro_8h.html#aa5d516e2832e4c1f4d222a79fabe76a2">thread_mutex_lock()</a>.</p>
<div class="fragment"><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;{</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <a class="code" href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a> (&amp;<a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                           <span class="comment">// !--! critical section</span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> == <a class="code" href="kthread_8h.html#a83c4c9d919043cd3b5bac98b7250d506">TH_STATE_RUNNING</a>)               <span class="comment">// thread_notify not happened yet</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;         <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> = <a class="code" href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a>;                  <span class="comment">// give the CPU back</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <a class="code" href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a> (&amp;<a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">lock</a>);                         <span class="comment">// !--! end of critical section</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <a class="code" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch</a> ();                                            <span class="comment">// then switch the thread</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;}</div>
<div class="ttc" id="mips_2atomic_8S_html_a18d39a883be260c78529672999549545"><div class="ttname"><a href="mips_2atomic_8S.html#a18d39a883be260c78529672999549545">spin_unlock</a></div><div class="ttdeci">section text globl spin_lock spin_lock_delay spin_lock_delay spin_lock jr globl spin_unlock spin_unlock</div><div class="ttdef"><b>Definition:</b> atomic.S:22</div></div>
<div class="ttc" id="structthread__s_html_a483959ed6abed6c12f49643c4495a7b1"><div class="ttname"><a href="structthread__s.html#a483959ed6abed6c12f49643c4495a7b1">thread_s::lock</a></div><div class="ttdeci">spinlock_t lock</div><div class="ttdoc">lock to protected structure during modification </div><div class="ttdef"><b>Definition:</b> kthread.c:39</div></div>
<div class="ttc" id="mips_2atomic_8S_html_abff7230a2ee820f538a2574ee5b3a593"><div class="ttname"><a href="mips_2atomic_8S.html#abff7230a2ee820f538a2574ee5b3a593">spin_lock</a></div><div class="ttdeci">section text globl spin_lock spin_lock_delay spin_lock</div><div class="ttdef"><b>Definition:</b> atomic.S:22</div></div>
<div class="ttc" id="kthread_8c_html_a1da5431310f6068f6d1113c402eff5f8"><div class="ttname"><a href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a></div><div class="ttdeci">thread_t ThreadCurrent</div><div class="ttdoc">Pointeur to the current RUNNING thread (only one per processor) TODO should be an array if there are ...</div><div class="ttdef"><b>Definition:</b> kthread.c:55</div></div>
<div class="ttc" id="kthread_8h_html_a83c4c9d919043cd3b5bac98b7250d506"><div class="ttname"><a href="kthread_8h.html#a83c4c9d919043cd3b5bac98b7250d506">TH_STATE_RUNNING</a></div><div class="ttdeci">#define TH_STATE_RUNNING</div><div class="ttdef"><b>Definition:</b> kthread.h:40</div></div>
<div class="ttc" id="structthread__s_html_ab3fce89938b5156047553299f71a1370"><div class="ttname"><a href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a></div><div class="ttdeci">int state</div><div class="ttdoc">thread state from the scheduler point of view </div><div class="ttdef"><b>Definition:</b> kthread.c:40</div></div>
<div class="ttc" id="kthread_8c_html_a79c9880ce2be11d3a2c217c383d256fb"><div class="ttname"><a href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch</a></div><div class="ttdeci">static void sched_switch(void)</div><div class="ttdoc">Change the current thread for another, it can be unchanged if it is alone. </div><div class="ttdef"><b>Definition:</b> kthread.c:150</div></div>
<div class="ttc" id="kthread_8h_html_a75c1c2f7da0a338d818a2950b582b74a"><div class="ttname"><a href="kthread_8h.html#a75c1c2f7da0a338d818a2950b582b74a">TH_STATE_WAIT</a></div><div class="ttdeci">#define TH_STATE_WAIT</div><div class="ttdef"><b>Definition:</b> kthread.h:43</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="affe2eebf6749bc36765d45ff48c926b1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int thread_yield </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Causes the current thread to give up the CPU in order to give it to another. </p>
<dl class="section return"><dt>Returns</dt><dd>0 in any cases</dd></dl>
<p>Use this function to yield the CPU while the thread is in a RUNNING state, which means that the thread is not waiting for any resource (as a device, mutex or anything else), so just we need to put it in a READY state and try to switch to another thread. It is not necessary to take the thread lock, since no one will change the state at this moment If thread is the only READY, it will take the CPU again. </p>

<p>References <a class="el" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch()</a>, <a class="el" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a>, <a class="el" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a>, and <a class="el" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>.</p>

<p>Referenced by <a class="el" href="ns16550_8c.html#aa0c873ae215d7bac2765f28eab606ba2">ns16550_read()</a>, <a class="el" href="almo1-mips_2soc_8c.html#aeb589179b71725cd918f71b4f23b21d2">soc_timer_init()</a>, and <a class="el" href="soclib-tty_8c.html#a4431857eb67ef282186a88fda6dcd89e">soclib_tty_read()</a>.</p>
<div class="fragment"><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;{</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <a class="code" href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a>-&gt;<a class="code" href="structthread__s.html#ab3fce89938b5156047553299f71a1370">state</a> = <a class="code" href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a>;                      <span class="comment">// yield the CPU but always READY</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <a class="code" href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch</a> ();                                            <span class="comment">// Try to change thread</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a>;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;}</div>
<div class="ttc" id="errno_8h_html_a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8"><div class="ttname"><a href="errno_8h.html#a447416ba79b4777e7accabf3a8163cb3ac7f69f7c9e5aea9b8f54cf02870e2bf8">SUCCESS</a></div><div class="ttdef"><b>Definition:</b> errno.h:34</div></div>
<div class="ttc" id="kthread_8c_html_a1da5431310f6068f6d1113c402eff5f8"><div class="ttname"><a href="kthread_8c.html#a1da5431310f6068f6d1113c402eff5f8">ThreadCurrent</a></div><div class="ttdeci">thread_t ThreadCurrent</div><div class="ttdoc">Pointeur to the current RUNNING thread (only one per processor) TODO should be an array if there are ...</div><div class="ttdef"><b>Definition:</b> kthread.c:55</div></div>
<div class="ttc" id="kthread_8h_html_a1887e40b17ecfda05b4a398375d527fb"><div class="ttname"><a href="kthread_8h.html#a1887e40b17ecfda05b4a398375d527fb">TH_STATE_READY</a></div><div class="ttdeci">#define TH_STATE_READY</div><div class="ttdef"><b>Definition:</b> kthread.h:41</div></div>
<div class="ttc" id="structthread__s_html_ab3fce89938b5156047553299f71a1370"><div class="ttname"><a href="structthread__s.html#ab3fce89938b5156047553299f71a1370">thread_s::state</a></div><div class="ttdeci">int state</div><div class="ttdoc">thread state from the scheduler point of view </div><div class="ttdef"><b>Definition:</b> kthread.c:40</div></div>
<div class="ttc" id="kthread_8c_html_a79c9880ce2be11d3a2c217c383d256fb"><div class="ttname"><a href="kthread_8c.html#a79c9880ce2be11d3a2c217c383d256fb">sched_switch</a></div><div class="ttdeci">static void sched_switch(void)</div><div class="ttdoc">Change the current thread for another, it can be unchanged if it is alone. </div><div class="ttdef"><b>Definition:</b> kthread.c:150</div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="a1da5431310f6068f6d1113c402eff5f8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="kthread_8h.html#a755fbb4a945decf90cb1c0eb5fd16878">thread_t</a> ThreadCurrent</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Pointeur to the current RUNNING thread (only one per processor) TODO should be an array if there are several processor TODO add a variable to count the number of threads and check it when tbread_create. </p>

<p>Referenced by <a class="el" href="ksynchro_8h.html#aea6f07b8093fabd5e248aae8b7e64abb">thread_barrier_wait()</a>, <a class="el" href="kthread_8c.html#ab6382c52388aa3e432787e2b9b4671bb">thread_bootstrap()</a>, <a class="el" href="kthread_8h.html#a9cff35af30e36a1fc0381f648ab9a976">thread_join()</a>, <a class="el" href="ksynchro_8h.html#af85d5d2e4a36615955a7cfbae10eeec5">thread_mutex_destroy()</a>, <a class="el" href="ksynchro_8h.html#aa5d516e2832e4c1f4d222a79fabe76a2">thread_mutex_lock()</a>, and <a class="el" href="ksynchro_8h.html#ad515bf71cd806fc2d1a5c4143aca3988">thread_mutex_unlock()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
